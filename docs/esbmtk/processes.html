<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.0.0"/>
    <title>esbmtk.processes API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(:first-of-type){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section:first-of-type details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;esbmtk</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#Process">Process</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Process.__init__">Process</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.show_figure">show_figure</a>
                        </li>
                        <li>
                                <a class="class" href="#Process.Source">Process.Source</a>
                        </li>
                        <li>
                                <a class="class" href="#Process.Reservoir">Process.Reservoir</a>
                        </li>
                        <li>
                                <a class="class" href="#Process.Sink">Process.Sink</a>
                        </li>
                        <li>
                                <a class="class" href="#Process.Flux">Process.Flux</a>
                        </li>
                        <li>
                                <a class="class" href="#Process.Model">Process.Model</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GenericFunction">GenericFunction</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GenericFunction.__init__">GenericFunction</a>
                        </li>
                        <li>
                                <a class="function" href="#GenericFunction.get_process_args">get_process_args</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AddSignal">AddSignal</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AddSignal.__init__">AddSignal</a>
                        </li>
                        <li>
                                <a class="function" href="#AddSignal.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#AddSignal.p_add_signal_fi">p_add_signal_fi</a>
                        </li>
                        <li>
                                <a class="function" href="#AddSignal.p_add_signal_fa">p_add_signal_fa</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SaveFluxData">SaveFluxData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SaveFluxData.__init__">SaveFluxData</a>
                        </li>
                        <li>
                                <a class="function" href="#SaveFluxData.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#SaveFluxData.p_save_flux">p_save_flux</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ScaleFlux">ScaleFlux</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ScaleFlux.__init__">ScaleFlux</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleFlux.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleFlux.p_scale_flux_r">p_scale_flux_r</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleFlux.p_scale_flux_fd">p_scale_flux_fd</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Fractionation">Fractionation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Fractionation.__init__">Fractionation</a>
                        </li>
                        <li>
                                <a class="function" href="#Fractionation.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#Fractionation.p_fractionation">p_fractionation</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#RateConstant">RateConstant</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RateConstant.__init__">RateConstant</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#weathering">weathering</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#weathering.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#weathering.p_weathering">p_weathering</a>
                        </li>
                        <li>
                                <a class="function" href="#weathering.p_weathering_fd">p_weathering_fd</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MultiplySignal">MultiplySignal</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MultiplySignal.__init__">MultiplySignal</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiplySignal.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiplySignal.p_multiply_signal_fi">p_multiply_signal_fi</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiplySignal.p_multiply_signal_fa">p_multiply_signal_fa</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#VarDeltaOut">VarDeltaOut</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#VarDeltaOut.__init__">VarDeltaOut</a>
                        </li>
                        <li>
                                <a class="function" href="#VarDeltaOut.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#VarDeltaOut.p_vardeltaout">p_vardeltaout</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ScaleRelativeToMass">ScaleRelativeToMass</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ScaleRelativeToMass.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleRelativeToMass.p_scale_relative_to_mass">p_scale_relative_to_mass</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GasExchange">GasExchange</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GasExchange.ode">ode</a>
                        </li>
                        <li>
                                <a class="function" href="#GasExchange.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#GasExchange.p_gas_exchange">p_gas_exchange</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ScaleRelativeToConcentration">ScaleRelativeToConcentration</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ScaleRelativeToConcentration.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleRelativeToConcentration.p_scale_relative_to_concentration">p_scale_relative_to_concentration</a>
                        </li>
                        <li>
                                <a class="function" href="#ScaleRelativeToConcentration.p_scale_relative_to_concentration_fd">p_scale_relative_to_concentration_fd</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a><wbr>.processes    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>
<span class="kn">from</span> <span class="nn">.esbmtk_base</span> <span class="kn">import</span> <span class="n">esbmtkBase</span>  <span class="c1"># , Reservoir, Flux, Source, Sink</span>
<span class="kn">from</span> <span class="nn">.solver</span> <span class="kn">import</span> <span class="n">get_l_mass</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="k">as</span> <span class="nn">col</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># from .connections import ConnnectionGroup</span>

<span class="c1"># if tp.TYPE_CHECKING:</span>
<span class="c1">#     from .esbmtk import Source, Reservoir, Sink, Flux, Model</span>
<span class="c1">#     from .extended_classes import GasReservoir, ReservoirGroup</span>
<span class="c1">#     from .connections import ConnectionGroup</span>


<span class="k">class</span> <span class="nc">Process</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class defines template for proycess which acts on one or more</span>
<span class="sd">    reservoir flux combinations. To use it, you need to create an</span>
<span class="sd">    subclass which defines the actual process implementation in their</span>
<span class="sd">    call method. See &#39;PassiveFlux as example&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Model</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>  <span class="c1"># default error messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number or quantity&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do some housekeeping for the process class&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Flux</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span>

        <span class="c1"># self.rm0: float = self.r.m[0]  # the initial reservoir mass</span>

        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Flux</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;delta&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__misc_init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__delayed_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize stuff which is only known after the entire model has been defined.</span>
<span class="sd">        This will be executed just before running the model. You need to add the following</span>
<span class="sd">        two lines somewhere in the init procedure (preferably by redefining __misc_init__)</span>
<span class="sd">        and redefine __delayed_init__ to actually execute any code below</span>

<span class="sd">        # this process requires delayed init</span>
<span class="sd">        self.mo.lto.append(self)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is just a place holder method which will be called by default</span>
<span class="sd">        in __post_init__() This can be overloaded to add additional</span>
<span class="sd">        code to the init procedure without the need to redefine</span>
<span class="sd">        init. This useful for processes which only define a call method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__defaultnames__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set up the default names and dicts for the process class. This</span>
<span class="sd">        allows us to extend these values without modifying the entire init process</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
            <span class="n">Sink</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Flux</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">Model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of known keywords and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;lt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">ConnectionGroup</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Flux</span><span class="p">,</span>
                    <span class="n">Model</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservoir</span><span class="p">,</span> <span class="n">flux</span><span class="p">:</span> <span class="n">Flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register the flux/reservoir pair we are acting upon, and register</span>
<span class="sd">        the process with the reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span>

        <span class="c1"># register the reservoir flux combination we are acting on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span> <span class="o">=</span> <span class="n">reservoir</span>
        <span class="c1"># add this process to the list of processes acting on this reservoir</span>
        <span class="n">reservoir</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Add to model flux list</span>
        <span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the current process to the vector x, and show the result as y.</span>
<span class="sd">        The resulting figure will be automatically saved.</span>

<span class="sd">        Example::</span>
<span class="sd">             process_name.show_figure(x,y)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">GenericFunction</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This Process class creates a GenericFunction instance which is</span>
<span class="sd">    typically used with the VirtualReservoir, and</span>
<span class="sd">    ExternalCode classes. This class is not user facing,</span>
<span class="sd">    please see the ExternalCode class docstring for the</span>
<span class="sd">    function template of a user provided function.</span>

<span class="sd">    see calc_carbonates in the carbonate chemistry for an example how</span>
<span class="sd">    to write a function for this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ReservoirGroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># list of allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;vr_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># required arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;input_data&quot;</span><span class="p">,</span> <span class="s2">&quot;vr_data&quot;</span><span class="p">,</span> <span class="s2">&quot;function_params&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>  <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we execute the user supplied function</span>
<span class="sd">        Where i = index of the current timestep</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">AddSignal</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process adds values to the current flux based on the values provided by the signal object.</span>
<span class="sd">    This class is typically invoked through the connector object</span>

<span class="sd">     Example::</span>

<span class="sd">     AddSignal(name = &quot;name&quot;,</span>
<span class="sd">               reservoir = upstream_reservoir_handle,</span>
<span class="sd">               flux = flux_to_act_upon,</span>
<span class="sd">               lt = flux with lookup values)</span>

<span class="sd">     where - the upstream reservoir is the reservoir the process belongs too</span>
<span class="sd">             the flux is the flux to act upon</span>
<span class="sd">             lt= contains the flux object we lookup from</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_with_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># use this when we do isotopes</span>
    <span class="k">def</span> <span class="nf">__add_with_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>

<span class="sd">        Note that the signal may also specify a delta value. Thus we</span>
<span class="sd">        need to</span>
<span class="sd">        1) get the mass of flux + signal</span>
<span class="sd">        2) add the delta of flux and signal</span>
<span class="sd">        3) calculate the new li and hi</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add signal mass to flux mass</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># flux rate</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># flux rate light isotope</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal mass</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal li</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="c1"># print(f&quot;Signal delta = {sd}&quot;)</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>
        <span class="c1"># print(f&quot;fa = {self.f.fa}\n&quot;)</span>

    <span class="k">def</span> <span class="nf">__add_with_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;same as above but use fa instead of flux data&quot;&quot;&quot;</span>

        <span class="c1"># add signal mass to flux mass</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># flux rate</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># flux rate light isotope</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal mass</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal li</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="c1"># set new flux rate</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_add_signal_fi</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flux_name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 4</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fm</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fl</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sm</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sd</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="c1"># set new flux rate</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_add_signal_fa</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flux_name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 2</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">SaveFluxData</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This process stores the flux data from each iteration into a vector</span>
<span class="sd">    Example::</span>

<span class="sd">         SaveFluxData(name = &quot;Name&quot;,</span>
<span class="sd">                   flux = Flux Handle</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_save_flux</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 4 2</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_save_flux</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ScaleFlux</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process scales the mass of a flux (m,l,h) relative to</span>
<span class="sd">    another flux. Delta is either taken from the upstream reservoir</span>
<span class="sd">    or set to a fixed value.  The scale factor &quot;scale&quot; and flux</span>
<span class="sd">    reference must be present when the object is being initalized</span>

<span class="sd">    Example::</span>
<span class="sd">         ScaleFlux(name = &quot;Name&quot;,</span>
<span class="sd">                   reservoir = reservoir_handle (upstream or downstream)</span>
<span class="sd">                   scale = 1</span>
<span class="sd">                   ref_flux = flux we use for scale</span>
<span class="sd">                   )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="s2">&quot;ref_reservoirs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;ref_flux&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify a value for ref_flux&quot;</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot; Decide how to calculate isotopes (if)</span>
<span class="sd">        If the connection specifies delta explicitly, this will</span>
<span class="sd">        override any settings in the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="c1"># delta explicitly provided</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="c1"># create stubs</span>
    <span class="k">def</span> <span class="nf">__with_source__</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the scale factor. This is typically done through the the</span>
<span class="sd">        model execute method.</span>
<span class="sd">        Note that this will use the mass of the flux we use for scaling, but that we will set the</span>
<span class="sd">        delta according to reservoir this flux derives from</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get reference flux</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;similar to with isotopes, but this time we take the</span>
<span class="sd">        isotope value of the source (which has no array, just a fixed</span>
<span class="sd">        value&quot;&quot;&quot;</span>

        <span class="c1"># get reference flux</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the scale factor. This is typically done through the the</span>
<span class="sd">        model execute method.</span>
<span class="sd">        Note that this will use the mass of the reference object, but that we will set the</span>
<span class="sd">        delta according to the reservoir (or the flux?)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we need to decide between cases where the reservoir is an</span>
<span class="sd">        actual reservoir or just a source, since sources do not have</span>
<span class="sd">        arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2 Reference Flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 5 3 Upstream reservoir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 6 4 Upstream reservoir li</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 8 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 9 6</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_r</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_r</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is derived from upstream reservoir&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass upstream reservoir</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># li upstream reservoir</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is set to a fixed value&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># l/h ratio</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Fractionation</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process offsets the isotopic ratio of the flux by a given</span>
<span class="sd">       delta value. In other words, we add a fractionation factor</span>

<span class="sd">    Example::</span>
<span class="sd">         Fractionation(name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir = upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle</span>
<span class="sd">                       alpha = 12 in permil (e.f)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="c1"># alpha is given in permil, but the fractionation routine expects</span>
        <span class="c1"># it as 1 + permil, i.e., 70 permil would 1.007</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flux isotope masses based on fractionation factor</span>
<span class="sd">        relative to reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;self.f.m[i] =  {self.f.m[i]}&quot;)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alp</span>

            <span class="n">fl</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">rm</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fractionation</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 6 4</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alp</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_fractionation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># params</span>
        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># alpha</span>

        <span class="c1"># data</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir mass</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir light isotope</span>

        <span class="n">fl</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">rm</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">RateConstant</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a wrapper for a variety of processes which depend on rate constants</span>
<span class="sd">    Please see the below class definitions for details on how to call them</span>
<span class="sd">    At present, the following processes are defined</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
            <span class="n">Sink</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Note that self.lkk values also need to be added to the lkk</span>
        <span class="c1"># list of the connector object.</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># update the allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_ref&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)],</span>
            <span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;liquid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;solubility&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;piston_velocity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;water_vapor_pressure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;seawaterconstants&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">SeawaterConstants</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;function_reference&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;f_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;pco2_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;280 ppm&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;ex&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="c1"># new required keywords</span>
        <span class="c1"># self.lrk.extend([[&quot;reservoir&quot;, &quot;atmosphere&quot;], [&quot;scale&quot;, &quot;k_value&quot;], &quot;register&quot;])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">elif</span> <span class="s2">&quot;gas_reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas_reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__misc_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="c1"># legacy variables</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span>
                <span class="c1"># print(f&quot;delta = {self.delta} setting c = {self.c}&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">weathering</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process calculates the flux as a function of the upstream</span>
<span class="sd">     reservoir concentration C and a constant which describes thet</span>
<span class="sd">     strength of relation between the reservoir concentration and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = f_0 * (scale * C/pco2_0)**ncc</span>

<span class="sd">     where C denotes the concentration in the ustream reservoir, k is a</span>
<span class="sd">     constant. This process is typically called by the connector</span>
<span class="sd">     instance. However you can instantiate it manually as</span>

<span class="sd">     weathering(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir = upstream_reservoir_handle,</span>
<span class="sd">                       reservoir_ref = reference_reservoir (Atmosphere)</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       ex = exponent</span>
<span class="sd">                       pco2_0 = 280,</span>
<span class="sd">                       f_0 = 12 / 17e12</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">                       delta = 0,</span>

<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the flux relative to the pco2_0 concentration.</span>
<span class="sd">        The delta values are derived from either:</span>

<span class="sd">        - the upstream reservoir</span>
<span class="sd">        - the upstream source</span>
<span class="sd">        - set to a fixed value</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mf">1e-6</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="o">.</span><span class="n">magnitude</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="c1"># if self.delta == &quot;None&quot; and  self.source.isotopes == False:</span>
        <span class="c1">#      self.fixed = True</span>
        <span class="c1"># delta provided explicitly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># source is Source and has delta</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># source is reservoir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># source is source, has no delta, and delta is not provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;data depends on whether upstream, is source or</span>
<span class="sd">        reservoir/gas-reservoir&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">),</span>  <span class="c1"># 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">),</span>  <span class="c1"># 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">),</span>  <span class="c1"># 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>  <span class="c1"># 5</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value depends on upstream reservoir&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># data</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value is fixed&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">MultiplySignal</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process mulitplies a given flux with the the data in the</span>
<span class="sd">    signal.  This class is typically invoked through the connector</span>
<span class="sd">    object: Note that this process will not modify the delta value of</span>
<span class="sd">    a given flux.  If you needto vary the delta value it is best to</span>
<span class="sd">    add a second signal which uses the add signal type.</span>

<span class="sd">     Example::</span>
<span class="sd">     MultiplySignal(name = &quot;name&quot;,</span>
<span class="sd">               reservoir = upstream_reservoir_handle,</span>
<span class="sd">               flux = flux_to_act_upon,</span>
<span class="sd">               lt = flux with lookup values)</span>

<span class="sd">     where the upstream reservoir is the reservoir the process belongs</span>
<span class="sd">             too the flux is the flux to act upon lt= contains the</span>
<span class="sd">             flux object we lookup from</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide whichh call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>

        <span class="c1"># default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_with_flux_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># use this when we do isotopes</span>
    <span class="k">def</span> <span class="nf">__multiply_with_flux_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># multiply flux mass with signal</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="c1"># h = self.f.h[i] * c</span>
        <span class="c1"># d = self.f.d[i]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;multiply fa </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="si">}</span><span class="s2">, f. = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">, c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__multiply_with_flux_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># multiply flux mass with signal</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_multiply_signal_fi</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="c1"># self.lt.l,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 3</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_multiply_signal_fa</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 1</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># m</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># l</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">VarDeltaOut</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unlike a passive flux, this process sets the flux istope ratio</span>
<span class="sd">    equal to the isotopic ratio of the reservoir. The</span>
<span class="sd">    init and register methods are inherited from the process</span>
<span class="sd">    class.</span>
<span class="sd">    VarDeltaOut(name = &quot;name&quot;,</span>
<span class="sd">                reservoir = upstream_reservoir_handle,</span>
<span class="sd">                flux = flux handle,</span>
<span class="sd">                rate = rate,)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">])</span>  <span class="c1"># required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="c1"># print(</span>
            <span class="c1">#    f&quot;vardeltaout with isotopes for {self.reservoir.register.name}.{self.reservoir.name}&quot;</span>
            <span class="c1"># )</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using reservoir&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_reservoir__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using Source&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_source__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, reservoir must be of type Source or Reservoir, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__with_isotopes_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we re-balance the flux. This code will be called by the</span>
<span class="sd">        apply_flux_modifier method of a reservoir which itself is</span>
<span class="sd">        called by the model execute method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="c1"># if upstream is a source, we only have a single delta value</span>
        <span class="c1"># so we need to patch this. Maybe this should move to source?</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_vardeltaout</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="c1"># self.flux.l,  # 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="c1"># delta,  # 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 5 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_vardeltaout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>

        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir mass</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir l</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes_source__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;If the source of the flux is a source, there is only a single delta value.</span>
<span class="sd">        Changes to the flux delta are applied through the Signal class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we re-balance the flux. This code will be called by the</span>
<span class="sd">        apply_flux_modifier method of a reservoir which itself is</span>
<span class="sd">        called by the model execute method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;vardeltaout w/o isotopes is not defined&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ScaleRelativeToMass</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process scales the flux as a function of the upstream</span>
<span class="sd">     reservoir Mass M and a constant which describes the</span>
<span class="sd">     strength of relation between the reservoir mass and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = F0 *  M * k</span>

<span class="sd">     where M denotes the mass in the ustream reservoir, k is a</span>
<span class="sd">     constant and F0 is the initial unscaled flux. This process is</span>
<span class="sd">     typically called by the connector instance. However you can</span>
<span class="sd">     instantiate it manually as</span>

<span class="sd">     Note that we scale the flux, rather than compute the flux!</span>

<span class="sd">     This is faster than setting a new flux, computing the isotope</span>
<span class="sd">     ratio and setting delta. So you either have to set the initial</span>
<span class="sd">     flux F0 to 1, or calculate the scale accordingly</span>

<span class="sd">     ScaleRelativeToMass(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir= upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this will be called by the Model.run() method</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="c1"># d: float = self.reservoir.d[i - 1]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_mass</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 7 4</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_mass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>

        <span class="c1"># data</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># rd = data[6][i - 1]</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># new flux</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># d: float = data[1][i - 1]  # flux delta</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">GasExchange</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    GasExchange(</span>
<span class="sd">          gas =GasReservoir, #</span>
<span class="sd">          liquid = Reservoir, #,</span>
<span class="sd">          ref_species = array of concentrations #</span>
<span class="sd">          solubility=Atmosphere.swc.SA_co2 [mol/(m^3 atm)],</span>
<span class="sd">          area = area, # m^2</span>
<span class="sd">          piston_velocity = m/year</span>
<span class="sd">          seawaterconstants = Ocean.swc</span>
<span class="sd">          water_vapor_pressure=Ocean.swc.p_H2O,</span>
<span class="sd">    )</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># redefine misc_init which is being called by post-init</span>
    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up input variables&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">p_H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_dg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">volume</span>

    <span class="k">def</span> <span class="nf">ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># area in m^2  # Atmosphere  # p_H2O  # SA_co2 = mol/(m^3 atm)  # [CO2]aq mol</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># set flux</span>
        <span class="c1"># note that the sink delta is co2aq as returned by the carbonate VR</span>
        <span class="c1"># this equation is for mmol but esbmtk uses mol, so we need to</span>
        <span class="c1"># multiply by 1E3</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>  <span class="c1"># area in m^2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Atmosphere</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>  <span class="c1"># SA_co2 = mol/(m^3 atm)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># [CO2]aq mol</span>
        <span class="p">)</span>
        <span class="c1"># print(self.gas.c[i - 1])</span>

        <span class="c1"># changes in the mass of CO2 also affect changes in the total mass</span>
        <span class="c1"># of the atmosphere. So we need to update the reservoir volume</span>
        <span class="c1"># variable which we use the store the total atmospheric mass</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.gas.v[i] = self.gas.v[i - 1] + f * self.gas.mo.dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In the following I assume near neutral pH between 7 and 9, so that</span>
<span class="sd">        the isotopic composition of HCO3- is approximately equal to the isotopic</span>
<span class="sd">        ratio of DIC. The isotopic ratio of [CO2]aq can then be obtained from DIC via</span>
<span class="sd">        swc.e_db (swc.a_db)</span>

<span class="sd">        The fractionation factor subscripts denote the following:</span>

<span class="sd">        g = gaseous</span>
<span class="sd">        d = dissolved</span>
<span class="sd">        b = bicarbonate ion</span>
<span class="sd">        c = carbonate ion</span>

<span class="sd">        a_db is thus the fractionation factor between dissolved CO2aq and HCO3-</span>
<span class="sd">        and a_dg between CO2aq and CO2g</span>

<span class="sd">        ref_species = DIC.cs.CO2aq</span>
<span class="sd">        liquid.m = DIC.m (used to get the isotope ratio)</span>

<span class="sd">        gas.m = mass of CO2</span>
<span class="sd">        gas.l = mass of 12CO2</span>
<span class="sd">        gas.c = CO2 concentration</span>
<span class="sd">        gas.v = total mass of atmosphere</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># equilibrium concentration of CO2 in water based on pCO2</span>
        <span class="n">eco2_at</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># p Atmosphere</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>
        <span class="p">)</span>
        <span class="c1"># equilibrium concentration of CO2 in water based on CO2aq</span>
        <span class="n">eco2_aq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1">#  flux</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at</span> <span class="o">-</span> <span class="n">eco2_aq</span><span class="p">)</span>

        <span class="n">c13g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c13aq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># get 13C CO2 equlibrium concentration  CO2 in water based on pCO2</span>
        <span class="n">eco2_at_13</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">c13g</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span>
        <span class="p">)</span>

        <span class="c1"># get 13C equilibrium  CO2 in water based on DIC m &amp; l</span>
        <span class="n">eco2_aq_13</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_db</span> <span class="o">*</span> <span class="n">eco2_aq</span> <span class="o">*</span> <span class="n">c13aq</span>

        <span class="c1"># 13C flux</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_u</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at_13</span> <span class="o">-</span> <span class="n">eco2_aq_13</span><span class="p">)</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f13</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        not working, see note below</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>
        <span class="c1"># print()</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do some housekeeping for the process class&quot;&quot;&quot;</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_gas_exchange</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">,</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>  <span class="c1"># 3 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_u</span><span class="p">),</span>  <span class="c1"># 4 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span><span class="p">),</span>  <span class="c1"># 5 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_db</span><span class="p">),</span>  <span class="c1"># 6 5</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_gas_exchange</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;the below equation moved as many constants as possible</span>
<span class="sd">        outside of the function compared to the</span>
<span class="sd">        __with/without_isotopes__ method(s). See the</span>
<span class="sd">        __get_process_args__ method for details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">SA</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># solubility as  (1 - pH2O) * S</span>
        <span class="n">gv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># gas volume</span>
        <span class="n">au</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">dg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1">#</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in liquid</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in liquid_reservoir</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in gas reservoir</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in gas reservoir</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentration in gas reservoir</span>
        <span class="n">gv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># total mass of atmosphere</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentrartion of reference species in liquid_reservoir</span>
        <span class="n">gh</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">-</span> <span class="n">gl</span>  <span class="c1"># mass of heavy isotope in gas reservoir</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="n">lm</span> <span class="o">-</span> <span class="n">ll</span>  <span class="c1"># mass of heavy isotope in liquid reservoir</span>

        <span class="c1"># equilibrium concentration of CO2 in water based on pCO2</span>
        <span class="n">eco2_at</span> <span class="o">=</span> <span class="n">gc</span> <span class="o">*</span> <span class="n">SA</span>  <span class="c1"># p Atmosphere  # p_H2O</span>
        <span class="c1"># equilibrium concentration of CO2 in water based on CO2aq</span>
        <span class="n">eco2_aq</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at</span> <span class="o">-</span> <span class="n">eco2_aq</span><span class="p">)</span>
        <span class="c1"># get 13C CO2 equlibrium concentration</span>
        <span class="n">eco2_at_13</span> <span class="o">=</span> <span class="n">gh</span> <span class="o">/</span> <span class="n">gv</span> <span class="o">*</span> <span class="n">SA</span> <span class="o">*</span> <span class="n">dg</span>  <span class="c1"># p_H2O</span>
        <span class="c1"># get 13C in CO2aq</span>
        <span class="n">eco2_aq_13</span> <span class="o">=</span> <span class="n">db</span> <span class="o">*</span> <span class="n">eco2_aq</span> <span class="o">*</span> <span class="n">lh</span> <span class="o">/</span> <span class="n">lm</span>
        <span class="c1"># flux od 13C</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">au</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at_13</span> <span class="o">-</span> <span class="n">eco2_aq_13</span><span class="p">)</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f13</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>  <span class="c1"># fa</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        This is currently not working, as the total mass increases faster</span>
<span class="sd">        than the species mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data[6][i] = data[6][i - 1] + f * dt * -1</span>


<span class="k">class</span> <span class="nc">ScaleRelativeToConcentration</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process calculates the flux as a function of the upstream</span>
<span class="sd">     reservoir concentration C and a constant which describes thet</span>
<span class="sd">     strength of relation between the reservoir concentration and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = C * k</span>

<span class="sd">     where C denotes the concentration in the ustream reservoir, k is a</span>
<span class="sd">     constant. This process is typically called by the connector</span>
<span class="sd">     instance. However you can instantiate it manually as</span>

<span class="sd">     ScaleRelativeToConcentration(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir= upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">                       delta = &quot;None&quot;,</span>
<span class="sd">    )</span>

<span class="sd">    If delta is given the fluxes uses a ficed delta, If not it uses</span>
<span class="sd">    the upestream delta</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="c1"># convert to concentration</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of self.reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of self.reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If no delta provided, use upstream reservoir ratios</span>
<span class="sd">        Otherwise, use a fixed ratio</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;scale relative to concentrations is undefined for Source-type&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.m = {type(self.reservoir.m)}&quot;)</span>
        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.l = {type(self.reservoir.l)}\n&quot;)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0 6 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1 7 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 2 8 5</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends on upstream delta&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>
        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res li</span>

            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends fixed value&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>

        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># isotope ratio</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</pre></div>

        </details>

            </section>
                <section id="Process">
                                <div class="attr class">
        <a class="headerlink" href="#Process">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Process</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class defines template for proycess which acts on one or more</span>
<span class="sd">    reservoir flux combinations. To use it, you need to create an</span>
<span class="sd">    subclass which defines the actual process implementation in their</span>
<span class="sd">    call method. See &#39;PassiveFlux as example&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Model</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>  <span class="c1"># default error messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number or quantity&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do some housekeeping for the process class&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Flux</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span>

        <span class="c1"># self.rm0: float = self.r.m[0]  # the initial reservoir mass</span>

        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Flux</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;delta&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__misc_init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__delayed_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize stuff which is only known after the entire model has been defined.</span>
<span class="sd">        This will be executed just before running the model. You need to add the following</span>
<span class="sd">        two lines somewhere in the init procedure (preferably by redefining __misc_init__)</span>
<span class="sd">        and redefine __delayed_init__ to actually execute any code below</span>

<span class="sd">        # this process requires delayed init</span>
<span class="sd">        self.mo.lto.append(self)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is just a place holder method which will be called by default</span>
<span class="sd">        in __post_init__() This can be overloaded to add additional</span>
<span class="sd">        code to the init procedure without the need to redefine</span>
<span class="sd">        init. This useful for processes which only define a call method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__defaultnames__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set up the default names and dicts for the process class. This</span>
<span class="sd">        allows us to extend these values without modifying the entire init process</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
            <span class="n">Sink</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Flux</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">Model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of known keywords and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;lt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">)],</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">ConnectionGroup</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Flux</span><span class="p">,</span>
                    <span class="n">Model</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservoir</span><span class="p">,</span> <span class="n">flux</span><span class="p">:</span> <span class="n">Flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register the flux/reservoir pair we are acting upon, and register</span>
<span class="sd">        the process with the reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span>

        <span class="c1"># register the reservoir flux combination we are acting on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span> <span class="o">=</span> <span class="n">reservoir</span>
        <span class="c1"># add this process to the list of processes acting on this reservoir</span>
        <span class="n">reservoir</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Add to model flux list</span>
        <span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the current process to the vector x, and show the result as y.</span>
<span class="sd">        The resulting figure will be automatically saved.</span>

<span class="sd">        Example::</span>
<span class="sd">             process_name.show_figure(x,y)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class defines template for proycess which acts on one or more
reservoir flux combinations. To use it, you need to create an
subclass which defines the actual process implementation in their
call method. See 'PassiveFlux as example'</p>
</div>


                            <div id="Process.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Process.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Process</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>  <span class="c1"># default error messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number or quantity&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new process object with a given process type and options</p>
</div>


                            </div>
                            <div id="Process.show_figure" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Process.show_figure">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">show_figure</span><span class="signature">(self, x, y) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">show_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the current process to the vector x, and show the result as y.</span>
<span class="sd">        The resulting figure will be automatically saved.</span>

<span class="sd">        Example::</span>
<span class="sd">             process_name.show_figure(x,y)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Apply the current process to the vector x, and show the result as y.
The resulting figure will be automatically saved.</p>

<p>Example::
     process_name.show_figure(x,y)</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Process.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process.Source">
                                <div class="attr class">
        <a class="headerlink" href="#Process.Source">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process.Source</span><wbr>(<span class="base"><a href="esbmtk.html#SourceSink">esbmtk.esbmtk.SourceSink</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Source(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Source object
Example::</p>

<pre><code>   Source(name = "SO4_diffusion", species ="SO4")
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#SourceSink">esbmtk.esbmtk.SourceSink</a></dt>
                                <dd id="Process.Source.__init__" class="function"><a href="esbmtk.html#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Process.Source.delta" class="variable"><a href="esbmtk.html#SourceSink.delta">delta</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.Source.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Process.Source.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process.Reservoir">
                                <div class="attr class">
        <a class="headerlink" href="#Process.Reservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process.Reservoir</span><wbr>(<span class="base"><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Reservoir</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information.</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,      # Name of reservoir</span>
<span class="sd">                            species = S,          # Species handle</span>
<span class="sd">                            delta = 20,           # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            mass/concentration = &quot;1 unit&quot;  # species concentration or mass</span>
<span class="sd">                            volume/geometry = &quot;1E5 l&quot;,      # reservoir volume (m^3)</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            seawater_parameters= dict, optional</span>
<span class="sd">                            )</span>

<span class="sd">          You must either give mass or concentration.  The result will always be displayed</span>
<span class="sd">          as concentration though.</span>

<span class="sd">          You must provide either the volume or the geometry keyword. In the latter case</span>
<span class="sd">          provide a list where the first entry is the upper depth datum, the second entry is</span>
<span class="sd">          the lower depth datum, and the third entry is the area percentage. E.g., to specify</span>
<span class="sd">          the upper 200 meters of the entire ocean, you would write:</span>

<span class="sd">                 geometry=[0,-200,1]</span>

<span class="sd">          the corresponding ocean volume will then be calculated by the calc_volume method</span>
<span class="sd">          in this case the following instance variables will also be set:</span>

<span class="sd">                 self.volume in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">          Adding seawater_properties:</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">          If this optional parameter is specified, a SeaWaterConstants instance will be registered</span>
<span class="sd">          for this Reservoir as Reservoir.swc</span>
<span class="sd">          See the  SeaWaterConstants class for details how to specify the parameters, e.g.:</span>
<span class="sd">          seawater_parameters = {&quot;temperature&quot;: 2, &quot;pressure&quot;: 240, &quot;salinity&quot; : 35},</span>

<span class="sd">          Using a transform function</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">          In some cases, it is useful to transform the reservoir</span>
<span class="sd">          concentration data before plotting it.  A good example is the H+</span>
<span class="sd">          concentration in water which is better displayed as pH.  We can</span>
<span class="sd">          do this by specifying a function to convert the reservoir</span>
<span class="sd">          concentration into pH units::</span>

<span class="sd">              def phc(c :float) -&gt; float:</span>
<span class="sd">                  # Calculate concentration as pH. c can be a number or numpy array</span>

<span class="sd">                  import numpy as np</span>

<span class="sd">                  pH :float = -np.log10(c)</span>
<span class="sd">                  return pH</span>

<span class="sd">          this function can then be added to a reservoir as::</span>

<span class="sd">          hplus.plot_transform_c = phc</span>

<span class="sd">          You can modify the left legend to suit the transform via the legend_left keyword</span>

<span class="sd">          Note, at present the plot_transform_c function will only take one</span>
<span class="sd">          argument, which always defaults to the reservoir</span>
<span class="sd">          concentration. The function must return a single argument which</span>
<span class="sd">          will be interpreted as the transformed reservoir concentration.</span>

<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">any</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># steps = kwargs[&quot;species&quot;].mo.steps</span>
        <span class="c1"># self.m: np.ndarray =np.zeros(steps) + self.mass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ideal_water</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">swc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">SeawaterConstants</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">salinity</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">=</span> <span class="n">c</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@concentration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@mass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</pre></div>

        </details>

            <div class="docstring"><p>This object holds reservoir specific information.</p>

<pre><code>  Example::

          Reservoir(name = "foo",      # Name of reservoir
                    species = S,          # Species handle
                    delta = 20,           # initial delta - optional (defaults  to 0)
                    mass/concentration = "1 unit"  # species concentration or mass
                    volume/geometry = "1E5 l",      # reservoir volume (m^3)
                    plot = "yes"/"no", defaults to yes
                    plot_transform_c = a function reference, optional (see below)
                    legend_left = str, optional, useful for plot transform
                    display_precision = number, optional, inherited from Model
                    register = optional, use to register with Reservoir Group
                    isotopes = True/False otherwise use Model.m_type
                    seawater_parameters= dict, optional
                    )

  You must either give mass or concentration.  The result will always be displayed
  as concentration though.

  You must provide either the volume or the geometry keyword. In the latter case
  provide a list where the first entry is the upper depth datum, the second entry is
  the lower depth datum, and the third entry is the area percentage. E.g., to specify
  the upper 200 meters of the entire ocean, you would write:

         geometry=[0,-200,1]

  the corresponding ocean volume will then be calculated by the calc_volume method
  in this case the following instance variables will also be set:

         self.volume in model units (usually liter)
         self.are:a surface area in m^2 at the upper bounding surface
         self.area_dz: area of seafloor which is intercepted by this box.
         self.area_fraction: area of seafloor which is intercepted by this
                            relative to the total ocean floor area

  Adding seawater_properties:
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~
  If this optional parameter is specified, a SeaWaterConstants instance will be registered
  for this Reservoir as Reservoir.swc
  See the  SeaWaterConstants class for details how to specify the parameters, e.g.:
  seawater_parameters = {"temperature": 2, "pressure": 240, "salinity" : 35},

  Using a transform function
  ~~~~~~~~~~~~~~~~~~~~~~~~~~

  In some cases, it is useful to transform the reservoir
  concentration data before plotting it.  A good example is the H+
  concentration in water which is better displayed as pH.  We can
  do this by specifying a function to convert the reservoir
  concentration into pH units::

      def phc(c :float) -&gt; float:
          # Calculate concentration as pH. c can be a number or numpy array

          import numpy as np

          pH :float = -np.log10(c)
          return pH

  this function can then be added to a reservoir as::

  hplus.plot_transform_c = phc

  You can modify the left legend to suit the transform via the legend_left keyword

  Note, at present the plot_transform_c function will only take one
  argument, which always defaults to the reservoir
  concentration. The function must return a single argument which
  will be interpreted as the transformed reservoir concentration.
</code></pre>

<p>Accesing Reservoir Data:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~~</p>

<p>You can access the reservoir data as:</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>

<p>Useful methods include:</p>

<ul>
<li>Name.write_data() # save data to file</li>
<li>Name.info()   # info Reservoir</li>
</ul>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#Reservoir">esbmtk.esbmtk.Reservoir</a></dt>
                                <dd id="Process.Reservoir.__init__" class="function"><a href="esbmtk.html#Reservoir.__init__">Reservoir</a></dd>
                <dd id="Process.Reservoir.concentration" class="variable"><a href="esbmtk.html#Reservoir.concentration">concentration</a></dd>
                <dd id="Process.Reservoir.delta" class="variable"><a href="esbmtk.html#Reservoir.delta">delta</a></dd>
                <dd id="Process.Reservoir.mass" class="variable"><a href="esbmtk.html#Reservoir.mass">mass</a></dd>

            </div>
            <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="Process.Reservoir.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="Process.Reservoir.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.Reservoir.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process.Sink">
                                <div class="attr class">
        <a class="headerlink" href="#Process.Sink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process.Sink</span><wbr>(<span class="base"><a href="esbmtk.html#SourceSink">esbmtk.esbmtk.SourceSink</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Sink object
Example::</p>

<pre><code>   Sink(name = "Pyrite",species =SO4)
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#SourceSink">esbmtk.esbmtk.SourceSink</a></dt>
                                <dd id="Process.Sink.__init__" class="function"><a href="esbmtk.html#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Process.Sink.delta" class="variable"><a href="esbmtk.html#SourceSink.delta">delta</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.Sink.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Process.Sink.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process.Flux">
                                <div class="attr class">
        <a class="headerlink" href="#Process.Flux">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process.Flux</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Flux</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class which defines a flux object. Flux objects contain</span>
<span class="sd">    information which links them to an species, describe things like</span>
<span class="sd">    the mass and time unit, and store data of the total flux rate at</span>
<span class="sd">    any given time step. Similarly, they store the flux of the light</span>
<span class="sd">    and heavy isotope flux, as well as the delta of the flux. This</span>
<span class="sd">    is typically handled through the Connect object. If you set it up manually</span>

<span class="sd">    Flux = (name = &quot;Name&quot; # optional, defaults to _F</span>
<span class="sd">            species = species_handle,</span>
<span class="sd">            delta = any number,</span>
<span class="sd">            rate  = &quot;12 mol/s&quot; # must be a string</span>
<span class="sd">            display_precision = number, optional, inherited from Model</span>
<span class="sd">    )</span>

<span class="sd">     You can access the flux data as</span>
<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">AirSeaExchange</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Connect</span><span class="p">,</span>
            <span class="n">Connection</span><span class="p">,</span>
            <span class="n">Signal</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Connection</span><span class="p">,</span>
                    <span class="n">Connect</span><span class="p">,</span>
                    <span class="n">AirSeaExchange</span><span class="p">,</span>
                    <span class="n">Signal</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="c1"># if save_flux_data is unsepcified, use model default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">save_flux_data</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="n">li</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">fluxrate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fluxrate</span><span class="p">,</span> <span class="n">li</span><span class="p">])</span>

        <span class="c1"># in case we want to keep the flux data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>  <span class="c1"># add the flux</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># setup dummy variables to keep existing numba data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Connect</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_F&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="c1"># print(f&quot;f name set to {self.name}. fn =  {self.full_name}\n&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model flux list</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_without_isotopes__</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>
        <span class="c1"># return self.__get_data__(i)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;substracting two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extracted_from_info_27</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>

    <span class="c1"># TODO Rename this here and in `info`</span>
    <span class="k">def</span> <span class="nf">_extracted_from_info_27</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot second axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the result of the last computation back to the beginning</span>
<span class="sd">        so that a new run will start with these values.</span>

<span class="sd">        Also, copy current results into temp field</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>
            <span class="c1"># copy last element to first position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span>
</pre></div>

        </details>

            <div class="docstring"><p>A class which defines a flux object. Flux objects contain
information which links them to an species, describe things like
the mass and time unit, and store data of the total flux rate at
any given time step. Similarly, they store the flux of the light
and heavy isotope flux, as well as the delta of the flux. This
is typically handled through the Connect object. If you set it up manually</p>

<p>Flux = (name = "Name" # optional, defaults to _F
        species = species_handle,
        delta = any number,
        rate  = "12 mol/s" # must be a string
        display_precision = number, optional, inherited from Model
)</p>

<p>You can access the flux data as</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#Flux">esbmtk.esbmtk.Flux</a></dt>
                                <dd id="Process.Flux.__init__" class="function"><a href="esbmtk.html#Flux.__init__">Flux</a></dd>
                <dd id="Process.Flux.info" class="function"><a href="esbmtk.html#Flux.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.Flux.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process.Model">
                                <div class="attr class">
        <a class="headerlink" href="#Process.Model">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Process.Model</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to specify a new model</span>

<span class="sd">    Example:</span>

<span class="sd">          esbmtkModel(name   =  &quot;Test_Model&quot;,</span>
<span class="sd">                      start    = &quot;0 yrs&quot;,    # optional: start time</span>
<span class="sd">                      stop     = &quot;10000 yrs&quot;, # end time</span>
<span class="sd">                      timestep = &quot;2 yrs&quot;,    # as a string &quot;2 yrs&quot;</span>
<span class="sd">                      offset = &quot;0 yrs&quot;,    # optional: time offset for plot</span>
<span class="sd">                      mass_unit = &quot;mol&quot;,   #required</span>
<span class="sd">                      volume_unit = &quot;l&quot;, #required</span>
<span class="sd">                      time_label = optional, defaults to &quot;Time&quot;</span>
<span class="sd">                      display_precision = optional, defaults to 0.01,</span>
<span class="sd">                      m_type = &quot;mass_only/both&quot;</span>
<span class="sd">                      plot_style = &#39;default&#39;, optional defaults to &#39;default&#39;</span>
<span class="sd">                      number_of_datapoints = optional, see below</span>
<span class="sd">                      step_limit = optional, see below</span>
<span class="sd">                      register = &#39;local&#39;, see below</span>
<span class="sd">                      save_flux_data = False, see below</span>
<span class="sd">                      ideal_water = False</span>
<span class="sd">                      use_ode = False</span>
<span class="sd">                    )</span>

<span class="sd">    ref_time: will offset the time axis by the specified amount, when</span>
<span class="sd">                 plotting the data, .i.e., the model time runs from to</span>
<span class="sd">                 100, but you want to plot data as if where from 2000</span>
<span class="sd">                 to 2100, you would specify a value of 2000. This is</span>
<span class="sd">                 for display purposes only, and does not affect the</span>
<span class="sd">                 model. Care must be taken that any external data</span>
<span class="sd">                 references the model time domain, and not the display</span>
<span class="sd">                 time.</span>

<span class="sd">    display precision: affects the on-screen display of data. It is</span>
<span class="sd">                       also cutoff for the graphicak output. I.e., the</span>
<span class="sd">                       interval f the y-axis will not be smaller than</span>
<span class="sd">                       the display_precision.</span>

<span class="sd">    m_type: enables or disables isotope calculation for the entire</span>
<span class="sd">            model.  The default value is &quot;Not set&quot; in this case</span>
<span class="sd">            isotopes will only be calculaten for reservoirs which set</span>
<span class="sd">            the isotope keyword. &#39;mass_only&#39; &#39;both&#39; will override the</span>
<span class="sd">            reservoir settings</span>

<span class="sd">    register = local/None. If set to &#39;None&#39; all objects are registered</span>
<span class="sd">               in the global namespace the default setting is local,</span>
<span class="sd">               i.e. all objects are registered in the model namespace.</span>

<span class="sd">    save_flux_data: Normally, flux data is not stored. Set this to True</span>
<span class="sd">               for debugging puposes. Note, Fluxes with signals are always</span>
<span class="sd">               stored. You can also enable this option for inidividual</span>
<span class="sd">               connections (fluxes).</span>

<span class="sd">    get_delta_values: Compute delta values as postprocessing step.</span>

<span class="sd">    All of the above keyword values are available as variables with</span>
<span class="sd">    Model_Name.keyword</span>

<span class="sd">    The user facing methods of the model class are</span>
<span class="sd">       - Model_Name.info()</span>
<span class="sd">       - Model_Name.save_data()</span>
<span class="sd">       - Model_Name.plot_data()</span>
<span class="sd">       - Model_Name.plot_reservoirs() takes an optional filename as argument</span>
<span class="sd">       - Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</span>
<span class="sd">       - Model_Name.save_state() Save the model state</span>
<span class="sd">       - Model_name.read_state() Initialize with a previous model state</span>
<span class="sd">       - Model_Name.run(), there are 2 optional arguments here, solver=&quot;hybrid&quot;</span>
<span class="sd">         and solver = &quot;numba&quot;. Both involve a 3 to 5 second overhead. The hybrid</span>
<span class="sd">         solver is compatible with all connection types, and about 3 times faster</span>
<span class="sd">         than the  regular solver. The numba solver is about 10 faster, but currently</span>
<span class="sd">         only supports a limited set of connection types.</span>
<span class="sd">       - Model_Name.list_species()</span>
<span class="sd">       - Model_name.flux_summary()</span>
<span class="sd">       - Model_Name.connection_summary()</span>


<span class="sd">    User facing variable are Model_Name.time which contains the time</span>
<span class="sd">    axis.</span>

<span class="sd">    Optional, you can provide the element keyword which will setup a</span>
<span class="sd">    default set of Species for Carbon and Sulfur. In this case, there</span>
<span class="sd">    is no need to define elements or species. The argument to this</span>
<span class="sd">    keyword are either &quot;Carbon&quot;, or &quot;Sulfur&quot; or both as a list</span>
<span class="sd">    [&quot;Carbon&quot;, &quot;Sulfur&quot;].</span>


<span class="sd">    Dealing with large datasets:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    1) Limiting the size of the data which is being saved with save_data()</span>

<span class="sd">         number_of_datapoints = 100 will only write every nth data point to file.</span>
<span class="sd">                                where n = timesteps/ number_of_datapoints</span>

<span class="sd">         this defaults to 1000 until set explicitly.</span>

<span class="sd">    2) Reducing the memory footprint</span>

<span class="sd">    Models with a long runtime can easily exceed the available</span>
<span class="sd">    computer memory, as much if it is goobled up storing the model</span>
<span class="sd">    results. In this case, one can set the optional parameter</span>

<span class="sd">       step_limit = 1E6</span>

<span class="sd">    The above will limit the total number of iterations to 1E6, then</span>
<span class="sd">    save the data up to this point, and then restart the</span>
<span class="sd">    model. Subsequent results will be appended to the results.</span>

<span class="sd">    Caveat Emptor: If your model uses a signal instance, all signal</span>
<span class="sd">    data must fit into a single iteration set. At present, there is no</span>
<span class="sd">    support for signals which extend beyond the step_limit.</span>

<span class="sd">    In order to prevent the creation of massive datafiles, number_of_datapoints</span>
<span class="sd">    defaults to 1000. Modify as needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="c1"># from . import ureg, Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m**3&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol/kg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Set&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;number_of_datapoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;step_limit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e9</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;use_ode&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lic</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of all reservoir type objects</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># set of flux processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># keep track of repeated solver calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mol/kg&quot;</span><span class="p">,</span> <span class="s2">&quot;mol/l&quot;</span><span class="p">,</span> <span class="s2">&quot;mol/liter&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="si">}</span><span class="s2"> must be either mol/l or mol/kg&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1"># self.start = self.start + self.offset</span>
        <span class="c1"># self.stop = self.stop + self.offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># calculate stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">species_definitions</span><span class="p">,</span> <span class="n">hypsometry</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="c1"># register elements and species with model</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
                <span class="c1"># get function handle</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">species_definitions</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register element with model</span>
                <span class="c1"># get element handle</span>
                <span class="n">eh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># register species with model</span>
                <span class="n">eh</span><span class="o">.</span><span class="n">__register_species_with_model__</span><span class="p">()</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="c1"># if &quot;index&quot; not in kwargs:</span>
        <span class="c1">#    index = 0</span>
        <span class="c1"># else:</span>
        <span class="c1"># index = kwargs[&quot;index&quot;]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>
<span class="sd">        append = True/False #</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stride&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start = </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, stop = </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">, stride=</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">, append =</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="c1"># print(f&quot;R = {r.full_name}&quot;)</span>
            <span class="c1"># print(f&quot;start = {start}, stop = {stop}, stride={stride}, append ={append}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="c1"># for r in self.ldf:</span>
        <span class="c1">#     r.__write_data__(prefix, start, stop, stride, append)</span>
        <span class="c1"># print(&quot;Writing virtual reservoir data&quot;)</span>
        <span class="c1"># for r in self.lvr:</span>
        <span class="c1">#    r.__write_data__(prefix, start, stop, stride, append, &quot;data&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done writing&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the model with result of the last run.</span>
<span class="sd">        This is useful for long runs which otherwise would used</span>
<span class="sd">        to much memory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="c1"># print(f&quot;len of time {len(self.time)}, stride = {self.stride}&quot;)</span>
        <span class="c1"># print(f&quot;len of time with stride {len(self.time[0 : -2 : self.stride])}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new start = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, new stop = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time[0] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> time[-1] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># print(f&quot;len of timec {len(self.timec)}&quot;)</span>
        <span class="c1"># self.time = (arange(self.steps) * self.dt) + self.start</span>

    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="c1"># print(f&quot;lvr  reading from {r.full_name}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_temp_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the datafields which were used for an individual iteration</span>
<span class="sd">        with the data we saved from the previous iterations</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timec</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in pl</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fn&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># row, col</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="sd">&quot;&quot;&quot; The shape of the ax value of subplots depends on the figure</span>
<span class="sd">        geometry. So we need to ensure we are dealing with a 2-D array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># row=1, col=1 only one window</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># mutiple rows, one column</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 1 row, multiple columns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>  <span class="c1"># mutiple rows and mutiple columns</span>

        <span class="c1"># ste plot parameters</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over objects</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># rows</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># columns</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">noo</span><span class="p">:</span>
                    <span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="c1"># new: np.ndarray = np.zeros(4)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">]</span>
        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span> <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restarting model&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_temp_results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span>
            <span class="c1"># after merging, the model steps = number_of_datapoints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This run used </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Gbytes of memory </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_delta_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate masses and isotope ratios in the usual delta</span>
<span class="sd">        notation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">volume</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta_h</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># for vr in self.lvr:</span>
        <span class="c1">#     vr.d = get_delta_h(vr)</span>

        <span class="c1"># for f in self.lof:</span>
        <span class="c1">#     if f.save_flux_data:</span>
        <span class="c1">#         f.d = get_delta_h(f)</span>

    <span class="k">def</span> <span class="nf">sub_sample_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subsample the data. No need to save 100k lines of data You need to</span>
<span class="sd">        do this _after_ saving the state, but before plotting and</span>
<span class="sd">        saving the data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stride</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
                <span class="n">vr</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__run_solver__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;ode&quot;</span><span class="p">:</span>
            <span class="n">ode_solver</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;ode_uli&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> the solver type &#39;ode_uli&#39; is deprecated, please use &#39;ode&#39; </span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ode_solver</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Solver=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="si">}</span><span class="s2"> is unkknown, use &#39;python/numba/odeint/ode&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ode_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the ode solver based on Uli&#39;s approach&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">write_equations_2</span><span class="p">,</span> <span class="n">get_initial_conditions</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span><span class="p">,</span> <span class="n">solve_ivp</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">pathlib</span> <span class="k">as</span> <span class="nn">pl</span>

        <span class="c1"># build equation file</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span> <span class="o">=</span> <span class="n">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">icl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">cpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl</span> <span class="o">=</span> <span class="n">ipl</span>

        <span class="c1"># write equation system</span>
        <span class="n">eqs_file</span> <span class="o">=</span> <span class="n">write_equations_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loc = </span><span class="si">{</span><span class="n">eqs_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that cwd is in the load path. Required for windows</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># import equation system</span>
        <span class="kn">from</span> <span class="nn">equations</span> <span class="kn">import</span> <span class="n">setup_ode</span>

        <span class="n">ode_system</span> <span class="o">=</span> <span class="n">setup_ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># create ode system instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span> <span class="o">=</span> <span class="n">ode_system</span>

        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;RK23&quot;</span>
        <span class="n">stype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stype&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;stype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;solve_ivp&quot;</span>
        <span class="n">max_step</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_step&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;max_step&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mf">1e6</span>
        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;solve_ivp&quot;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                <span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">R</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="c1"># t_eval=self.time,</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                <span class="n">first_step</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="c1"># dense_output=True,</span>
                <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># interpolate signals into the ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># interpolate external data into ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="c1"># for ed in self.led:</span>
            <span class="c1">#     ed.y = np.interp(results.t, ed.x, ed.y)</span>

            <span class="c1"># assign results to the esbmtk variables</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">icl</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># this needs fixing if we have variable volumes</span>
                <span class="n">r</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span>  <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">volume</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">t</span>

            <span class="c1"># interpolate intermediate results to match the model</span>
            <span class="c1"># time scale. This only applies to data in virtual</span>
            <span class="c1"># data fields</span>
            <span class="k">for</span> <span class="n">gf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span>
                <span class="c1"># get cs instance handle</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;table&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># get ode data</span>
                        <span class="c1"># print(f&quot;R = {gf.full_name} - {k}:\n&quot;</span>
                        <span class="c1">#       f&quot;len(fp) = {len(od[0 : self.ode_system.i])}, &quot;</span>
                        <span class="c1">#       f&quot;len(xp) = {len(self.ode_system.t)}, &quot;</span>
                        <span class="c1">#       f&quot;i = {self.ode_system.i}&quot;)</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">od</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">od</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span> <span class="n">tfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># assign results</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">__step_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

    <span class="k">def</span> <span class="nf">__step_update_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>
        <span class="c1"># new = sum_fluxes(flux_list,r,i) # integrate all fluxes in self.lof</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">hs</span><span class="p">])</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
        <span class="c1"># new = new * (new &gt; 0)  # set negative values to zero</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional</span>
<span class="sd">                         conditions, i.e., all words must occur in a given name</span>

<span class="sd">        return_list: bool = False, if True return a list of fluxes matching the filter_by string.</span>

<span class="sd">        exclude:str = exclude all results matching this string</span>

<span class="sd">        Example:</span>

<span class="sd">              names = M.flux_summary(filter_by=&quot;POP A_sb&quot;, return_list=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fby</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">check_exlusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;exclude&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exclude&quot;</span><span class="p">]</span>
            <span class="n">check_exlusion</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;return_list&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over flux list</span>

            <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">check_exlusion</span> <span class="ow">and</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_exlusion</span>
            <span class="p">):</span>
                <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rl</span>

    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional conditions</span>
<span class="sd">                         i.e., all words must occur in a given name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fby = </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Group Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       run the following command to see more details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if all words of the fby list occur in c.full_name. If yes,</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fby</span> <span class="ow">and</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">fby</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all model objects&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleting </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">__builtins__</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class is used to specify a new model</p>

<p>Example:</p>

<pre><code>  esbmtkModel(name   =  "Test_Model",
              start    = "0 yrs",    # optional: start time
              stop     = "10000 yrs", # end time
              timestep = "2 yrs",    # as a string "2 yrs"
              offset = "0 yrs",    # optional: time offset for plot
              mass_unit = "mol",   #required
              volume_unit = "l", #required
              time_label = optional, defaults to "Time"
              display_precision = optional, defaults to 0.01,
              m_type = "mass_only/both"
              plot_style = 'default', optional defaults to 'default'
              number_of_datapoints = optional, see below
              step_limit = optional, see below
              register = 'local', see below
              save_flux_data = False, see below
              ideal_water = False
              use_ode = False
            )
</code></pre>

<p>ref_time: will offset the time axis by the specified amount, when
             plotting the data, .i.e., the model time runs from to
             100, but you want to plot data as if where from 2000
             to 2100, you would specify a value of 2000. This is
             for display purposes only, and does not affect the
             model. Care must be taken that any external data
             references the model time domain, and not the display
             time.</p>

<p>display precision: affects the on-screen display of data. It is
                   also cutoff for the graphicak output. I.e., the
                   interval f the y-axis will not be smaller than
                   the display_precision.</p>

<p>m_type: enables or disables isotope calculation for the entire
        model.  The default value is "Not set" in this case
        isotopes will only be calculaten for reservoirs which set
        the isotope keyword. 'mass_only' 'both' will override the
        reservoir settings</p>

<p>register = local/None. If set to 'None' all objects are registered
           in the global namespace the default setting is local,
           i.e. all objects are registered in the model namespace.</p>

<p>save_flux_data: Normally, flux data is not stored. Set this to True
           for debugging puposes. Note, Fluxes with signals are always
           stored. You can also enable this option for inidividual
           connections (fluxes).</p>

<p>get_delta_values: Compute delta values as postprocessing step.</p>

<p>All of the above keyword values are available as variables with
Model_Name.keyword</p>

<p>The user facing methods of the model class are</p>

<ul>
<li>Model_Name.info()</li>
<li>Model_Name.save_data()</li>
<li>Model_Name.plot_data()</li>
<li>Model_Name.plot_reservoirs() takes an optional filename as argument</li>
<li>Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</li>
<li>Model_Name.save_state() Save the model state</li>
<li>Model_name.read_state() Initialize with a previous model state</li>
<li>Model_Name.run(), there are 2 optional arguments here, solver="hybrid"
 and solver = "numba". Both involve a 3 to 5 second overhead. The hybrid
 solver is compatible with all connection types, and about 3 times faster
 than the  regular solver. The numba solver is about 10 faster, but currently
 only supports a limited set of connection types.</li>
<li>Model_Name.list_species()</li>
<li>Model_name.flux_summary()</li>
<li>Model_Name.connection_summary()</li>
</ul>

<p>User facing variable are Model_Name.time which contains the time
axis.</p>

<p>Optional, you can provide the element keyword which will setup a
default set of Species for Carbon and Sulfur. In this case, there
is no need to define elements or species. The argument to this
keyword are either "Carbon", or "Sulfur" or both as a list
["Carbon", "Sulfur"].</p>

<p>Dealing with large datasets:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~</p>

<p>1) Limiting the size of the data which is being saved with save_data()</p>

<pre><code> number_of_datapoints = 100 will only write every nth data point to file.
                        where n = timesteps/ number_of_datapoints

 this defaults to 1000 until set explicitly.
</code></pre>

<p>2) Reducing the memory footprint</p>

<p>Models with a long runtime can easily exceed the available
computer memory, as much if it is goobled up storing the model
results. In this case, one can set the optional parameter</p>

<p>step_limit = 1E6</p>

<p>The above will limit the total number of iterations to 1E6, then
save the data up to this point, and then restart the
model. Subsequent results will be appended to the results.</p>

<p>Caveat Emptor: If your model uses a signal instance, all signal
data must fit into a single iteration set. At present, there is no
support for signals which extend beyond the step_limit.</p>

<p>In order to prevent the creation of massive datafiles, number_of_datapoints
defaults to 1000. Modify as needed.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#Model">esbmtk.esbmtk.Model</a></dt>
                                <dd id="Process.Model.__init__" class="function"><a href="esbmtk.html#Model.__init__">Model</a></dd>
                <dd id="Process.Model.info" class="function"><a href="esbmtk.html#Model.info">info</a></dd>
                <dd id="Process.Model.save_state" class="function"><a href="esbmtk.html#Model.save_state">save_state</a></dd>
                <dd id="Process.Model.save_data" class="function"><a href="esbmtk.html#Model.save_data">save_data</a></dd>
                <dd id="Process.Model.restart" class="function"><a href="esbmtk.html#Model.restart">restart</a></dd>
                <dd id="Process.Model.read_state" class="function"><a href="esbmtk.html#Model.read_state">read_state</a></dd>
                <dd id="Process.Model.merge_temp_results" class="function"><a href="esbmtk.html#Model.merge_temp_results">merge_temp_results</a></dd>
                <dd id="Process.Model.plot" class="function"><a href="esbmtk.html#Model.plot">plot</a></dd>
                <dd id="Process.Model.run" class="function"><a href="esbmtk.html#Model.run">run</a></dd>
                <dd id="Process.Model.get_delta_values" class="function"><a href="esbmtk.html#Model.get_delta_values">get_delta_values</a></dd>
                <dd id="Process.Model.sub_sample_data" class="function"><a href="esbmtk.html#Model.sub_sample_data">sub_sample_data</a></dd>
                <dd id="Process.Model.ode_solver" class="function"><a href="esbmtk.html#Model.ode_solver">ode_solver</a></dd>
                <dd id="Process.Model.list_species" class="function"><a href="esbmtk.html#Model.list_species">list_species</a></dd>
                <dd id="Process.Model.flux_summary" class="function"><a href="esbmtk.html#Model.flux_summary">flux_summary</a></dd>
                <dd id="Process.Model.connection_summary" class="function"><a href="esbmtk.html#Model.connection_summary">connection_summary</a></dd>
                <dd id="Process.Model.clear" class="function"><a href="esbmtk.html#Model.clear">clear</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Process.Model.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GenericFunction">
                                <div class="attr class">
        <a class="headerlink" href="#GenericFunction">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">GenericFunction</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">GenericFunction</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This Process class creates a GenericFunction instance which is</span>
<span class="sd">    typically used with the VirtualReservoir, and</span>
<span class="sd">    ExternalCode classes. This class is not user facing,</span>
<span class="sd">    please see the ExternalCode class docstring for the</span>
<span class="sd">    function template of a user provided function.</span>

<span class="sd">    see calc_carbonates in the carbonate chemistry for an example how</span>
<span class="sd">    to write a function for this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ReservoirGroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># list of allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;vr_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># required arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;input_data&quot;</span><span class="p">,</span> <span class="s2">&quot;vr_data&quot;</span><span class="p">,</span> <span class="s2">&quot;function_params&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>  <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we execute the user supplied function</span>
<span class="sd">        Where i = index of the current timestep</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This Process class creates a GenericFunction instance which is
typically used with the VirtualReservoir, and
ExternalCode classes. This class is not user facing,
please see the ExternalCode class docstring for the
function template of a user provided function.</p>

<p>see calc_carbonates in the carbonate chemistry for an example how
to write a function for this class.</p>
</div>


                            <div id="GenericFunction.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GenericFunction.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">GenericFunction</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ReservoirGroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># list of allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;vr_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_g&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># required arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;input_data&quot;</span><span class="p">,</span> <span class="s2">&quot;vr_data&quot;</span><span class="p">,</span> <span class="s2">&quot;function_params&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>  <span class="c1">#</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new process object with a given process type and options</p>
</div>


                            </div>
                            <div id="GenericFunction.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GenericFunction.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self) -&gt; tuple</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>return the data associated with this object</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="GenericFunction.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="GenericFunction.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="GenericFunction.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="GenericFunction.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="GenericFunction.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="GenericFunction.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="GenericFunction.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="GenericFunction.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AddSignal">
                                <div class="attr class">
        <a class="headerlink" href="#AddSignal">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">AddSignal</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">AddSignal</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process adds values to the current flux based on the values provided by the signal object.</span>
<span class="sd">    This class is typically invoked through the connector object</span>

<span class="sd">     Example::</span>

<span class="sd">     AddSignal(name = &quot;name&quot;,</span>
<span class="sd">               reservoir = upstream_reservoir_handle,</span>
<span class="sd">               flux = flux_to_act_upon,</span>
<span class="sd">               lt = flux with lookup values)</span>

<span class="sd">     where - the upstream reservoir is the reservoir the process belongs too</span>
<span class="sd">             the flux is the flux to act upon</span>
<span class="sd">             lt= contains the flux object we lookup from</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_with_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># use this when we do isotopes</span>
    <span class="k">def</span> <span class="nf">__add_with_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>

<span class="sd">        Note that the signal may also specify a delta value. Thus we</span>
<span class="sd">        need to</span>
<span class="sd">        1) get the mass of flux + signal</span>
<span class="sd">        2) add the delta of flux and signal</span>
<span class="sd">        3) calculate the new li and hi</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add signal mass to flux mass</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># flux rate</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># flux rate light isotope</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal mass</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal li</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="c1"># print(f&quot;Signal delta = {sd}&quot;)</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>
        <span class="c1"># print(f&quot;fa = {self.f.fa}\n&quot;)</span>

    <span class="k">def</span> <span class="nf">__add_with_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;same as above but use fa instead of flux data&quot;&quot;&quot;</span>

        <span class="c1"># add signal mass to flux mass</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># flux rate</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># flux rate light isotope</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal mass</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># signal li</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="c1"># set new flux rate</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_add_signal_fi</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flux_name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 4</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fm</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fl</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sm</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sd</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="c1"># set new flux rate</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_add_signal_fa</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flux_name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 2</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process adds values to the current flux based on the values provided by the signal object.
This class is typically invoked through the connector object</p>

<p>Example::</p>

<p>AddSignal(name = "name",
           reservoir = upstream_reservoir_handle,
           flux = flux_to_act_upon,
           lt = flux with lookup values)</p>

<p>where - the upstream reservoir is the reservoir the process belongs too
         the flux is the flux to act upon
         lt= contains the flux object we lookup from</p>
</div>


                            <div id="AddSignal.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#AddSignal.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">AddSignal</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add_with_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new process object with a given process type and options</p>
</div>


                            </div>
                            <div id="AddSignal.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#AddSignal.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="AddSignal.p_add_signal_fi" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#AddSignal.p_add_signal_fi">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_add_signal_fi</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fm</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># fl</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sm</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># sd</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="c1"># set new flux rate</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="AddSignal.p_add_signal_fa" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#AddSignal.p_add_signal_fa">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_add_signal_fa</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_add_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># get signal delta</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">sm</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="o">/</span> <span class="n">sl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="k">if</span> <span class="n">sm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="n">fm</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">+</span> <span class="n">sd</span> <span class="k">if</span> <span class="n">fm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="n">fm</span> <span class="o">+=</span> <span class="n">sm</span>  <span class="c1"># add signal mass</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">((</span><span class="n">fd</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="AddSignal.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="AddSignal.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="AddSignal.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="AddSignal.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="AddSignal.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="AddSignal.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="AddSignal.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="AddSignal.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SaveFluxData">
                                <div class="attr class">
        <a class="headerlink" href="#SaveFluxData">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SaveFluxData</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SaveFluxData</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This process stores the flux data from each iteration into a vector</span>
<span class="sd">    Example::</span>

<span class="sd">         SaveFluxData(name = &quot;Name&quot;,</span>
<span class="sd">                   flux = Flux Handle</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_save_flux</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 4 2</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_save_flux</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process stores the flux data from each iteration into a vector
Example::</p>

<pre><code> SaveFluxData(name = "Name",
           flux = Flux Handle
</code></pre>

<p>)</p>
</div>


                            <div id="SaveFluxData.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveFluxData.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SaveFluxData</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this Process</p>
</div>


                            </div>
                            <div id="SaveFluxData.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveFluxData.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_save_flux</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 4 2</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SaveFluxData.p_save_flux" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveFluxData.p_save_flux">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_save_flux</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_save_flux</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="SaveFluxData.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="SaveFluxData.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="SaveFluxData.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="SaveFluxData.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="SaveFluxData.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="SaveFluxData.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SaveFluxData.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SaveFluxData.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ScaleFlux">
                                <div class="attr class">
        <a class="headerlink" href="#ScaleFlux">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ScaleFlux</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ScaleFlux</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process scales the mass of a flux (m,l,h) relative to</span>
<span class="sd">    another flux. Delta is either taken from the upstream reservoir</span>
<span class="sd">    or set to a fixed value.  The scale factor &quot;scale&quot; and flux</span>
<span class="sd">    reference must be present when the object is being initalized</span>

<span class="sd">    Example::</span>
<span class="sd">         ScaleFlux(name = &quot;Name&quot;,</span>
<span class="sd">                   reservoir = reservoir_handle (upstream or downstream)</span>
<span class="sd">                   scale = 1</span>
<span class="sd">                   ref_flux = flux we use for scale</span>
<span class="sd">                   )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="s2">&quot;ref_reservoirs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;ref_flux&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify a value for ref_flux&quot;</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot; Decide how to calculate isotopes (if)</span>
<span class="sd">        If the connection specifies delta explicitly, this will</span>
<span class="sd">        override any settings in the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="c1"># delta explicitly provided</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="c1"># create stubs</span>
    <span class="k">def</span> <span class="nf">__with_source__</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the scale factor. This is typically done through the the</span>
<span class="sd">        model execute method.</span>
<span class="sd">        Note that this will use the mass of the flux we use for scaling, but that we will set the</span>
<span class="sd">        delta according to reservoir this flux derives from</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get reference flux</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;similar to with isotopes, but this time we take the</span>
<span class="sd">        isotope value of the source (which has no array, just a fixed</span>
<span class="sd">        value&quot;&quot;&quot;</span>

        <span class="c1"># get reference flux</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply the scale factor. This is typically done through the the</span>
<span class="sd">        model execute method.</span>
<span class="sd">        Note that this will use the mass of the reference object, but that we will set the</span>
<span class="sd">        delta according to the reservoir (or the flux?)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we need to decide between cases where the reservoir is an</span>
<span class="sd">        actual reservoir or just a source, since sources do not have</span>
<span class="sd">        arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2 Reference Flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 5 3 Upstream reservoir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 6 4 Upstream reservoir li</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 8 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 9 6</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_r</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_r</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is derived from upstream reservoir&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass upstream reservoir</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># li upstream reservoir</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is set to a fixed value&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># l/h ratio</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process scales the mass of a flux (m,l,h) relative to
another flux. Delta is either taken from the upstream reservoir
or set to a fixed value.  The scale factor "scale" and flux
reference must be present when the object is being initalized</p>

<p>Example::
     ScaleFlux(name = "Name",
               reservoir = reservoir_handle (upstream or downstream)
               scale = 1
               ref_flux = flux we use for scale
               )</p>
</div>


                            <div id="ScaleFlux.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleFlux.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ScaleFlux</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="s2">&quot;ref_reservoirs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;ref_flux&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify a value for ref_flux&quot;</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot; Decide how to calculate isotopes (if)</span>
<span class="sd">        If the connection specifies delta explicitly, this will</span>
<span class="sd">        override any settings in the source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="c1"># delta explicitly provided</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this Process</p>
</div>


                            </div>
                            <div id="ScaleFlux.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleFlux.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we need to decide between cases where the reservoir is an</span>
<span class="sd">        actual reservoir or just a source, since sources do not have</span>
<span class="sd">        arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2 Reference Flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 5 3 Upstream reservoir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 6 4 Upstream reservoir li</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 8 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 9 6</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_fd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_flux_r</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>we need to decide between cases where the reservoir is an
actual reservoir or just a source, since sources do not have
arrays</p>
</div>


                            </div>
                            <div id="ScaleFlux.p_scale_flux_r" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleFlux.p_scale_flux_r">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_scale_flux_r</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_r</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is derived from upstream reservoir&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass upstream reservoir</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># li upstream reservoir</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta is derived from upstream reservoir</p>
</div>


                            </div>
                            <div id="ScaleFlux.p_scale_flux_fd" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleFlux.p_scale_flux_fd">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_scale_flux_fd</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_flux_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta is set to a fixed value&quot;&quot;&quot;</span>

        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># l/h ratio</span>

        <span class="c1"># data</span>
        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># mass of reference flux</span>

        <span class="c1"># get the target isotope ratio based on upstream delta</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta is set to a fixed value</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="ScaleFlux.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="ScaleFlux.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="ScaleFlux.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="ScaleFlux.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="ScaleFlux.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="ScaleFlux.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ScaleFlux.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="ScaleFlux.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Fractionation">
                                <div class="attr class">
        <a class="headerlink" href="#Fractionation">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Fractionation</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Fractionation</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process offsets the isotopic ratio of the flux by a given</span>
<span class="sd">       delta value. In other words, we add a fractionation factor</span>

<span class="sd">    Example::</span>
<span class="sd">         Fractionation(name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir = upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle</span>
<span class="sd">                       alpha = 12 in permil (e.f)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="c1"># alpha is given in permil, but the fractionation routine expects</span>
        <span class="c1"># it as 1 + permil, i.e., 70 permil would 1.007</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set flux isotope masses based on fractionation factor</span>
<span class="sd">        relative to reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;self.f.m[i] =  {self.f.m[i]}&quot;)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alp</span>

            <span class="n">fl</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">rm</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fractionation</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 6 4</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alp</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_fractionation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># params</span>
        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># alpha</span>

        <span class="c1"># data</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir mass</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir light isotope</span>

        <span class="n">fl</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">rm</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process offsets the isotopic ratio of the flux by a given
   delta value. In other words, we add a fractionation factor</p>

<p>Example::
     Fractionation(name = "Name",
                   reservoir = upstream_reservoir_handle,
                   flux = flux handle
                   alpha = 12 in permil (e.f)</p>
</div>


                            <div id="Fractionation.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Fractionation.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Fractionation</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>
        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>

        <span class="c1"># alpha is given in permil, but the fractionation routine expects</span>
        <span class="c1"># it as 1 + permil, i.e., 70 permil would 1.007</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this Process</p>
</div>


                            </div>
                            <div id="Fractionation.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Fractionation.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fractionation</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 6 4</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alp</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Fractionation.p_fractionation" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Fractionation.p_fractionation">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_fractionation</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_fractionation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># params</span>
        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># alpha</span>

        <span class="c1"># data</span>
        <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir mass</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 4 reservoir light isotope</span>

        <span class="n">fl</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">*</span> <span class="n">fm</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">rm</span> <span class="o">+</span> <span class="n">rl</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="Fractionation.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="Fractionation.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="Fractionation.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="Fractionation.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="Fractionation.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="Fractionation.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Fractionation.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Fractionation.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="RateConstant">
                                <div class="attr class">
        <a class="headerlink" href="#RateConstant">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">RateConstant</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">RateConstant</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a wrapper for a variety of processes which depend on rate constants</span>
<span class="sd">    Please see the below class definitions for details on how to call them</span>
<span class="sd">    At present, the following processes are defined</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
            <span class="n">Sink</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Note that self.lkk values also need to be added to the lkk</span>
        <span class="c1"># list of the connector object.</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># update the allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_ref&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)],</span>
            <span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;liquid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;solubility&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;piston_velocity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;water_vapor_pressure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;seawaterconstants&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">SeawaterConstants</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;function_reference&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;f_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;pco2_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;280 ppm&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;ex&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="c1"># new required keywords</span>
        <span class="c1"># self.lrk.extend([[&quot;reservoir&quot;, &quot;atmosphere&quot;], [&quot;scale&quot;, &quot;k_value&quot;], &quot;register&quot;])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">elif</span> <span class="s2">&quot;gas_reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas_reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__misc_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="c1"># legacy variables</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span>
                <span class="c1"># print(f&quot;delta = {self.delta} setting c = {self.c}&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a wrapper for a variety of processes which depend on rate constants
Please see the below class definitions for details on how to call them
At present, the following processes are defined</p>
</div>


                            <div id="RateConstant.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#RateConstant.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">RateConstant</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
            <span class="n">Sink</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Note that self.lkk values also need to be added to the lkk</span>
        <span class="c1"># list of the connector object.</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>

        <span class="c1"># update the allowed keywords</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_ref&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)],</span>
            <span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;liquid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;solubility&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;piston_velocity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;water_vapor_pressure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
            <span class="s2">&quot;ref_species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;seawaterconstants&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">SeawaterConstants</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;function_reference&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;f_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;pco2_0&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;280 ppm&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;ex&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="c1"># new required keywords</span>
        <span class="c1"># self.lrk.extend([[&quot;reservoir&quot;, &quot;atmosphere&quot;], [&quot;scale&quot;, &quot;k_value&quot;], &quot;register&quot;])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">if</span> <span class="s2">&quot;reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">elif</span> <span class="s2">&quot;gas_reservoir&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas_reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__misc_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="c1"># legacy variables</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span>
                <span class="c1"># print(f&quot;delta = {self.delta} setting c = {self.c}&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this Process</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="RateConstant.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="RateConstant.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="RateConstant.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="RateConstant.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="RateConstant.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="RateConstant.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="RateConstant.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="RateConstant.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="weathering">
                                <div class="attr class">
        <a class="headerlink" href="#weathering">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">weathering</span><wbr>(<span class="base"><a href="#RateConstant">RateConstant</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">weathering</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process calculates the flux as a function of the upstream</span>
<span class="sd">     reservoir concentration C and a constant which describes thet</span>
<span class="sd">     strength of relation between the reservoir concentration and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = f_0 * (scale * C/pco2_0)**ncc</span>

<span class="sd">     where C denotes the concentration in the ustream reservoir, k is a</span>
<span class="sd">     constant. This process is typically called by the connector</span>
<span class="sd">     instance. However you can instantiate it manually as</span>

<span class="sd">     weathering(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir = upstream_reservoir_handle,</span>
<span class="sd">                       reservoir_ref = reference_reservoir (Atmosphere)</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       ex = exponent</span>
<span class="sd">                       pco2_0 = 280,</span>
<span class="sd">                       f_0 = 12 / 17e12</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">                       delta = 0,</span>

<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the flux relative to the pco2_0 concentration.</span>
<span class="sd">        The delta values are derived from either:</span>

<span class="sd">        - the upstream reservoir</span>
<span class="sd">        - the upstream source</span>
<span class="sd">        - set to a fixed value</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mf">1e-6</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="o">.</span><span class="n">magnitude</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;ppm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="c1"># if self.delta == &quot;None&quot; and  self.source.isotopes == False:</span>
        <span class="c1">#      self.fixed = True</span>
        <span class="c1"># delta provided explicitly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># source is Source and has delta</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_fixed_delta__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># source is reservoir</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># source is source, has no delta, and delta is not provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_weathering_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;data depends on whether upstream, is source or</span>
<span class="sd">        reservoir/gas-reservoir&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">),</span>  <span class="c1"># 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">),</span>  <span class="c1"># 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">),</span>  <span class="c1"># 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>  <span class="c1"># 5</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value depends on upstream reservoir&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># data</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value is fixed&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process calculates the flux as a function of the upstream
 reservoir concentration C and a constant which describes thet
 strength of relation between the reservoir concentration and
 the flux scaling</p>

<p>F = f_0 * (scale * C/pco2_0)**ncc</p>

<p>where C denotes the concentration in the ustream reservoir, k is a
 constant. This process is typically called by the connector
 instance. However you can instantiate it manually as</p>

<p>weathering(
                   name = "Name",
                   reservoir = upstream_reservoir_handle,
                   reservoir_ref = reference_reservoir (Atmosphere)
                   flux = flux handle,
                   ex = exponent
                   pco2_0 = 280,
                   f_0 = 12 / 17e12
                   Scale =  1000,
                   delta = 0,</p>

<p>)</p>
</div>


                            <div id="weathering.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#weathering.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;data depends on whether upstream, is source or</span>
<span class="sd">        reservoir/gas-reservoir&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_ref</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_0</span><span class="p">),</span>  <span class="c1"># 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pco2_0</span><span class="p">),</span>  <span class="c1"># 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex</span><span class="p">),</span>  <span class="c1"># 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>  <span class="c1"># 5</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>data depends on whether upstream, is source or
reservoir/gas-reservoir</p>
</div>


                            </div>
                            <div id="weathering.p_weathering" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#weathering.p_weathering">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_weathering</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value depends on upstream reservoir&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># data</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta value depends on upstream reservoir</p>
</div>


                            </div>
                            <div id="weathering.p_weathering_fd" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#weathering.p_weathering_fd">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_weathering_fd</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_weathering_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta value is fixed&quot;&quot;&quot;</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pco2_0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ex</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">f_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">pco2_0</span><span class="p">)</span> <span class="o">**</span> <span class="n">ex</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cr</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta value is fixed</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RateConstant">RateConstant</a></dt>
                                <dd id="weathering.__init__" class="function"><a href="#RateConstant.__init__">RateConstant</a></dd>

            </div>
            <div><dt><a href="#Process">Process</a></dt>
                                <dd id="weathering.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="weathering.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="weathering.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="weathering.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="weathering.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="weathering.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="weathering.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="weathering.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MultiplySignal">
                                <div class="attr class">
        <a class="headerlink" href="#MultiplySignal">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">MultiplySignal</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MultiplySignal</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process mulitplies a given flux with the the data in the</span>
<span class="sd">    signal.  This class is typically invoked through the connector</span>
<span class="sd">    object: Note that this process will not modify the delta value of</span>
<span class="sd">    a given flux.  If you needto vary the delta value it is best to</span>
<span class="sd">    add a second signal which uses the add signal type.</span>

<span class="sd">     Example::</span>
<span class="sd">     MultiplySignal(name = &quot;name&quot;,</span>
<span class="sd">               reservoir = upstream_reservoir_handle,</span>
<span class="sd">               flux = flux_to_act_upon,</span>
<span class="sd">               lt = flux with lookup values)</span>

<span class="sd">     where the upstream reservoir is the reservoir the process belongs</span>
<span class="sd">             too the flux is the flux to act upon lt= contains the</span>
<span class="sd">             flux object we lookup from</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide whichh call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>

        <span class="c1"># default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_with_flux_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># use this when we do isotopes</span>
    <span class="k">def</span> <span class="nf">__multiply_with_flux_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># multiply flux mass with signal</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="c1"># h = self.f.h[i] * c</span>
        <span class="c1"># d = self.f.d[i]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;multiply fa </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="si">}</span><span class="s2">, f. = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">, c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__multiply_with_flux_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Each process is associated with a flux (self.f). Here we replace</span>
<span class="sd">        the flux value with the value from the signal object which</span>
<span class="sd">        we use as a lookup-table (self.lt)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># multiply flux mass with signal</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fi__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_multiply_signal_fi</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="c1"># self.lt.l,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 3</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__get_process_args_fa__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_multiply_signal_fa</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lt</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 1</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># m</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># l</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process mulitplies a given flux with the the data in the
signal.  This class is typically invoked through the connector
object: Note that this process will not modify the delta value of
a given flux.  If you needto vary the delta value it is best to
add a second signal which uses the add signal type.</p>

<p>Example::
 MultiplySignal(name = "name",
           reservoir = upstream_reservoir_handle,
           flux = flux_to_act_upon,
           lt = flux with lookup values)</p>

<p>where the upstream reservoir is the reservoir the process belongs
         too the flux is the flux to act upon lt= contains the
         flux object we lookup from</p>
</div>


                            <div id="MultiplySignal.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MultiplySignal.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">MultiplySignal</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new process object with a given process type and options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>  <span class="c1"># default kwargs names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">])</span>  <span class="c1"># new required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide whichh call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>

        <span class="c1"># default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__multiply_with_flux_fi__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args_fi__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new process object with a given process type and options</p>
</div>


                            </div>
                            <div id="MultiplySignal.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MultiplySignal.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_process_args__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="MultiplySignal.p_multiply_signal_fi" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MultiplySignal.p_multiply_signal_fi">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_multiply_signal_fi</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="MultiplySignal.p_multiply_signal_fa" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#MultiplySignal.p_multiply_signal_fa">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_multiply_signal_fa</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_multiply_signal_fa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># m</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>  <span class="c1"># l</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="MultiplySignal.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="MultiplySignal.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="MultiplySignal.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="MultiplySignal.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="MultiplySignal.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="MultiplySignal.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="MultiplySignal.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="MultiplySignal.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="VarDeltaOut">
                                <div class="attr class">
        <a class="headerlink" href="#VarDeltaOut">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">VarDeltaOut</span><wbr>(<span class="base"><a href="#Process">Process</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">VarDeltaOut</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unlike a passive flux, this process sets the flux istope ratio</span>
<span class="sd">    equal to the isotopic ratio of the reservoir. The</span>
<span class="sd">    init and register methods are inherited from the process</span>
<span class="sd">    class.</span>
<span class="sd">    VarDeltaOut(name = &quot;name&quot;,</span>
<span class="sd">                reservoir = upstream_reservoir_handle,</span>
<span class="sd">                flux = flux handle,</span>
<span class="sd">                rate = rate,)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">])</span>  <span class="c1"># required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="c1"># print(</span>
            <span class="c1">#    f&quot;vardeltaout with isotopes for {self.reservoir.register.name}.{self.reservoir.name}&quot;</span>
            <span class="c1"># )</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using reservoir&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_reservoir__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using Source&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_source__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, reservoir must be of type Source or Reservoir, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>

    <span class="c1"># setup a placeholder call function</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__with_isotopes_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we re-balance the flux. This code will be called by the</span>
<span class="sd">        apply_flux_modifier method of a reservoir which itself is</span>
<span class="sd">        called by the model execute method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="c1"># if upstream is a source, we only have a single delta value</span>
        <span class="c1"># so we need to patch this. Maybe this should move to source?</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_vardeltaout</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="c1"># self.flux.l,  # 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="c1"># delta,  # 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 5 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_vardeltaout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>

        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir mass</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir l</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes_source__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;If the source of the flux is a source, there is only a single delta value.</span>
<span class="sd">        Changes to the flux delta are applied through the Signal class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Here we re-balance the flux. This code will be called by the</span>
<span class="sd">        apply_flux_modifier method of a reservoir which itself is</span>
<span class="sd">        called by the model execute method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;vardeltaout w/o isotopes is not defined&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Unlike a passive flux, this process sets the flux istope ratio
equal to the isotopic ratio of the reservoir. The
init and register methods are inherited from the process
class.
VarDeltaOut(name = "name",
            reservoir = upstream_reservoir_handle,
            flux = flux handle,
            rate = rate,)</p>
</div>


                            <div id="VarDeltaOut.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#VarDeltaOut.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">VarDeltaOut</span><span class="signature">(**kwargs: dict[str, any])</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this Process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get default names and update list for this Process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__defaultnames__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">])</span>  <span class="c1"># required keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">()</span>  <span class="c1"># do some housekeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which call function to use</span>
        <span class="c1"># if self.mo.m_type == &quot;both&quot;:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="c1"># print(</span>
            <span class="c1">#    f&quot;vardeltaout with isotopes for {self.reservoir.register.name}.{self.reservoir.name}&quot;</span>
            <span class="c1"># )</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using reservoir&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_reservoir__</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
                <span class="c1"># print(&quot;Using Source&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_isotopes_source__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, reservoir must be of type Source or Reservoir, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__without_isotopes__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this Process</p>
</div>


                            </div>
                            <div id="VarDeltaOut.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#VarDeltaOut.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="c1"># if upstream is a source, we only have a single delta value</span>
        <span class="c1"># so we need to patch this. Maybe this should move to source?</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_vardeltaout</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="c1"># self.flux.l,  # 1</span>
                <span class="c1"># self.flux.h,  # 2</span>
                <span class="c1"># self.flux.d,  # 3</span>
                <span class="c1"># delta,  # 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 5 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>Provide the data structure which needs to be passed to the numba solver</p>
</div>


                            </div>
                            <div id="VarDeltaOut.p_vardeltaout" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#VarDeltaOut.p_vardeltaout">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_vardeltaout</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_vardeltaout</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>

        <span class="n">mf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># flux mass</span>
        <span class="n">mr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir mass</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># reservoir l</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">/</span> <span class="p">(</span><span class="n">mr</span> <span class="o">-</span> <span class="n">lr</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">,</span> <span class="n">mf</span> <span class="o">*</span> <span class="n">c</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Process">Process</a></dt>
                                <dd id="VarDeltaOut.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="VarDeltaOut.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="VarDeltaOut.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="VarDeltaOut.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="VarDeltaOut.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="VarDeltaOut.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="VarDeltaOut.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="VarDeltaOut.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ScaleRelativeToMass">
                                <div class="attr class">
        <a class="headerlink" href="#ScaleRelativeToMass">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ScaleRelativeToMass</span><wbr>(<span class="base"><a href="#RateConstant">RateConstant</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ScaleRelativeToMass</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process scales the flux as a function of the upstream</span>
<span class="sd">     reservoir Mass M and a constant which describes the</span>
<span class="sd">     strength of relation between the reservoir mass and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = F0 *  M * k</span>

<span class="sd">     where M denotes the mass in the ustream reservoir, k is a</span>
<span class="sd">     constant and F0 is the initial unscaled flux. This process is</span>
<span class="sd">     typically called by the connector instance. However you can</span>
<span class="sd">     instantiate it manually as</span>

<span class="sd">     Note that we scale the flux, rather than compute the flux!</span>

<span class="sd">     This is faster than setting a new flux, computing the isotope</span>
<span class="sd">     ratio and setting delta. So you either have to set the initial</span>
<span class="sd">     flux F0 to 1, or calculate the scale accordingly</span>

<span class="sd">     ScaleRelativeToMass(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir= upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this will be called by the Model.run() method</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="c1"># d: float = self.reservoir.d[i - 1]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_mass</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 7 4</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_mass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>

        <span class="c1"># data</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># rd = data[6][i - 1]</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># new flux</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># d: float = data[1][i - 1]  # flux delta</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process scales the flux as a function of the upstream
 reservoir Mass M and a constant which describes the
 strength of relation between the reservoir mass and
 the flux scaling</p>

<p>F = F0 *  M * k</p>

<p>where M denotes the mass in the ustream reservoir, k is a
 constant and F0 is the initial unscaled flux. This process is
 typically called by the connector instance. However you can
 instantiate it manually as</p>

<p>Note that we scale the flux, rather than compute the flux!</p>

<p>This is faster than setting a new flux, computing the isotope
 ratio and setting delta. So you either have to set the initial
 flux F0 to 1, or calculate the scale accordingly</p>

<p>ScaleRelativeToMass(
                   name = "Name",
                   reservoir= upstream_reservoir_handle,
                   flux = flux handle,
                   Scale =  1000,
)</p>
</div>


                            <div id="ScaleRelativeToMass.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleRelativeToMass.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_mass</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 4 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 5 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 7 4</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>return the data associated with this object</p>
</div>


                            </div>
                            <div id="ScaleRelativeToMass.p_scale_relative_to_mass" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleRelativeToMass.p_scale_relative_to_mass">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_scale_relative_to_mass</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_mass</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># concentration times scale factor</span>
        <span class="c1"># params</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>

        <span class="c1"># data</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># rd = data[6][i - 1]</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">*</span> <span class="n">s</span>  <span class="c1"># new flux</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
        <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># d: float = data[1][i - 1]  # flux delta</span>

        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RateConstant">RateConstant</a></dt>
                                <dd id="ScaleRelativeToMass.__init__" class="function"><a href="#RateConstant.__init__">RateConstant</a></dd>

            </div>
            <div><dt><a href="#Process">Process</a></dt>
                                <dd id="ScaleRelativeToMass.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="ScaleRelativeToMass.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="ScaleRelativeToMass.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="ScaleRelativeToMass.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="ScaleRelativeToMass.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="ScaleRelativeToMass.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ScaleRelativeToMass.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="ScaleRelativeToMass.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GasExchange">
                                <div class="attr class">
        <a class="headerlink" href="#GasExchange">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">GasExchange</span><wbr>(<span class="base"><a href="#RateConstant">RateConstant</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">GasExchange</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    GasExchange(</span>
<span class="sd">          gas =GasReservoir, #</span>
<span class="sd">          liquid = Reservoir, #,</span>
<span class="sd">          ref_species = array of concentrations #</span>
<span class="sd">          solubility=Atmosphere.swc.SA_co2 [mol/(m^3 atm)],</span>
<span class="sd">          area = area, # m^2</span>
<span class="sd">          piston_velocity = m/year</span>
<span class="sd">          seawaterconstants = Ocean.swc</span>
<span class="sd">          water_vapor_pressure=Ocean.swc.p_H2O,</span>
<span class="sd">    )</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># redefine misc_init which is being called by post-init</span>
    <span class="k">def</span> <span class="nf">__misc_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up input variables&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">p_H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_dg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawaterconstants</span><span class="o">.</span><span class="n">a_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">volume</span>

    <span class="k">def</span> <span class="nf">ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># area in m^2  # Atmosphere  # p_H2O  # SA_co2 = mol/(m^3 atm)  # [CO2]aq mol</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># set flux</span>
        <span class="c1"># note that the sink delta is co2aq as returned by the carbonate VR</span>
        <span class="c1"># this equation is for mmol but esbmtk uses mol, so we need to</span>
        <span class="c1"># multiply by 1E3</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span>  <span class="c1"># area in m^2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Atmosphere</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>  <span class="c1"># SA_co2 = mol/(m^3 atm)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># [CO2]aq mol</span>
        <span class="p">)</span>
        <span class="c1"># print(self.gas.c[i - 1])</span>

        <span class="c1"># changes in the mass of CO2 also affect changes in the total mass</span>
        <span class="c1"># of the atmosphere. So we need to update the reservoir volume</span>
        <span class="c1"># variable which we use the store the total atmospheric mass</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.gas.v[i] = self.gas.v[i - 1] + f * self.gas.mo.dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In the following I assume near neutral pH between 7 and 9, so that</span>
<span class="sd">        the isotopic composition of HCO3- is approximately equal to the isotopic</span>
<span class="sd">        ratio of DIC. The isotopic ratio of [CO2]aq can then be obtained from DIC via</span>
<span class="sd">        swc.e_db (swc.a_db)</span>

<span class="sd">        The fractionation factor subscripts denote the following:</span>

<span class="sd">        g = gaseous</span>
<span class="sd">        d = dissolved</span>
<span class="sd">        b = bicarbonate ion</span>
<span class="sd">        c = carbonate ion</span>

<span class="sd">        a_db is thus the fractionation factor between dissolved CO2aq and HCO3-</span>
<span class="sd">        and a_dg between CO2aq and CO2g</span>

<span class="sd">        ref_species = DIC.cs.CO2aq</span>
<span class="sd">        liquid.m = DIC.m (used to get the isotope ratio)</span>

<span class="sd">        gas.m = mass of CO2</span>
<span class="sd">        gas.l = mass of 12CO2</span>
<span class="sd">        gas.c = CO2 concentration</span>
<span class="sd">        gas.v = total mass of atmosphere</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># equilibrium concentration of CO2 in water based on pCO2</span>
        <span class="n">eco2_at</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># p Atmosphere</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>
        <span class="p">)</span>
        <span class="c1"># equilibrium concentration of CO2 in water based on CO2aq</span>
        <span class="n">eco2_aq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1">#  flux</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at</span> <span class="o">-</span> <span class="n">eco2_aq</span><span class="p">)</span>

        <span class="n">c13g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c13aq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># get 13C CO2 equlibrium concentration  CO2 in water based on pCO2</span>
        <span class="n">eco2_at_13</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">c13g</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span>  <span class="c1"># p_H2O</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span>
        <span class="p">)</span>

        <span class="c1"># get 13C equilibrium  CO2 in water based on DIC m &amp; l</span>
        <span class="n">eco2_aq_13</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_db</span> <span class="o">*</span> <span class="n">eco2_aq</span> <span class="o">*</span> <span class="n">c13aq</span>

        <span class="c1"># 13C flux</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_u</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at_13</span> <span class="o">-</span> <span class="n">eco2_aq_13</span><span class="p">)</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f13</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        not working, see note below</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>
        <span class="c1"># print()</span>

    <span class="k">def</span> <span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do some housekeeping for the process class&quot;&quot;&quot;</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_gas_exchange</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">,</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>  <span class="c1"># 3 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_u</span><span class="p">),</span>  <span class="c1"># 4 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span><span class="p">),</span>  <span class="c1"># 5 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_db</span><span class="p">),</span>  <span class="c1"># 6 5</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_gas_exchange</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;the below equation moved as many constants as possible</span>
<span class="sd">        outside of the function compared to the</span>
<span class="sd">        __with/without_isotopes__ method(s). See the</span>
<span class="sd">        __get_process_args__ method for details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">SA</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># solubility as  (1 - pH2O) * S</span>
        <span class="n">gv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># gas volume</span>
        <span class="n">au</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">dg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1">#</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in liquid</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in liquid_reservoir</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in gas reservoir</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in gas reservoir</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentration in gas reservoir</span>
        <span class="n">gv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># total mass of atmosphere</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentrartion of reference species in liquid_reservoir</span>
        <span class="n">gh</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">-</span> <span class="n">gl</span>  <span class="c1"># mass of heavy isotope in gas reservoir</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="n">lm</span> <span class="o">-</span> <span class="n">ll</span>  <span class="c1"># mass of heavy isotope in liquid reservoir</span>

        <span class="c1"># equilibrium concentration of CO2 in water based on pCO2</span>
        <span class="n">eco2_at</span> <span class="o">=</span> <span class="n">gc</span> <span class="o">*</span> <span class="n">SA</span>  <span class="c1"># p Atmosphere  # p_H2O</span>
        <span class="c1"># equilibrium concentration of CO2 in water based on CO2aq</span>
        <span class="n">eco2_aq</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at</span> <span class="o">-</span> <span class="n">eco2_aq</span><span class="p">)</span>
        <span class="c1"># get 13C CO2 equlibrium concentration</span>
        <span class="n">eco2_at_13</span> <span class="o">=</span> <span class="n">gh</span> <span class="o">/</span> <span class="n">gv</span> <span class="o">*</span> <span class="n">SA</span> <span class="o">*</span> <span class="n">dg</span>  <span class="c1"># p_H2O</span>
        <span class="c1"># get 13C in CO2aq</span>
        <span class="n">eco2_aq_13</span> <span class="o">=</span> <span class="n">db</span> <span class="o">*</span> <span class="n">eco2_aq</span> <span class="o">*</span> <span class="n">lh</span> <span class="o">/</span> <span class="n">lm</span>
        <span class="c1"># flux od 13C</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">au</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at_13</span> <span class="o">-</span> <span class="n">eco2_aq_13</span><span class="p">)</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f13</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>  <span class="c1"># fa</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        This is currently not working, as the total mass increases faster</span>
<span class="sd">        than the species mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data[6][i] = data[6][i - 1] + f * dt * -1</span>
</pre></div>

        </details>

            <div class="docstring"><p>GasExchange(
      gas =GasReservoir, #
      liquid = Reservoir, #,
      ref_species = array of concentrations #
      solubility=Atmosphere.swc.SA_co2 [mol/(m^3 atm)],
      area = area, # m^2
      piston_velocity = m/year
      seawaterconstants = Ocean.swc
      water_vapor_pressure=Ocean.swc.p_H2O,
)</p>
</div>


                            <div id="GasExchange.ode" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GasExchange.ode">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ode</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># area in m^2  # Atmosphere  # p_H2O  # SA_co2 = mol/(m^3 atm)  # [CO2]aq mol</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="GasExchange.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GasExchange.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the data associated with this object&quot;&quot;&quot;</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_gas_exchange</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">liquid</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 6</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_species</span><span class="p">,</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>  <span class="c1"># 0</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solubility</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_H2O</span><span class="p">)),</span>  <span class="c1"># 1</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>  <span class="c1"># 3 2</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_u</span><span class="p">),</span>  <span class="c1"># 4 3</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_dg</span><span class="p">),</span>  <span class="c1"># 5 4</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_db</span><span class="p">),</span>  <span class="c1"># 6 5</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>  <span class="c1"># 7</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>return the data associated with this object</p>
</div>


                            </div>
                            <div id="GasExchange.p_gas_exchange" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GasExchange.p_gas_exchange">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_gas_exchange</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_gas_exchange</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;the below equation moved as many constants as possible</span>
<span class="sd">        outside of the function compared to the</span>
<span class="sd">        __with/without_isotopes__ method(s). See the</span>
<span class="sd">        __get_process_args__ method for details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale</span>
        <span class="n">SA</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># solubility as  (1 - pH2O) * S</span>
        <span class="n">gv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># gas volume</span>
        <span class="n">au</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">dg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">#</span>
        <span class="n">db</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1">#</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in liquid</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in liquid_reservoir</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass in gas reservoir</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># mass of light isotope in gas reservoir</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentration in gas reservoir</span>
        <span class="n">gv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># total mass of atmosphere</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># concentrartion of reference species in liquid_reservoir</span>
        <span class="n">gh</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">-</span> <span class="n">gl</span>  <span class="c1"># mass of heavy isotope in gas reservoir</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="n">lm</span> <span class="o">-</span> <span class="n">ll</span>  <span class="c1"># mass of heavy isotope in liquid reservoir</span>

        <span class="c1"># equilibrium concentration of CO2 in water based on pCO2</span>
        <span class="n">eco2_at</span> <span class="o">=</span> <span class="n">gc</span> <span class="o">*</span> <span class="n">SA</span>  <span class="c1"># p Atmosphere  # p_H2O</span>
        <span class="c1"># equilibrium concentration of CO2 in water based on CO2aq</span>
        <span class="n">eco2_aq</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at</span> <span class="o">-</span> <span class="n">eco2_aq</span><span class="p">)</span>
        <span class="c1"># get 13C CO2 equlibrium concentration</span>
        <span class="n">eco2_at_13</span> <span class="o">=</span> <span class="n">gh</span> <span class="o">/</span> <span class="n">gv</span> <span class="o">*</span> <span class="n">SA</span> <span class="o">*</span> <span class="n">dg</span>  <span class="c1"># p_H2O</span>
        <span class="c1"># get 13C in CO2aq</span>
        <span class="n">eco2_aq_13</span> <span class="o">=</span> <span class="n">db</span> <span class="o">*</span> <span class="n">eco2_aq</span> <span class="o">*</span> <span class="n">lh</span> <span class="o">/</span> <span class="n">lm</span>
        <span class="c1"># flux od 13C</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">au</span> <span class="o">*</span> <span class="p">(</span><span class="n">eco2_at_13</span> <span class="o">-</span> <span class="n">eco2_aq_13</span><span class="p">)</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f13</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">f12</span><span class="p">]</span>  <span class="c1"># fa</span>
        <span class="sd">&quot;&quot;&quot;The solver will use f and f12 to update mass, light</span>
<span class="sd">        isotope and concentration values in the Gas</span>
<span class="sd">        reservoir. However, Gas reservoirs track total gas pressure</span>
<span class="sd">        in the volume variable. This will not be updated by the</span>
<span class="sd">        solver. So we need to do it ourseleves</span>

<span class="sd">        This is currently not working, as the total mass increases faster</span>
<span class="sd">        than the species mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data[6][i] = data[6][i - 1] + f * dt * -1</span>
</pre></div>

        </details>

            <div class="docstring"><p>the below equation moved as many constants as possible
outside of the function compared to the
__with/without_isotopes__ method(s). See the
__get_process_args__ method for details</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RateConstant">RateConstant</a></dt>
                                <dd id="GasExchange.__init__" class="function"><a href="#RateConstant.__init__">RateConstant</a></dd>

            </div>
            <div><dt><a href="#Process">Process</a></dt>
                                <dd id="GasExchange.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="GasExchange.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="GasExchange.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="GasExchange.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="GasExchange.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="GasExchange.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="GasExchange.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="GasExchange.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ScaleRelativeToConcentration">
                                <div class="attr class">
        <a class="headerlink" href="#ScaleRelativeToConcentration">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ScaleRelativeToConcentration</span><wbr>(<span class="base"><a href="#RateConstant">RateConstant</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ScaleRelativeToConcentration</span><span class="p">(</span><span class="n">RateConstant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This process calculates the flux as a function of the upstream</span>
<span class="sd">     reservoir concentration C and a constant which describes thet</span>
<span class="sd">     strength of relation between the reservoir concentration and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = C * k</span>

<span class="sd">     where C denotes the concentration in the ustream reservoir, k is a</span>
<span class="sd">     constant. This process is typically called by the connector</span>
<span class="sd">     instance. However you can instantiate it manually as</span>

<span class="sd">     ScaleRelativeToConcentration(</span>
<span class="sd">                       name = &quot;Name&quot;,</span>
<span class="sd">                       reservoir= upstream_reservoir_handle,</span>
<span class="sd">                       flux = flux handle,</span>
<span class="sd">                       Scale =  1000,</span>
<span class="sd">                       delta = &quot;None&quot;,</span>
<span class="sd">    )</span>

<span class="sd">    If delta is given the fluxes uses a ficed delta, If not it uses</span>
<span class="sd">    the upestream delta</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="c1"># convert to concentration</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of self.reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__with_fixed_delta__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C = M/V so we express this as relative to mass which allows us to</span>
<span class="sd">        use the isotope data.</span>

<span class="sd">        The below calculates the flux as function of self.reservoir concentration,</span>
<span class="sd">        rather than scaling the flux.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># otherwise there is no flux</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If no delta provided, use upstream reservoir ratios</span>
<span class="sd">        Otherwise, use a fixed ratio</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;scale relative to concentrations is undefined for Source-type&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.m = {type(self.reservoir.m)}&quot;)</span>
        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.l = {type(self.reservoir.l)}\n&quot;)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0 6 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1 7 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 2 8 5</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends on upstream delta&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>
        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res li</span>

            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends fixed value&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>

        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># isotope ratio</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This process calculates the flux as a function of the upstream
 reservoir concentration C and a constant which describes thet
 strength of relation between the reservoir concentration and
 the flux scaling</p>

<p>F = C * k</p>

<p>where C denotes the concentration in the ustream reservoir, k is a
 constant. This process is typically called by the connector
 instance. However you can instantiate it manually as</p>

<p>ScaleRelativeToConcentration(
                   name = "Name",
                   reservoir= upstream_reservoir_handle,
                   flux = flux handle,
                   Scale =  1000,
                   delta = "None",
)</p>

<p>If delta is given the fluxes uses a ficed delta, If not it uses
the upestream delta</p>
</div>


                            <div id="ScaleRelativeToConcentration.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleRelativeToConcentration.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If no delta provided, use upstream reservoir ratios</span>
<span class="sd">        Otherwise, use a fixed ratio</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;scale relative to concentrations is undefined for Source-type&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_scale_relative_to_concentration_fd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.m = {type(self.reservoir.m)}&quot;)</span>
        <span class="c1"># print(f&quot;type of {self.reservoir.full_name}.l = {type(self.reservoir.l)}\n&quot;)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0 6 3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1 7 4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 2 8 5</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">volume</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>If no delta provided, use upstream reservoir ratios
Otherwise, use a fixed ratio</p>
</div>


                            </div>
                            <div id="ScaleRelativeToConcentration.p_scale_relative_to_concentration" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleRelativeToConcentration.p_scale_relative_to_concentration">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_scale_relative_to_concentration</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends on upstream delta&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>
        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">rl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res li</span>

            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rl</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span> <span class="o">-</span> <span class="n">rl</span><span class="p">)</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta depends on upstream delta</p>
</div>


                            </div>
                            <div id="ScaleRelativeToConcentration.p_scale_relative_to_concentration_fd" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ScaleRelativeToConcentration.p_scale_relative_to_concentration_fd">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>
        <div class="decorator">@njit(fastmath=True, error_model=&#39;numpy&#39;)</div>

            <span class="def">def</span>
            <span class="name">p_scale_relative_to_concentration_fd</span><span class="signature">(data, params, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">p_scale_relative_to_concentration_fd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delta depends fixed value&quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># res mass</span>

        <span class="k">if</span> <span class="n">rm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># params</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># scale factor</span>
            <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># res volume</span>
            <span class="n">fm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rm</span> <span class="o">/</span> <span class="n">v</span> <span class="o">*</span> <span class="n">s</span>
            <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># isotope ratio</span>
            <span class="n">fl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fm</span> <span class="o">*</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="p">,</span> <span class="n">fl</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delta depends fixed value</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RateConstant">RateConstant</a></dt>
                                <dd id="ScaleRelativeToConcentration.__init__" class="function"><a href="#RateConstant.__init__">RateConstant</a></dd>

            </div>
            <div><dt><a href="#Process">Process</a></dt>
                                <dd id="ScaleRelativeToConcentration.show_figure" class="function"><a href="#Process.show_figure">show_figure</a></dd>
                <dd id="ScaleRelativeToConcentration.Source" class="class"><a href="#Process.Source">Source</a></dd>
                <dd id="ScaleRelativeToConcentration.Reservoir" class="class"><a href="#Process.Reservoir">Reservoir</a></dd>
                <dd id="ScaleRelativeToConcentration.Sink" class="class"><a href="#Process.Sink">Sink</a></dd>
                <dd id="ScaleRelativeToConcentration.Flux" class="class"><a href="#Process.Flux">Flux</a></dd>
                <dd id="ScaleRelativeToConcentration.Model" class="class"><a href="#Process.Model">Model</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ScaleRelativeToConcentration.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="ScaleRelativeToConcentration.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>