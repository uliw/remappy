<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.0.0"/>
    <title>esbmtk.utility_functions API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(:first-of-type){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section:first-of-type details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;esbmtk</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#find_matching_strings">find_matching_strings</a>
            </li>
            <li>
                    <a class="function" href="#insert_into_namespace">insert_into_namespace</a>
            </li>
            <li>
                    <a class="function" href="#add_to">add_to</a>
            </li>
            <li>
                    <a class="function" href="#get_plot_layout">get_plot_layout</a>
            </li>
            <li>
                    <a class="function" href="#plot_geometry">plot_geometry</a>
            </li>
            <li>
                    <a class="function" href="#list_fluxes">list_fluxes</a>
            </li>
            <li>
                    <a class="function" href="#show_data">show_data</a>
            </li>
            <li>
                    <a class="function" href="#set_y_limits">set_y_limits</a>
            </li>
            <li>
                    <a class="function" href="#is_name_in_list">is_name_in_list</a>
            </li>
            <li>
                    <a class="function" href="#get_object_from_list">get_object_from_list</a>
            </li>
            <li>
                    <a class="function" href="#sort_by_type">sort_by_type</a>
            </li>
            <li>
                    <a class="function" href="#get_object_handle">get_object_handle</a>
            </li>
            <li>
                    <a class="function" href="#split_key">split_key</a>
            </li>
            <li>
                    <a class="function" href="#make_dict">make_dict</a>
            </li>
            <li>
                    <a class="function" href="#get_typed_list">get_typed_list</a>
            </li>
            <li>
                    <a class="function" href="#create_reservoirs">create_reservoirs</a>
            </li>
            <li>
                    <a class="function" href="#build_concentration_dicts">build_concentration_dicts</a>
            </li>
            <li>
                    <a class="function" href="#calc_volumes">calc_volumes</a>
            </li>
            <li>
                    <a class="function" href="#get_longest_dict_entry">get_longest_dict_entry</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_lists">convert_to_lists</a>
            </li>
            <li>
                    <a class="function" href="#get_sub_key">get_sub_key</a>
            </li>
            <li>
                    <a class="function" href="#expand_dict">expand_dict</a>
            </li>
            <li>
                    <a class="function" href="#create_bulk_connections">create_bulk_connections</a>
            </li>
            <li>
                    <a class="function" href="#create_connection">create_connection</a>
            </li>
            <li>
                    <a class="function" href="#get_name_only">get_name_only</a>
            </li>
            <li>
                    <a class="function" href="#get_simple_list">get_simple_list</a>
            </li>
            <li>
                    <a class="function" href="#show_dict">show_dict</a>
            </li>
            <li>
                    <a class="function" href="#find_matching_fluxes">find_matching_fluxes</a>
            </li>
            <li>
                    <a class="function" href="#reverse_key">reverse_key</a>
            </li>
            <li>
                    <a class="function" href="#get_connection_keys">get_connection_keys</a>
            </li>
            <li>
                    <a class="function" href="#gen_dict_entries">gen_dict_entries</a>
            </li>
            <li>
                    <a class="function" href="#build_ct_dict">build_ct_dict</a>
            </li>
            <li>
                    <a class="function" href="#get_string_between_brackets">get_string_between_brackets</a>
            </li>
            <li>
                    <a class="function" href="#check_for_quantity">check_for_quantity</a>
            </li>
            <li>
                    <a class="function" href="#map_units">map_units</a>
            </li>
            <li>
                    <a class="function" href="#add_carbonate_system_1">add_carbonate_system_1</a>
            </li>
            <li>
                    <a class="function" href="#add_carbonate_system_2">add_carbonate_system_2</a>
            </li>
            <li>
                    <a class="function" href="#weathering_processes">weathering_processes</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a><wbr>.utility_functions    </h1>

                        <div class="docstring"><p>esbmtk: A general purpose Earth Science box model toolkit
Copyright (C), 2020 Ulrich G. Wortmann</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     esbmtk: A general purpose Earth Science box model toolkit</span>
<span class="sd">     Copyright (C), 2020 Ulrich G. Wortmann</span>

<span class="sd">     This program is free software: you can redistribute it and/or modify</span>
<span class="sd">     it under the terms of the GNU General Public License as published by</span>
<span class="sd">     the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">     (at your option) any later version.</span>

<span class="sd">     This program is distributed in the hope that it will be useful,</span>
<span class="sd">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">     GNU General Public License for more details.</span>

<span class="sd">     You should have received a copy of the GNU General Public License</span>
<span class="sd">     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># import typing as tp</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">tp</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

<span class="c1"># import builtins</span>
<span class="c1"># import math</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_matching_strings</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fl</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;test if all elements of fl occur in s. Return True if yes,</span>
<span class="sd">    otherwise False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">insert_into_namespace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name_space</span><span class="o">=</span><span class="nb">globals</span><span class="p">()):</span>
    <span class="n">name_space</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">add_to</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add element e to list l, but check if the entry already exist. If so, throw</span>
<span class="sd">    exception. Otherwise add</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># if not present, append element</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_plot_layout</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function which selects a row, column layout based on the number of</span>
<span class="sd">    objects to display.  The expected argument is a reservoir object which</span>
<span class="sd">    contains the list of fluxes in the reservoir</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">noo</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>
        <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># noo = len(obj.lof) + 1  # number of objects in this reservoir</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">noo</span><span class="si">}</span><span class="s2"> subplots for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> required&quot;</span><span class="p">)</span>

    <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>


<span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Define plot geometry based on number of objects to plot&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># one row, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># two rows, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># two rows, two columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;plot geometry for more than 15 fluxes is not yet defined&quot;</span>
            <span class="s2">&quot;Consider calling flux.plot individually on each flux in the reservoir&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>


<span class="k">def</span> <span class="nf">list_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Echo all fluxes in the reservoir to the screen</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">List of fluxes in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># show the processes</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Outflux from&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;To  :&quot;</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Influx to&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> via </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># print out the flux data</span>


<span class="k">def</span> <span class="nf">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Print the 3 lines of the data starting with index</span>

<span class="sd">    Optional arguments:</span>

<span class="sd">    index :int = 0 starting index</span>
<span class="sd">    indent :int = 0 indentation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
    <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># show the first 4 entries</span>
    <span class="c1"># for i in range(index, index + 3):</span>
    <span class="c1">#     print(f&quot;{off}{ind}i = {i}, Mass = {self.m[i]:.2e}, li= {self.l[i]:.2f}&quot;)</span>


<span class="k">def</span> <span class="nf">set_y_limits</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prevent the display or arbitrarily small differences&quot;&quot;&quot;</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span><span class="p">:</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_name_in_list</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if an object name is part of the object list&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">n</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Match a name to a list of objects. Return the object&quot;&quot;&quot;</span>

    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object = </span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no matching flux </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sort_by_type</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;divide a list by type into new lists. This function will return a</span>
<span class="sd">    list and it is up to the calling code to unpack the list</span>

<span class="sd">    l is list with various object types</span>
<span class="sd">    t is a list which contains the object types used for sorting</span>
<span class="sd">    m is a string for the error function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from numbers import Number</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>  <span class="c1"># loop over object types</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># loop over list elements</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ot</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># add to temporary list</span>
                <span class="n">lc</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># remove this element</span>

        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># save the temporary list to rl</span>

    <span class="c1"># at this point, all elements of lc should have been processed</span>
    <span class="c1"># if not, lc contains element which are of a different type</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rl</span>


<span class="k">def</span> <span class="nf">get_object_handle</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test if we the key is a global reservoir handle</span>
<span class="sd">    or exists in the model namespace</span>

<span class="sd">    res: list, str, or reservoir handle</span>
<span class="sd">    M: Model handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rlist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span>  <span class="c1"># is object known in global namespace</span>
            <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>  <span class="c1"># or does it exist in Model namespace</span>
            <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2"> is not known for model </span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rlist</span>


<span class="k">def</span> <span class="nf">split_key</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;split the string k with letters _to_, and test if optional</span>
<span class="sd">    id string is present</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;_to_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name must follow &#39;Source_to_Sink&#39; format&quot;</span><span class="p">)</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sinkandid</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">sinkandid</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">sink</span> <span class="o">=</span> <span class="n">get_object_handle</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">get_object_handle</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_dict</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a dictionary from a list and value, or from</span>
<span class="sd">    two lists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len values =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">, len keys =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values = </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key and value list must be of equal length&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">get_typed_list</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tl</span>


<span class="k">def</span> <span class="nf">create_reservoirs</span><span class="p">(</span><span class="n">bn</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;boxes are defined by area and depth interval here we use an ordered</span>
<span class="sd">    dictionary to define the box geometries. The next column is temperature</span>
<span class="sd">    in deg C, followed by pressure in bar</span>
<span class="sd">    the geometry is [upper depth datum, lower depth datum, area percentage]</span>

<span class="sd">    bn = dictionary with box parameters</span>
<span class="sd">    bn: dict = {  # name: [[geometry], T, P]</span>
<span class="sd">                 &quot;sb&quot;: {&quot;g&quot;: [0, 200, 0.9], &quot;T&quot;: 20, &quot;P&quot;: 5},</span>
<span class="sd">                 &quot;ib&quot;: {&quot;g&quot;: [200, 1200, 1], &quot;T&quot;: 10, &quot;P&quot;: 100},</span>
<span class="sd">                }</span>

<span class="sd">    ic = dictionary with species default values. This is used to et up</span>
<span class="sd">         initial conditions. Here we use shortcut and use the same conditions</span>
<span class="sd">         in each box. If you need box specific initial conditions</span>
<span class="sd">         use the output of build_concentration_dicts as starting point</span>

<span class="sd">    ic: dict = { # species: concentration, Isotopes</span>
<span class="sd">                   PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">                   DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">                   ALK: [Q_(&quot;2.43 mmol/liter&quot;), False],</span>
<span class="sd">               }</span>

<span class="sd">    M: Model object handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">build_concentration_dicts</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span>

    <span class="c1"># parse for sources and sinks, create these and remove them from the list</span>

    <span class="c1"># loop over reservoir names</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># test key format</span>
        <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># type is given</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span>
                <span class="n">SourceGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sink&quot;</span><span class="p">:</span>
                <span class="n">SinkGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;ty&#39; must be either Source or Sink&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># create reservoirs</span>

            <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">build_concentration_dicts</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

            <span class="n">rg</span> <span class="o">=</span> <span class="n">ReservoirGroup</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">seawater_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span> <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]},</span>
                <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">icd</span>


<span class="k">def</span> <span class="nf">build_concentration_dicts</span><span class="p">(</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build a dict which can be used by create_reservoirs</span>

<span class="sd">    bg : dict where the box_names are dict keys.</span>
<span class="sd">    cd: dictionary with the following format:</span>
<span class="sd">        cd = {</span>
<span class="sd">             # species: [concentration, isotopes]</span>
<span class="sd">             PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">             DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">            }</span>

<span class="sd">    This function returns a new dict in the following format</span>

<span class="sd">    #  box_names: [concentrations, isotopes]</span>
<span class="sd">    d= {&quot;bn&quot;: [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>

    <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">td1</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td2</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td3</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>

    <span class="c1"># create the dicts for concentration and isotopes</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">td1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">td2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">td3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># box_names: list = bg.keys()</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">box_names</span><span class="p">:</span>  <span class="c1"># loop over box names</span>
        <span class="n">icd</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">td1</span><span class="p">,</span> <span class="n">td2</span><span class="p">,</span> <span class="n">td3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">icd</span>


<span class="k">def</span> <span class="nf">calc_volumes</span><span class="p">(</span><span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume contained in a given depth interval</span>
<span class="sd">    bg is an ordered dictionary in the following format</span>

<span class="sd">    bg=  {</span>
<span class="sd">          &quot;hb&quot;: (0.1, 0, 200),</span>
<span class="sd">          &quot;sb&quot;: (0.9, 0, 200),</span>
<span class="sd">         }</span>

<span class="sd">    where the key must be a valid box name, the first entry of the list denoted</span>
<span class="sd">    the areal extent in percent, the second number is upper depth limit, and last</span>
<span class="sd">    number is the lower depth limit.</span>

<span class="sd">    M must be a model handle</span>
<span class="sd">    h is the hypsometry handle</span>

<span class="sd">    The function returns a list with the corresponding volumes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from esbmtk import hypsometry</span>

    <span class="n">v</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of volumes</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span>


<span class="k">def</span> <span class="nf">get_longest_dict_entry</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get length of each item in the connection dict&quot;&quot;&quot;</span>
    <span class="n">l_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of  longest list</span>
    <span class="n">p_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of single parameter</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of lists</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># we need to cover the case where we have two lists of different length</span>
    <span class="c1"># this happens if we have a long list of tuples with matched references,</span>
    <span class="c1"># as well as a list of species</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l_length</span><span class="p">:</span>
                <span class="n">l_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_length</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_length</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ll</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">l_length</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mapping for multiple lists is not supported&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only lists present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Only parameters present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Lists and parameters present</span>

    <span class="k">return</span> <span class="n">case</span><span class="p">,</span> <span class="n">l_length</span>


<span class="k">def</span> <span class="nf">convert_to_lists</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;expand mixed dict entries (i.e. list and single value) such</span>
<span class="sd">    that they are all lists of equal length</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">get_sub_key</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;take a dict which has where the value is a list, and return the</span>
<span class="sd">    key with the n-th value of that list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Determine dict structure</span>

<span class="sd">    in case we have mutiple connections with mutiple species, the</span>
<span class="sd">    default action is to map connections to species (t = &#39;1:1&#39;). If</span>
<span class="sd">    you rather want to create mutiple connections (one for each</span>
<span class="sd">    species) in each connection set t = &#39;1:N&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loop over dict entries</span>
    <span class="c1"># ck = connection key</span>
    <span class="c1"># cd = connection dict</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># the dict we will return</span>

    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># loop over connections</span>

        <span class="c1"># print(f&quot;ck = {ck}&quot;)</span>
        <span class="c1"># print(f&quot;cd = {cd}&quot;)</span>

        <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">nd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">case</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">get_longest_dict_entry</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

        <span class="c1"># print(f&quot;length = {length}&quot;)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># assume 1:1 mapping between tuple and connection parameters</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:1&quot;</span><span class="p">:</span>

                <span class="c1"># prep dictionaries</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                    <span class="c1"># print(&quot;case 0&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(&quot;case 1&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="c1"># print(f&quot;case 2, length = {length}&quot;)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(nd)</span>

                <span class="c1"># for each connection group in the tuple</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The number of connection properties (</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;does not match the number of connection groups (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;did you intend to do a 1:N mapping?&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># map property dicts to connection group names</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_sub_key</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:N&quot;</span><span class="p">:</span>  <span class="c1"># apply each species to each connection</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>  <span class="c1"># apply the entire nd dict to all connections</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s2"> is not defined. must be &#39;1:1&#39; or &#39;1:N&#39;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>  <span class="c1"># only lists present, case 3</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># list and parameters present case 4</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">rd</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>

        <span class="c1"># update the overall dict and move to the next entry</span>
        <span class="n">r</span> <span class="o">|=</span> <span class="n">rd</span>

    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">create_bulk_connections</span><span class="p">(</span><span class="n">ct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create connections from a dictionary. The dict can have the following keys</span>
<span class="sd">    following format:</span>

<span class="sd">    mt = mapping type. See below for explanation</span>

<span class="sd">    # na: names, tuple or str. If lists, all list elements share the same properties</span>
<span class="sd">    # sp: species list or species</span>
<span class="sd">    # ty: type, str</span>
<span class="sd">    # ra: rate, Quantity</span>
<span class="sd">    # sc: scale, Number</span>
<span class="sd">    # re: reference, optional</span>
<span class="sd">    # al: alpha, optional</span>
<span class="sd">    # de: delta, optional</span>
<span class="sd">    # bp: bypass, see scale_with_flux</span>
<span class="sd">    # si: signal</span>
<span class="sd">    # mx: True, optional defaults to False. If set, it will create forward</span>
<span class="sd">          and backward fluxes (i.e. mixing)</span>

<span class="sd">    There are 6 different cases how to specify connections</span>

<span class="sd">    Case 1 One connection, one set of parameters</span>
<span class="sd">           ct1 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;....}}</span>

<span class="sd">    Case 2 One connection, one set of instructions, one subset with multiple parameters</span>
<span class="sd">           This will be expanded to create connections for each species</span>
<span class="sd">           ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 3 One connection complete set of multiple characters. Similar to case 2, but now</span>
<span class="sd">           all parameters are given explicitly</span>
<span class="sd">           ct3 = {&quot;sb2hb&quot;: {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 4 Multiple connections, one set of parameters. This will create</span>
<span class="sd">           identical connection for &quot;sb2hb&quot; and  &quot;ib2db&quot;</span>
<span class="sd">           ct4 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;: ...}}</span>

<span class="sd">    Case 5 Multiple connections, one subset of multiple set of parameters. This wil</span>
<span class="sd">          create a connection for species &#39;a&#39; in sb2hb and with species &#39;b&#39; in ib2db</span>
<span class="sd">           ct5 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 6 Multiple connections, complete set of parameters of multiple parameters</span>
<span class="sd">           Same as case 5, but now all parameters are specified explicitly</span>
<span class="sd">           ct6 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>


<span class="sd">    The default interpretation for cases 5 and 6 is that each list</span>
<span class="sd">    entry corresponds to connection. However, sometimes we want to</span>
<span class="sd">    create multiple connections for multiple entries. In this case</span>
<span class="sd">    provide the mt=&#39;1:N&#39; parameter which will create a connection for</span>
<span class="sd">    each species in each connection group. See the below example.</span>

<span class="sd">    It is easy to shoot yourself in the foot. It is best to try the above first with</span>
<span class="sd">    some simple examples, e.g.,</span>

<span class="sd">    from esbmtk import expand_dict</span>
<span class="sd">    ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    It is best to use the show_dict function to verify that your input</span>
<span class="sd">    dictionary produces the correct results!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">expand_dict</span>

    <span class="c1"># expand dictionary into a well formed dict where each connection</span>
    <span class="c1"># has a fully formed entry</span>
    <span class="n">c_ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">)</span>

    <span class="c1"># loop over dict entries and create the respective connections</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># loop over names in tuple</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">create_connection</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">create_connection</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> must be string or tuple&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ct</span>


<span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;called by create_bulk_connections in order to create a connection</span>
<span class="sd">    group It is assumed that all rates are in liter/year or mol per</span>
<span class="sd">    year. This may not be what you want or need.</span>

<span class="sd">    n: a connection key e.g., sb2db@mix which will be</span>
<span class="sd">    interpreted as mixing a connection between sb and db and thus</span>
<span class="sd">    create connections in both directions</span>

<span class="sd">    p: a dictionary holding  the connection properties</span>

<span class="sd">    M: the model handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># get the reservoir handles by splitting the key</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">split_key</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="c1"># create default connections parameters and replace with values in</span>
    <span class="c1"># the parameter dict if present.</span>
    <span class="n">los</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]]</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="s2">&quot;sc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sc&quot;</span><span class="p">]</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;0 mol/a&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;re&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;re&quot;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;al&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;al&quot;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;de&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">]</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;bp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;bp&quot;</span><span class="p">]</span>
    <span class="n">species</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;sp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;si&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;l/a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># expand arguments</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ctype</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># get rate from dictionary</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">bypass</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>

    <span class="c1"># name of connectiongroup</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.CG_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>  <span class="c1"># Test if CG exists</span>
        <span class="c1"># retriece CG object</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">add_connections</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
            <span class="n">ref_flux</span><span class="o">=</span><span class="n">ref_flux</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="n">bypass</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Create New ConnectionGroup</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">ConnectionGroup</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
            <span class="n">ref_flux</span><span class="o">=</span><span class="n">ref_flux</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="n">bypass</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_name_only</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if item is an esbmtk type. If yes, extract the name&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">Species</span>

    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">Species</span><span class="p">))</span> <span class="k">else</span> <span class="n">o</span>


<span class="k">def</span> <span class="nf">get_simple_list</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;return a list which only has the full name</span>
<span class="sd">    rather than all the object properties</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">get_name_only</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">show_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;show dict entries in an organized manner&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">expand_dict</span><span class="p">,</span> <span class="n">get_simple_list</span><span class="p">,</span> <span class="n">get_name_only</span>

    <span class="n">ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">get_simple_list</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">get_name_only</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">pk</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_matching_fluxes</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">filter_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Loop over all reservoir in l, and extract the names of all fluxes</span>
<span class="sd">    which match the filter string. Return the list of names (not objects!)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lof</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_by</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">and</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">lof</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">lof</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reverse_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;reverse a connection key e.g., sb2db@POM becomes db2sb@POM&quot;&quot;&quot;</span>

    <span class="c1"># print(f&quot;key = {key}&quot;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># right = l[1]</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">get_connection_keys</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span> <span class="n">fstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;extract connection keys from set of flux names, replace fstr with</span>
<span class="sd">    nstr so that the key can be used in create_bulk_connnections()</span>

<span class="sd">    The optional inverse parameter, can be used where in cases where the</span>
<span class="sd">    flux direction needs to be reversed, i.e., the returned key will not read</span>
<span class="sd">    sb2db@POM, but db2s@POM</span>

<span class="sd">    E.g., if</span>

<span class="sd">    s = ( M4.CG_P_sb2P_ib.PO4.POP_F)</span>
<span class="sd">    fstr = &quot;POP&quot;</span>
<span class="sd">    nstr = &quot;POM_DIC&quot;</span>

<span class="sd">    M4.CG_P_sb2P_ib.PO4.POP_F will become</span>

<span class="sd">    P_sb_to_P_ib@POM_DIC</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="c1"># get connection and flux name</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># get key without leadinf C_</span>
        <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">reverse_key</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
        <span class="n">cn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fstr</span><span class="p">,</span> <span class="n">nstr</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">nstr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cl</span>


<span class="k">def</span> <span class="nf">gen_dict_entries</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;find all fluxes which contain the reference string, and create</span>
<span class="sd">    matching keys which contain the target string. The function will</span>
<span class="sd">    return two lists, which can be used to create a dict for the</span>
<span class="sd">    create_bulk_connnection function.</span>

<span class="sd">    E.g., to create a dict which will create new fluxes based on</span>
<span class="sd">    existing fluxes</span>

<span class="sd">    dk:list, fl:list = gen_dict_entries(ref_id = &#39;POP&#39;, target_id = &#39;POM&#39;)</span>

<span class="sd">    this will find all fluxes with the POP-id and put these into</span>
<span class="sd">    fl. It will also generate a list with suitable connections keys</span>
<span class="sd">    (dk) which contain the &#39;POM&#39; id.</span>

<span class="sd">    The optional inverse parameter, can be used where in cases where the</span>
<span class="sd">    flux direction needs to be reversed, i.e., the returned key will not read</span>
<span class="sd">    sb_to_dbPOM, but db_to_sb@POM</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span>

    <span class="n">reference</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_id&quot;</span><span class="p">]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">]</span>
    <span class="n">inverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inverse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">exclude_str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">flist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">find_matching_fluxes</span><span class="p">(</span>
            <span class="n">M</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="n">filter_by</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_str</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">flist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">find_matching_fluxes</span><span class="p">(</span>
            <span class="n">M</span><span class="p">,</span>
            <span class="n">filter_by</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_str</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gen_dict_entries: M must be list or Model, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">klist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">get_connection_keys</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">inverse</span><span class="p">,</span> <span class="n">exclude_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">klist</span><span class="p">),</span> <span class="n">flist</span>


<span class="k">def</span> <span class="nf">build_ct_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;build a connection dictionary from a dict containing connection</span>
<span class="sd">    keys, and a dict containing connection properties. This is most</span>
<span class="sd">    useful for connections which a characterized by a fixed rate but</span>
<span class="sd">    apply to many species. E.g., mixing fluxes in a complex model etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sc&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="o">|</span> <span class="n">p</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">get_string_between_brackets</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse string and extract substring between square brackets&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">check_for_quantity</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;check if keyword is quantity or string an convert as necessary</span>

<span class="sd">    kw = str or Q_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kw must be string or Quantity&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kw</span>


<span class="k">def</span> <span class="nf">map_units</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;parse v to see if it is a string. if yes, map to quantity.</span>
<span class="sd">    parse v to see if it is a quantity, if yes, map to model units</span>
<span class="sd">    and extract magnitude, assign mangitude to return value</span>
<span class="sd">    if not, assign value to return value</span>

<span class="sd">    v : a keyword value number/string/quantity</span>
<span class="sd">    args: one or more quantities (units) see the Model class (e.g., f_unit)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># test if string, map to quantity if yes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># test if we find a matching dimension, map if true</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is none of </span><span class="si">{</span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no quantity, so it should be a number</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">, must be float, v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">. Something is fishy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">add_carbonate_system_1</span><span class="p">(</span><span class="n">rgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new carbonate system virtual reservoir for each</span>
<span class="sd">    reservoir in rgs. Note that rgs must be a list of reservoir groups.</span>

<span class="sd">    Required keywords:</span>
<span class="sd">        rgs: list = []  of Reservoir Group objects</span>

<span class="sd">    These new virtual reservoirs are registered to their respective Reservoir</span>
<span class="sd">    as &#39;cs&#39;.</span>

<span class="sd">    The respective data fields are available as rgs.r.cs.xxx where xxx stands</span>
<span class="sd">    for a given key key in the  vr_datafields dictionary (i.e., H, CA, etc.)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ExternalCode</span><span class="p">,</span>
        <span class="n">calc_carbonates_1</span><span class="p">,</span>
        <span class="n">carbonate_system_1_ode</span><span class="p">,</span>
        <span class="n">Reservoir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># get object handle even if it defined in model namespace</span>
    <span class="c1"># rgs = get_object_handle(rgs)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">rgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Carbon</span><span class="o">.</span><span class="n">CO2</span>

    <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">rgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">use_ode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">carbonate_system_1_ode</span><span class="p">,</span>
                    <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs1&quot;</span><span class="p">,</span>
                    <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4</span>
                    <span class="p">},</span>
                    <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                    <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                    <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                    <span class="n">return_values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Hplus&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ec</span><span class="o">.</span><span class="n">return_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rt</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">species</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                        <span class="n">concentration</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> mol/kg&quot;</span><span class="p">,</span>
                        <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                        <span class="n">volume</span><span class="o">=</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                        <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;computed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_1</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs1&quot;</span><span class="p">,</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4</span>
                <span class="p">},</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">([</span><span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1">#</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="c1"># return_values=&quot;H CA HCO3 CO3 CO2aq&quot;.split(&quot; &quot;),</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rg</span><span class="o">.</span><span class="n">has_cs1</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rg</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> must have a TA and DIC reservoir&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_carbonate_system_2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates a new carbonate system virtual reservoir</span>
<span class="sd">        which will compute carbon species, saturation, compensation,</span>
<span class="sd">        and snowline depth, and compute the associated carbonate burial fluxes</span>

<span class="sd">        Required keywords:</span>
<span class="sd">            r_sb: list of ReservoirGroup objects in the surface layer</span>
<span class="sd">            r_db: list of ReservoirGroup objects in the deep layer</span>
<span class="sd">            carbonate_export_fluxes: list of flux objects which must match the</span>
<span class="sd">                                     list of ReservoirGroup objects.</span>
<span class="sd">            zsat_min = depth of the upper boundary of the deep box</span>
<span class="sd">            z0 = upper depth limit for carbonate burial calculations</span>
<span class="sd">                 typically zsat_min</span>

<span class="sd">        Optional Parameters:</span>

<span class="sd">            zsat = initial saturation depth (m)</span>
<span class="sd">            zcc = initial carbon compensation depth (m)</span>
<span class="sd">            zsnow = initial snowline depth (m)</span>
<span class="sd">            zsat0 = characteristic depth (m)</span>
<span class="sd">            Ksp0 = solubility product of calcite at air-water interface (mol^2/kg^2)</span>
<span class="sd">            kc = heterogeneous rate constant/mass transfer coefficient for calcite dissolution (kg m^-2 yr^-1)</span>
<span class="sd">            Ca2 = calcium ion concentration (mol/kg)</span>
<span class="sd">            pc = characteristic pressure (atm)</span>
<span class="sd">            pg = seawater density multiplied by gravity due to acceleration (atm/m)</span>
<span class="sd">            I = dissolvable CaCO3 inventory</span>
<span class="sd">            co3 = CO3 concentration (mol/kg)</span>
<span class="sd">            Ksp = solubility product of calcite at in situ sea water conditions (mol^2/kg^2)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ExternalCode</span><span class="p">,</span>
        <span class="n">calc_carbonates_2</span><span class="p">,</span>
        <span class="n">carbonate_system_2_ode</span><span class="p">,</span>
        <span class="n">Reservoir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># list of known keywords</span>
    <span class="n">lkk</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;r_db&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># list of deep reservoirs</span>
        <span class="s2">&quot;r_sb&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># list of corresponding surface reservoirs</span>
        <span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s2">&quot;AD&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsat_min&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsat0&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;Ksp0&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;kc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;Ca2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;I_caco3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;zmax&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;z0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;Ksp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c1"># provide a list of absolutely required keywords</span>
    <span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">,</span> <span class="s2">&quot;r_sb&quot;</span><span class="p">,</span> <span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">,</span> <span class="s2">&quot;zsat_min&quot;</span><span class="p">,</span> <span class="s2">&quot;z0&quot;</span><span class="p">]</span>

    <span class="c1"># we need the reference to the Model in order to set some</span>
    <span class="c1"># default values.</span>

    <span class="n">reservoir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
    <span class="c1"># list of default values if none provided</span>
    <span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;r_sb&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># empty list</span>
        <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3715</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4750</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5000</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zsat0&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5078</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;Ksp0&quot;</span><span class="p">:</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># mol^2/kg^2</span>
        <span class="s2">&quot;kc&quot;</span><span class="p">:</span> <span class="mf">8.84</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># m/yr converted to kg/(m^2 yr)</span>
        <span class="s2">&quot;AD&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">area_dz</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mi">6000</span><span class="p">),</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># 0.928771302395292, #0.75,</span>
        <span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="mf">0.103</span><span class="p">,</span>  <span class="c1"># pressure in atm/m</span>
        <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="mi">511</span><span class="p">,</span>  <span class="c1"># characteristic pressure after Boudreau 2010</span>
        <span class="s2">&quot;I_caco3&quot;</span><span class="p">:</span> <span class="mi">529</span><span class="p">,</span>  <span class="c1"># dissolveable CaCO3 in mol/m^2</span>
        <span class="s2">&quot;zmax&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">6000</span><span class="p">,</span>  <span class="c1"># max model depth</span>
        <span class="s2">&quot;Ksp&quot;</span><span class="p">:</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># mol^2/kg^2</span>
    <span class="p">}</span>

    <span class="c1"># make sure all mandatory keywords are present</span>
    <span class="n">__checkkeys__</span><span class="p">(</span><span class="n">lrk</span><span class="p">,</span> <span class="n">lkk</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># add default values for keys which were not specified</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">__addmissingdefaults__</span><span class="p">(</span><span class="n">lod</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># test that all keyword values are of the correct type</span>
    <span class="n">__checktypes__</span><span class="p">(</span><span class="n">lkk</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># establish some shared parameters</span>
    <span class="c1"># depths_table = np.arange(0, 6001, 1)</span>
    <span class="n">depths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6002</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r_db</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">]</span>
    <span class="n">r_sb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_sb&quot;</span><span class="p">]</span>
    <span class="n">Ksp0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Ksp0&quot;</span><span class="p">]</span>
    <span class="n">ca2</span> <span class="o">=</span> <span class="n">r_db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pc&quot;</span><span class="p">]</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span>
    <span class="n">Ksp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Ksp&quot;</span><span class="p">]</span>

    <span class="c1"># test if corresponding surface reservoirs have been defined</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please update your call to add_carbonate_system_2and add the list of of corresponding surface reservoirs&#39;</span><span class="p">)</span>


    <span class="c1"># C saturation(z) after Boudreau 2010</span>
    <span class="n">Csat_table</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ksp0</span> <span class="o">/</span> <span class="n">ca2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">depths</span> <span class="o">*</span> <span class="n">pg</span><span class="p">)</span> <span class="o">/</span> <span class="n">pc</span><span class="p">)</span>
    <span class="n">area_table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">get_lookup_table</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6002</span><span class="p">)</span>  <span class="c1"># area in m^2(z)</span>
    <span class="n">area_dz_table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">get_lookup_table_area_dz</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6002</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># area&#39;</span>
    <span class="n">AD</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">area_dz</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6000</span><span class="p">)</span>  <span class="c1"># Total Ocean Area</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r_db</span><span class="p">):</span>  <span class="c1"># Setup the virtual reservoirs</span>
        <span class="k">if</span> <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">Carbon</span><span class="o">.</span><span class="n">CO2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">__builtins__</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">r_db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">use_ode</span><span class="p">:</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs2&quot;</span><span class="p">,</span>
                <span class="n">r_s</span><span class="o">=</span><span class="n">r_sb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># source (RG) of CaCO3 flux,</span>
                <span class="n">r_d</span><span class="o">=</span><span class="n">r_db</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># sink (RG) of CaCO3 flux,</span>
                <span class="c1"># datafield hold the results of the VR_no_set function</span>
                <span class="c1"># provide a default values which will be use to initialize</span>
                <span class="c1"># the respective datafield/</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0 H+</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1 carbonate alkalinity</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2 HCO3</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3 CO3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4 CO2aq</span>
                    <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat&quot;</span><span class="p">]),</span>  <span class="c1"># 5 zsat</span>
                    <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zcc&quot;</span><span class="p">]),</span>  <span class="c1"># 6 zcc</span>
                    <span class="c1"># &quot;zsnow&quot;: abs(kwargs[&quot;zsnow&quot;]),  # 7 zsnow</span>
                    <span class="s2">&quot;depth_area_table&quot;</span><span class="p">:</span> <span class="n">area_table</span><span class="p">,</span>
                    <span class="s2">&quot;area_dz_table&quot;</span><span class="p">:</span> <span class="n">area_dz_table</span><span class="p">,</span>
                    <span class="s2">&quot;Csat_table&quot;</span><span class="p">:</span> <span class="n">Csat_table</span><span class="p">,</span>
                    <span class="s2">&quot;Fburial&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;Fburial_l&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">ref_flux</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">],</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kc&quot;</span><span class="p">]),</span>  <span class="c1"># 6</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;liter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">),</span>  <span class="c1"># 7</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">AD</span><span class="p">),</span>  <span class="c1"># 8</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat0&quot;</span><span class="p">])),</span>  <span class="c1"># 9</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">),</span>  <span class="c1"># 10</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>  <span class="c1"># 11</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;I_caco3&quot;</span><span class="p">]),</span>  <span class="c1"># 12</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>  <span class="c1"># 13</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat_min&quot;</span><span class="p">])),</span>  <span class="c1"># 14</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">])),</span>  <span class="c1"># 15</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])),</span>  <span class="c1"># 16</span>
                        <span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 17</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 18</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>  <span class="c1"># 19</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">return_values</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Hplus&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                    <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>
                <span class="p">},</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ec</span><span class="o">.</span><span class="n">return_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                    <span class="n">concentration</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> mol/kg&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                    <span class="n">volume</span><span class="o">=</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                    <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;computed&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_2</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs2&quot;</span><span class="p">,</span>
                <span class="c1"># datafield hold the results of the VR_no_set function</span>
                <span class="c1"># provide a default values which will be use to initialize</span>
                <span class="c1"># the respective datafield/</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0 H+</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1 carbonate alkalinity</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2 HCO3</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3 CO3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4 CO2aq</span>
                    <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat&quot;</span><span class="p">],</span>  <span class="c1"># 5 zsat</span>
                    <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zcc&quot;</span><span class="p">],</span>  <span class="c1"># 6 zcc</span>
                    <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">],</span>  <span class="c1"># 7 zsnow</span>
                    <span class="s2">&quot;Fburial&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 8 carbonate burial</span>
                    <span class="s2">&quot;Fburial_l&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 9 carbonate burial 12C</span>
                    <span class="s2">&quot;diss&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># dissolution flux</span>
                    <span class="s2">&quot;Bm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0 DIC mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1 DIC light isotope mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 2 DIC concentration db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 3 TA mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 4 TA concentration db</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="n">area_table</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="n">area_dz_table</span><span class="p">,</span>  <span class="c1"># 7</span>
                        <span class="n">Csat_table</span><span class="p">,</span>  <span class="c1"># 8</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 9 reservoir volume</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kc&quot;</span><span class="p">]),</span>  <span class="c1"># 6</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;liter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">),</span>  <span class="c1"># 7</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">AD</span><span class="p">),</span>  <span class="c1"># 8</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat0&quot;</span><span class="p">])),</span>  <span class="c1"># 9</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">),</span>  <span class="c1"># 10</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>  <span class="c1"># 11</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;I_caco3&quot;</span><span class="p">]),</span>  <span class="c1"># 12</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>  <span class="c1"># 13</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat_min&quot;</span><span class="p">])),</span>  <span class="c1"># 14</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">])),</span>  <span class="c1"># 15</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])),</span>  <span class="c1"># 16</span>
                        <span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 17</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">rg</span><span class="o">.</span><span class="n">has_cs2</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">weathering_processes</span><span class="p">():</span>

    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">__find_flux__</span><span class="p">(</span><span class="n">reservoirs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to find a Flux object based on its full_name in the reservoirs</span>
<span class="sd">    in the list of provided reservoirs.</span>

<span class="sd">    PRECONDITIONS: full_name must contain the full_name of the Flux</span>

<span class="sd">    Parameters:</span>
<span class="sd">        reservoirs: List containing all reservoirs</span>
<span class="sd">        full_name: str specifying the full name of the flux (boxes.flux_name)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">needed_flux</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">reservoirs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flux</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">full_name</span><span class="p">:</span>
                <span class="n">needed_flux</span> <span class="o">=</span> <span class="n">flux</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">needed_flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">needed_flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;add_carbonate_system: Flux </span><span class="si">{</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> cannot be found in any of the reservoirs in the Model!&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">needed_flux</span>


<span class="k">def</span> <span class="nf">__checktypes__</span><span class="p">(</span><span class="n">av</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">pv</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;this method will use the the dict key in the user provided</span>
<span class="sd">    key value data (pv) to look up the allowed data type for this key in av</span>

<span class="sd">    av = dictinory with the allowed input keys and their type</span>
<span class="sd">    pv = dictionary with the user provided key-value data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">k</span><span class="p">:</span> <span class="nb">any</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>

    <span class="c1"># loop over provided keywords</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># check av if provided value v is of correct type</span>
        <span class="k">if</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">any</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
            <span class="c1"># print(f&quot;k={k}, v= {v}, av[k] = {av[k]}&quot;)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> is the wrong type for &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, should be &#39;</span><span class="si">{</span><span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>


<span class="k">def</span> <span class="nf">__checkkeys__</span><span class="p">(</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">lkk</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;check if the mandatory keys are present</span>

<span class="sd">    lrk = list of required keywords</span>
<span class="sd">    lkk = list of all known keywords</span>
<span class="sd">    kwargs = dictionary with key-value pairs</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">k</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>
    <span class="c1"># test if the required keywords are given</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lrk</span><span class="p">:</span>  <span class="c1"># loop over required keywords</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># If keyword is a list</span>
            <span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over allowed substitutions</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># test how many matches are in this list</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if more than one match</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You need to specify exactly one from this list: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You need to specify a value for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">tl</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lkk</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="c1"># test if we know all keys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lkk</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not a valid keyword. </span><span class="se">\n</span><span class="s2"> Try any of </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__addmissingdefaults__</span><span class="p">(</span><span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    test if the keys in lod exist in kwargs, otherwise add them with the default values</span>
<span class="sd">    from lod</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">lod</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="n">kwargs</span> <span class="o">|=</span> <span class="n">new</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>

        </details>

            </section>
                <section id="find_matching_strings">
                            <div class="attr function"><a class="headerlink" href="#find_matching_strings">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">find_matching_strings</span><span class="signature">(s: str, fl: list[str]) -&gt; bool</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">find_matching_strings</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fl</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;test if all elements of fl occur in s. Return True if yes,</span>
<span class="sd">    otherwise False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>test if all elements of fl occur in s. Return True if yes,
otherwise False</p>
</div>


                </section>
                <section id="insert_into_namespace">
                            <div class="attr function"><a class="headerlink" href="#insert_into_namespace">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">insert_into_namespace</span><span class="signature">(
    name,
    value,
    name_space={&#39;__name__&#39;: &#39;<a href="">esbmtk.utility_functions</a>&#39;, &#39;__doc__&#39;: &#39;\n     esbmtk: A general purpose Earth Science box model toolkit\n     Copyright (C), 2020 Ulrich G. Wortmann\n\n     This program is free software: you can redistribute it and/or modify\n     it under the terms of the GNU General Public License as published by\n     the Free Software Foundation, either version 3 of the License, or\n     (at your option) any later version.\n\n     This program is distributed in the hope that it will be useful,\n     but WITHOUT ANY WARRANTY; without even the implied warranty of\n     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n     GNU General Public License for more details.\n\n     You should have received a copy of the GNU General Public License\n     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.\n&#39;, &#39;__package__&#39;: &#39;esbmtk&#39;, &#39;__loader__&#39;: &lt;_frozen_importlib_external.SourceFileLoader object at 0x7f64fbe67f70&gt;, &#39;__spec__&#39;: ModuleSpec(name=&#39;<a href="">esbmtk.utility_functions</a>&#39;, loader=&lt;_frozen_importlib_external.SourceFileLoader object at 0x7f64fbe67f70&gt;, origin=&#39;/home/uliw/user/python-scripts/esbmtk/esbmtk/utility_functions.py&#39;), &#39;__file__&#39;: &#39;/home/uliw/user/python-scripts/esbmtk/esbmtk/utility_functions.py&#39;, &#39;__cached__&#39;: &#39;/home/uliw/user/python-scripts/esbmtk/esbmtk/__pycache__/utility_functions.cpython-39.pyc&#39;, &#39;__builtins__&#39;: {&#39;__name__&#39;: &#39;builtins&#39;, &#39;__doc__&#39;: &#34;Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil&#39; object; Ellipsis represents `...&#39; in slices.&#34;, &#39;__package__&#39;: &#39;&#39;, &#39;__loader__&#39;: &lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;, &#39;__spec__&#39;: ModuleSpec(name=&#39;builtins&#39;, loader=&lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;, origin=&#39;built-in&#39;), &#39;__build_class__&#39;: &lt;built-in function __build_class__&gt;, &#39;__import__&#39;: &lt;built-in function __import__&gt;, &#39;abs&#39;: &lt;built-in function abs&gt;, &#39;all&#39;: &lt;built-in function all&gt;, &#39;any&#39;: &lt;built-in function any&gt;, &#39;ascii&#39;: &lt;built-in function ascii&gt;, &#39;bin&#39;: &lt;built-in function bin&gt;, &#39;breakpoint&#39;: &lt;built-in function breakpoint&gt;, &#39;callable&#39;: &lt;built-in function callable&gt;, &#39;chr&#39;: &lt;built-in function chr&gt;, &#39;compile&#39;: &lt;built-in function compile&gt;, &#39;delattr&#39;: &lt;built-in function delattr&gt;, &#39;dir&#39;: &lt;built-in function dir&gt;, &#39;divmod&#39;: &lt;built-in function divmod&gt;, &#39;eval&#39;: &lt;built-in function eval&gt;, &#39;exec&#39;: &lt;built-in function exec&gt;, &#39;format&#39;: &lt;built-in function format&gt;, &#39;getattr&#39;: &lt;built-in function getattr&gt;, &#39;globals&#39;: &lt;built-in function globals&gt;, &#39;hasattr&#39;: &lt;built-in function hasattr&gt;, &#39;hash&#39;: &lt;built-in function hash&gt;, &#39;hex&#39;: &lt;built-in function hex&gt;, &#39;id&#39;: &lt;built-in function id&gt;, &#39;input&#39;: &lt;built-in function input&gt;, &#39;isinstance&#39;: &lt;built-in function isinstance&gt;, &#39;issubclass&#39;: &lt;built-in function issubclass&gt;, &#39;iter&#39;: &lt;built-in function iter&gt;, &#39;len&#39;: &lt;built-in function len&gt;, &#39;locals&#39;: &lt;built-in function locals&gt;, &#39;max&#39;: &lt;built-in function max&gt;, &#39;min&#39;: &lt;built-in function min&gt;, &#39;next&#39;: &lt;built-in function next&gt;, &#39;oct&#39;: &lt;built-in function oct&gt;, &#39;ord&#39;: &lt;built-in function ord&gt;, &#39;pow&#39;: &lt;built-in function pow&gt;, &#39;print&#39;: &lt;built-in function print&gt;, &#39;repr&#39;: &lt;built-in function repr&gt;, &#39;round&#39;: &lt;built-in function round&gt;, &#39;setattr&#39;: &lt;built-in function setattr&gt;, &#39;sorted&#39;: &lt;built-in function sorted&gt;, &#39;sum&#39;: &lt;built-in function sum&gt;, &#39;vars&#39;: &lt;built-in function vars&gt;, &#39;None&#39;: None, &#39;Ellipsis&#39;: Ellipsis, &#39;NotImplemented&#39;: NotImplemented, &#39;False&#39;: False, &#39;True&#39;: True, &#39;bool&#39;: &lt;class &#39;bool&#39;&gt;, &#39;memoryview&#39;: &lt;class &#39;memoryview&#39;&gt;, &#39;bytearray&#39;: &lt;class &#39;bytearray&#39;&gt;, &#39;bytes&#39;: &lt;class &#39;bytes&#39;&gt;, &#39;classmethod&#39;: &lt;class &#39;classmethod&#39;&gt;, &#39;complex&#39;: &lt;class &#39;complex&#39;&gt;, &#39;dict&#39;: &lt;class &#39;dict&#39;&gt;, &#39;enumerate&#39;: &lt;class &#39;enumerate&#39;&gt;, &#39;filter&#39;: &lt;class &#39;filter&#39;&gt;, &#39;float&#39;: &lt;class &#39;float&#39;&gt;, &#39;frozenset&#39;: &lt;class &#39;frozenset&#39;&gt;, &#39;property&#39;: &lt;class &#39;property&#39;&gt;, &#39;int&#39;: &lt;class &#39;int&#39;&gt;, &#39;list&#39;: &lt;class &#39;list&#39;&gt;, &#39;map&#39;: &lt;class &#39;map&#39;&gt;, &#39;object&#39;: &lt;class &#39;object&#39;&gt;, &#39;range&#39;: &lt;class &#39;range&#39;&gt;, &#39;reversed&#39;: &lt;class &#39;reversed&#39;&gt;, &#39;set&#39;: &lt;class &#39;set&#39;&gt;, &#39;slice&#39;: &lt;class &#39;slice&#39;&gt;, &#39;staticmethod&#39;: &lt;class &#39;staticmethod&#39;&gt;, &#39;str&#39;: &lt;class &#39;str&#39;&gt;, &#39;super&#39;: &lt;class &#39;super&#39;&gt;, &#39;tuple&#39;: &lt;class &#39;tuple&#39;&gt;, &#39;type&#39;: &lt;class &#39;type&#39;&gt;, &#39;zip&#39;: &lt;class &#39;zip&#39;&gt;, &#39;__debug__&#39;: True, &#39;BaseException&#39;: &lt;class &#39;BaseException&#39;&gt;, &#39;Exception&#39;: &lt;class &#39;Exception&#39;&gt;, &#39;TypeError&#39;: &lt;class &#39;TypeError&#39;&gt;, &#39;StopAsyncIteration&#39;: &lt;class &#39;StopAsyncIteration&#39;&gt;, &#39;StopIteration&#39;: &lt;class &#39;StopIteration&#39;&gt;, &#39;GeneratorExit&#39;: &lt;class &#39;GeneratorExit&#39;&gt;, &#39;SystemExit&#39;: &lt;class &#39;SystemExit&#39;&gt;, &#39;KeyboardInterrupt&#39;: &lt;class &#39;KeyboardInterrupt&#39;&gt;, &#39;ImportError&#39;: &lt;class &#39;ImportError&#39;&gt;, &#39;ModuleNotFoundError&#39;: &lt;class &#39;ModuleNotFoundError&#39;&gt;, &#39;OSError&#39;: &lt;class &#39;OSError&#39;&gt;, &#39;EnvironmentError&#39;: &lt;class &#39;OSError&#39;&gt;, &#39;IOError&#39;: &lt;class &#39;OSError&#39;&gt;, &#39;EOFError&#39;: &lt;class &#39;EOFError&#39;&gt;, &#39;RuntimeError&#39;: &lt;class &#39;RuntimeError&#39;&gt;, &#39;RecursionError&#39;: &lt;class &#39;RecursionError&#39;&gt;, &#39;NotImplementedError&#39;: &lt;class &#39;NotImplementedError&#39;&gt;, &#39;NameError&#39;: &lt;class &#39;NameError&#39;&gt;, &#39;UnboundLocalError&#39;: &lt;class &#39;UnboundLocalError&#39;&gt;, &#39;AttributeError&#39;: &lt;class &#39;AttributeError&#39;&gt;, &#39;SyntaxError&#39;: &lt;class &#39;SyntaxError&#39;&gt;, &#39;IndentationError&#39;: &lt;class &#39;IndentationError&#39;&gt;, &#39;TabError&#39;: &lt;class &#39;TabError&#39;&gt;, &#39;LookupError&#39;: &lt;class &#39;LookupError&#39;&gt;, &#39;IndexError&#39;: &lt;class &#39;IndexError&#39;&gt;, &#39;KeyError&#39;: &lt;class &#39;KeyError&#39;&gt;, &#39;ValueError&#39;: &lt;class &#39;ValueError&#39;&gt;, &#39;UnicodeError&#39;: &lt;class &#39;UnicodeError&#39;&gt;, &#39;UnicodeEncodeError&#39;: &lt;class &#39;UnicodeEncodeError&#39;&gt;, &#39;UnicodeDecodeError&#39;: &lt;class &#39;UnicodeDecodeError&#39;&gt;, &#39;UnicodeTranslateError&#39;: &lt;class &#39;UnicodeTranslateError&#39;&gt;, &#39;AssertionError&#39;: &lt;class &#39;AssertionError&#39;&gt;, &#39;ArithmeticError&#39;: &lt;class &#39;ArithmeticError&#39;&gt;, &#39;FloatingPointError&#39;: &lt;class &#39;FloatingPointError&#39;&gt;, &#39;OverflowError&#39;: &lt;class &#39;OverflowError&#39;&gt;, &#39;ZeroDivisionError&#39;: &lt;class &#39;ZeroDivisionError&#39;&gt;, &#39;SystemError&#39;: &lt;class &#39;SystemError&#39;&gt;, &#39;ReferenceError&#39;: &lt;class &#39;ReferenceError&#39;&gt;, &#39;MemoryError&#39;: &lt;class &#39;MemoryError&#39;&gt;, &#39;BufferError&#39;: &lt;class &#39;BufferError&#39;&gt;, &#39;Warning&#39;: &lt;class &#39;Warning&#39;&gt;, &#39;UserWarning&#39;: &lt;class &#39;UserWarning&#39;&gt;, &#39;DeprecationWarning&#39;: &lt;class &#39;DeprecationWarning&#39;&gt;, &#39;PendingDeprecationWarning&#39;: &lt;class &#39;PendingDeprecationWarning&#39;&gt;, &#39;SyntaxWarning&#39;: &lt;class &#39;SyntaxWarning&#39;&gt;, &#39;RuntimeWarning&#39;: &lt;class &#39;RuntimeWarning&#39;&gt;, &#39;FutureWarning&#39;: &lt;class &#39;FutureWarning&#39;&gt;, &#39;ImportWarning&#39;: &lt;class &#39;ImportWarning&#39;&gt;, &#39;UnicodeWarning&#39;: &lt;class &#39;UnicodeWarning&#39;&gt;, &#39;BytesWarning&#39;: &lt;class &#39;BytesWarning&#39;&gt;, &#39;ResourceWarning&#39;: &lt;class &#39;ResourceWarning&#39;&gt;, &#39;ConnectionError&#39;: &lt;class &#39;ConnectionError&#39;&gt;, &#39;BlockingIOError&#39;: &lt;class &#39;BlockingIOError&#39;&gt;, &#39;BrokenPipeError&#39;: &lt;class &#39;BrokenPipeError&#39;&gt;, &#39;ChildProcessError&#39;: &lt;class &#39;ChildProcessError&#39;&gt;, &#39;ConnectionAbortedError&#39;: &lt;class &#39;ConnectionAbortedError&#39;&gt;, &#39;ConnectionRefusedError&#39;: &lt;class &#39;ConnectionRefusedError&#39;&gt;, &#39;ConnectionResetError&#39;: &lt;class &#39;ConnectionResetError&#39;&gt;, &#39;FileExistsError&#39;: &lt;class &#39;FileExistsError&#39;&gt;, &#39;FileNotFoundError&#39;: &lt;class &#39;FileNotFoundError&#39;&gt;, &#39;IsADirectoryError&#39;: &lt;class &#39;IsADirectoryError&#39;&gt;, &#39;NotADirectoryError&#39;: &lt;class &#39;NotADirectoryError&#39;&gt;, &#39;InterruptedError&#39;: &lt;class &#39;InterruptedError&#39;&gt;, &#39;PermissionError&#39;: &lt;class &#39;PermissionError&#39;&gt;, &#39;ProcessLookupError&#39;: &lt;class &#39;ProcessLookupError&#39;&gt;, &#39;TimeoutError&#39;: &lt;class &#39;TimeoutError&#39;&gt;, &#39;open&#39;: &lt;built-in function open&gt;, &#39;quit&#39;: Use quit() or Ctrl-D (i.e. EOF) to exit, &#39;exit&#39;: Use exit() or Ctrl-D (i.e. EOF) to exit, &#39;copyright&#39;: Copyright (c) 2001-2022 Python Software Foundation.
All Rights Reserved.

Copyright (c) 2000 BeOpen.com.
All Rights Reserved.

Copyright (c) 1995-2001 Corporation for National Research Initiatives.
All Rights Reserved.

Copyright (c) 1991-1995 Stichting Mathematisch Centrum, Amsterdam.
All Rights Reserved., &#39;credits&#39;:     Thanks to CWI, CNRI, BeOpen.com, Zope Corporation and a cast of thousands
    for supporting Python development.  See www.python.org for more information., &#39;license&#39;: Type license() to see the full license text, &#39;help&#39;: Type help() for interactive help, or help(object) for help about object., &#39;__pybind11_internals_v4_gcc_libstdcpp_cxxabi1011__&#39;: &lt;capsule object NULL at 0x7f6505ee6bd0&gt;}, &#39;List&#39;: &lt;class &#39;numba.typed.typedlist.List&#39;&gt;, &#39;np&#39;: &lt;module &#39;numpy&#39; from &#39;/home/uliw/anaconda3/lib/python3.9/site-packages/numpy/__init__.py&#39;&gt;, &#39;plt&#39;: &lt;module &#39;matplotlib.pyplot&#39; from &#39;/home/uliw/anaconda3/lib/python3.9/site-packages/matplotlib/pyplot.py&#39;&gt;, &#39;logging&#39;: &lt;module &#39;logging&#39; from &#39;/home/uliw/anaconda3/lib/python3.9/logging/__init__.py&#39;&gt;, &#39;tp&#39;: &lt;module &#39;typing&#39; from &#39;/home/uliw/anaconda3/lib/python3.9/typing.py&#39;&gt;, &#39;OrderedDict&#39;: &lt;class &#39;collections.OrderedDict&#39;&gt;, &#39;Q_&#39;: &lt;class &#39;pint.util.Quantity&#39;&gt;, &#39;find_matching_strings&#39;: &lt;function find_matching_strings at 0x7f64fbe76700&gt;, &#39;insert_into_namespace&#39;: &lt;function insert_into_namespace at 0x7f64fbe76f70&gt;, &#39;add_to&#39;: &lt;function add_to at 0x7f64fbe84040&gt;, &#39;get_plot_layout&#39;: &lt;function get_plot_layout at 0x7f64fbe840d0&gt;, &#39;plot_geometry&#39;: &lt;function plot_geometry at 0x7f64fbe84160&gt;, &#39;list_fluxes&#39;: &lt;function list_fluxes at 0x7f64fbe841f0&gt;, &#39;show_data&#39;: &lt;function show_data at 0x7f64fbe84280&gt;, &#39;set_y_limits&#39;: &lt;function set_y_limits at 0x7f64fbe84310&gt;, &#39;is_name_in_list&#39;: &lt;function is_name_in_list at 0x7f64fbe843a0&gt;, &#39;get_object_from_list&#39;: &lt;function get_object_from_list at 0x7f64fbe84430&gt;, &#39;sort_by_type&#39;: &lt;function sort_by_type at 0x7f64fbe844c0&gt;, &#39;get_object_handle&#39;: &lt;function get_object_handle at 0x7f64fbe84550&gt;, &#39;split_key&#39;: &lt;function split_key at 0x7f64fbe845e0&gt;, &#39;make_dict&#39;: &lt;function make_dict at 0x7f64fbe84670&gt;, &#39;get_typed_list&#39;: &lt;function get_typed_list at 0x7f64fbe84700&gt;, &#39;create_reservoirs&#39;: &lt;function create_reservoirs at 0x7f64fbe84790&gt;, &#39;build_concentration_dicts&#39;: &lt;function build_concentration_dicts at 0x7f64fbe84820&gt;, &#39;calc_volumes&#39;: &lt;function calc_volumes at 0x7f64fbe848b0&gt;, &#39;get_longest_dict_entry&#39;: &lt;function get_longest_dict_entry at 0x7f64fbe84940&gt;, &#39;convert_to_lists&#39;: &lt;function convert_to_lists at 0x7f64fbe849d0&gt;, &#39;get_sub_key&#39;: &lt;function get_sub_key at 0x7f64fbe84a60&gt;, &#39;expand_dict&#39;: &lt;function expand_dict at 0x7f64fbe84af0&gt;, &#39;create_bulk_connections&#39;: &lt;function create_bulk_connections at 0x7f64fbe84b80&gt;, &#39;create_connection&#39;: &lt;function create_connection at 0x7f64fbe84c10&gt;, &#39;get_name_only&#39;: &lt;function get_name_only at 0x7f64fbe84ca0&gt;, &#39;get_simple_list&#39;: &lt;function get_simple_list at 0x7f64fbe84d30&gt;, &#39;show_dict&#39;: &lt;function show_dict at 0x7f64fbe84dc0&gt;, &#39;find_matching_fluxes&#39;: &lt;function find_matching_fluxes at 0x7f64fbe84e50&gt;, &#39;reverse_key&#39;: &lt;function reverse_key at 0x7f64fbe84ee0&gt;, &#39;get_connection_keys&#39;: &lt;function get_connection_keys at 0x7f64fbe84f70&gt;, &#39;gen_dict_entries&#39;: &lt;function gen_dict_entries at 0x7f64fbe86040&gt;, &#39;build_ct_dict&#39;: &lt;function build_ct_dict at 0x7f64fbe860d0&gt;, &#39;get_string_between_brackets&#39;: &lt;function get_string_between_brackets at 0x7f64fbe86160&gt;, &#39;check_for_quantity&#39;: &lt;function check_for_quantity at 0x7f64fbe861f0&gt;, &#39;map_units&#39;: &lt;function map_units at 0x7f64fbe86280&gt;, &#39;add_carbonate_system_1&#39;: &lt;function add_carbonate_system_1 at 0x7f64fbe86310&gt;, &#39;add_carbonate_system_2&#39;: &lt;function add_carbonate_system_2 at 0x7f64fbe863a0&gt;, &#39;weathering_processes&#39;: &lt;function weathering_processes at 0x7f64fbe86430&gt;, &#39;__find_flux__&#39;: &lt;function __find_flux__ at 0x7f64fbe864c0&gt;, &#39;__checktypes__&#39;: &lt;function __checktypes__ at 0x7f64fbe86550&gt;, &#39;__checkkeys__&#39;: &lt;function __checkkeys__ at 0x7f64fbe865e0&gt;, &#39;__addmissingdefaults__&#39;: &lt;function __addmissingdefaults__ at 0x7f64fbe86670&gt;}
)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">insert_into_namespace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name_space</span><span class="o">=</span><span class="nb">globals</span><span class="p">()):</span>
    <span class="n">name_space</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>

        </details>

    

                </section>
                <section id="add_to">
                            <div class="attr function"><a class="headerlink" href="#add_to">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_to</span><span class="signature">(l, e)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_to</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add element e to list l, but check if the entry already exist. If so, throw</span>
<span class="sd">    exception. Otherwise add</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># if not present, append element</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>add element e to list l, but check if the entry already exist. If so, throw
exception. Otherwise add</p>
</div>


                </section>
                <section id="get_plot_layout">
                            <div class="attr function"><a class="headerlink" href="#get_plot_layout">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_plot_layout</span><span class="signature">(obj)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_plot_layout</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function which selects a row, column layout based on the number of</span>
<span class="sd">    objects to display.  The expected argument is a reservoir object which</span>
<span class="sd">    contains the list of fluxes in the reservoir</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">noo</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>
        <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># noo = len(obj.lof) + 1  # number of objects in this reservoir</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">noo</span><span class="si">}</span><span class="s2"> subplots for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> required&quot;</span><span class="p">)</span>

    <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>
</pre></div>

        </details>

            <div class="docstring"><p>Simple function which selects a row, column layout based on the number of
objects to display.  The expected argument is a reservoir object which
contains the list of fluxes in the reservoir</p>
</div>


                </section>
                <section id="plot_geometry">
                            <div class="attr function"><a class="headerlink" href="#plot_geometry">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot_geometry</span><span class="signature">(noo: int) -&gt; ()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Define plot geometry based on number of objects to plot&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># one row, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># two rows, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># two rows, two columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;plot geometry for more than 15 fluxes is not yet defined&quot;</span>
            <span class="s2">&quot;Consider calling flux.plot individually on each flux in the reservoir&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>
</pre></div>

        </details>

            <div class="docstring"><p>Define plot geometry based on number of objects to plot</p>
</div>


                </section>
                <section id="list_fluxes">
                            <div class="attr function"><a class="headerlink" href="#list_fluxes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_fluxes</span><span class="signature">(self, name, i) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">list_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Echo all fluxes in the reservoir to the screen</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">List of fluxes in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># show the processes</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Outflux from&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;To  :&quot;</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Influx to&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> via </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># print out the flux data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Echo all fluxes in the reservoir to the screen</p>
</div>


                </section>
                <section id="show_data">
                            <div class="attr function"><a class="headerlink" href="#show_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">show_data</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Print the 3 lines of the data starting with index</span>

<span class="sd">    Optional arguments:</span>

<span class="sd">    index :int = 0 starting index</span>
<span class="sd">    indent :int = 0 indentation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
    <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># show the first 4 entries</span>
    <span class="c1"># for i in range(index, index + 3):</span>
    <span class="c1">#     print(f&quot;{off}{ind}i = {i}, Mass = {self.m[i]:.2e}, li= {self.l[i]:.2f}&quot;)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Print the 3 lines of the data starting with index</p>

<p>Optional arguments:</p>

<p>index :int = 0 starting index
indent :int = 0 indentation</p>
</div>


                </section>
                <section id="set_y_limits">
                            <div class="attr function"><a class="headerlink" href="#set_y_limits">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">set_y_limits</span><span class="signature">(ax: matplotlib.axes._axes.Axes, obj: &lt;built-in function any&gt;) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">set_y_limits</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prevent the display or arbitrarily small differences&quot;&quot;&quot;</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span><span class="p">:</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Prevent the display or arbitrarily small differences</p>
</div>


                </section>
                <section id="is_name_in_list">
                            <div class="attr function"><a class="headerlink" href="#is_name_in_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">is_name_in_list</span><span class="signature">(n: str, l: list) -&gt; bool</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_name_in_list</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if an object name is part of the object list&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">n</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Test if an object name is part of the object list</p>
</div>


                </section>
                <section id="get_object_from_list">
                            <div class="attr function"><a class="headerlink" href="#get_object_from_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_object_from_list</span><span class="signature">(name: str, l: list) -&gt; &lt;built-in function any&gt;</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Match a name to a list of objects. Return the object&quot;&quot;&quot;</span>

    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object = </span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no matching flux </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Match a name to a list of objects. Return the object</p>
</div>


                </section>
                <section id="sort_by_type">
                            <div class="attr function"><a class="headerlink" href="#sort_by_type">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sort_by_type</span><span class="signature">(l: list, t: list, m: str) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sort_by_type</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;divide a list by type into new lists. This function will return a</span>
<span class="sd">    list and it is up to the calling code to unpack the list</span>

<span class="sd">    l is list with various object types</span>
<span class="sd">    t is a list which contains the object types used for sorting</span>
<span class="sd">    m is a string for the error function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from numbers import Number</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>  <span class="c1"># loop over object types</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># loop over list elements</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ot</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># add to temporary list</span>
                <span class="n">lc</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># remove this element</span>

        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># save the temporary list to rl</span>

    <span class="c1"># at this point, all elements of lc should have been processed</span>
    <span class="c1"># if not, lc contains element which are of a different type</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rl</span>
</pre></div>

        </details>

            <div class="docstring"><p>divide a list by type into new lists. This function will return a
list and it is up to the calling code to unpack the list</p>

<p>l is list with various object types
t is a list which contains the object types used for sorting
m is a string for the error function</p>
</div>


                </section>
                <section id="get_object_handle">
                            <div class="attr function"><a class="headerlink" href="#get_object_handle">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_object_handle</span><span class="signature">(res, M)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_object_handle</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test if we the key is a global reservoir handle</span>
<span class="sd">    or exists in the model namespace</span>

<span class="sd">    res: list, str, or reservoir handle</span>
<span class="sd">    M: Model handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rlist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span>  <span class="c1"># is object known in global namespace</span>
            <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>  <span class="c1"># or does it exist in Model namespace</span>
            <span class="n">rlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2"> is not known for model </span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rlist</span>
</pre></div>

        </details>

            <div class="docstring"><p>Test if we the key is a global reservoir handle
or exists in the model namespace</p>

<p>res: list, str, or reservoir handle
M: Model handle</p>
</div>


                </section>
                <section id="split_key">
                            <div class="attr function"><a class="headerlink" href="#split_key">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">split_key</span><span class="signature">(
    k: str,
    M: &lt;built-in function any&gt;
) -&gt; Union[&lt;built-in function any&gt;, str]</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">split_key</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;split the string k with letters _to_, and test if optional</span>
<span class="sd">    id string is present</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;_to_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name must follow &#39;Source_to_Sink&#39; format&quot;</span><span class="p">)</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sinkandid</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">sinkandid</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">sink</span> <span class="o">=</span> <span class="n">get_object_handle</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">get_object_handle</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>split the string k with letters _to_, and test if optional
id string is present</p>
</div>


                </section>
                <section id="make_dict">
                            <div class="attr function"><a class="headerlink" href="#make_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">make_dict</span><span class="signature">(keys: list, values: list) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">make_dict</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a dictionary from a list and value, or from</span>
<span class="sd">    two lists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len values =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">, len keys =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values = </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;key and value list must be of equal length&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a dictionary from a list and value, or from
two lists</p>
</div>


                </section>
                <section id="get_typed_list">
                            <div class="attr function"><a class="headerlink" href="#get_typed_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_typed_list</span><span class="signature">(data: list) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_typed_list</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tl</span>
</pre></div>

        </details>

    

                </section>
                <section id="create_reservoirs">
                            <div class="attr function"><a class="headerlink" href="#create_reservoirs">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_reservoirs</span><span class="signature">(bn: dict, ic: dict, M: &lt;built-in function any&gt;) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_reservoirs</span><span class="p">(</span><span class="n">bn</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;boxes are defined by area and depth interval here we use an ordered</span>
<span class="sd">    dictionary to define the box geometries. The next column is temperature</span>
<span class="sd">    in deg C, followed by pressure in bar</span>
<span class="sd">    the geometry is [upper depth datum, lower depth datum, area percentage]</span>

<span class="sd">    bn = dictionary with box parameters</span>
<span class="sd">    bn: dict = {  # name: [[geometry], T, P]</span>
<span class="sd">                 &quot;sb&quot;: {&quot;g&quot;: [0, 200, 0.9], &quot;T&quot;: 20, &quot;P&quot;: 5},</span>
<span class="sd">                 &quot;ib&quot;: {&quot;g&quot;: [200, 1200, 1], &quot;T&quot;: 10, &quot;P&quot;: 100},</span>
<span class="sd">                }</span>

<span class="sd">    ic = dictionary with species default values. This is used to et up</span>
<span class="sd">         initial conditions. Here we use shortcut and use the same conditions</span>
<span class="sd">         in each box. If you need box specific initial conditions</span>
<span class="sd">         use the output of build_concentration_dicts as starting point</span>

<span class="sd">    ic: dict = { # species: concentration, Isotopes</span>
<span class="sd">                   PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">                   DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">                   ALK: [Q_(&quot;2.43 mmol/liter&quot;), False],</span>
<span class="sd">               }</span>

<span class="sd">    M: Model object handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">build_concentration_dicts</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span>

    <span class="c1"># parse for sources and sinks, create these and remove them from the list</span>

    <span class="c1"># loop over reservoir names</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># test key format</span>
        <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># type is given</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span>
                <span class="n">SourceGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sink&quot;</span><span class="p">:</span>
                <span class="n">SinkGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;ty&#39; must be either Source or Sink&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># create reservoirs</span>

            <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">build_concentration_dicts</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

            <span class="n">rg</span> <span class="o">=</span> <span class="n">ReservoirGroup</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">seawater_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span> <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]},</span>
                <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">icd</span>
</pre></div>

        </details>

            <div class="docstring"><p>boxes are defined by area and depth interval here we use an ordered
dictionary to define the box geometries. The next column is temperature
in deg C, followed by pressure in bar
the geometry is [upper depth datum, lower depth datum, area percentage]</p>

<p>bn = dictionary with box parameters
bn: dict = {  # name: [[geometry], T, P]
             "sb": {"g": [0, 200, 0.9], "T": 20, "P": 5},
             "ib": {"g": [200, 1200, 1], "T": 10, "P": 100},
            }</p>

<p>ic = dictionary with species default values. This is used to et up
     initial conditions. Here we use shortcut and use the same conditions
     in each box. If you need box specific initial conditions
     use the output of build_concentration_dicts as starting point</p>

<p>ic: dict = { # species: concentration, Isotopes
               PO4: [Q_("2.1 * umol/liter"), False],
               DIC: [Q_("2.1 mmol/liter"), False],
               ALK: [Q_("2.43 mmol/liter"), False],
           }</p>

<p>M: Model object handle</p>
</div>


                </section>
                <section id="build_concentration_dicts">
                            <div class="attr function"><a class="headerlink" href="#build_concentration_dicts">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_concentration_dicts</span><span class="signature">(cd: dict, bg: dict) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_concentration_dicts</span><span class="p">(</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build a dict which can be used by create_reservoirs</span>

<span class="sd">    bg : dict where the box_names are dict keys.</span>
<span class="sd">    cd: dictionary with the following format:</span>
<span class="sd">        cd = {</span>
<span class="sd">             # species: [concentration, isotopes]</span>
<span class="sd">             PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">             DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">            }</span>

<span class="sd">    This function returns a new dict in the following format</span>

<span class="sd">    #  box_names: [concentrations, isotopes]</span>
<span class="sd">    d= {&quot;bn&quot;: [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>

    <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">td1</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td2</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td3</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>

    <span class="c1"># create the dicts for concentration and isotopes</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">td1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">td2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">td3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># box_names: list = bg.keys()</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">box_names</span><span class="p">:</span>  <span class="c1"># loop over box names</span>
        <span class="n">icd</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">td1</span><span class="p">,</span> <span class="n">td2</span><span class="p">,</span> <span class="n">td3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">icd</span>
</pre></div>

        </details>

            <div class="docstring"><p>Build a dict which can be used by create_reservoirs</p>

<p>bg : dict where the box_names are dict keys.
cd: dictionary with the following format:
    cd = {
         # species: [concentration, isotopes]
         PO4: [Q_("2.1 * umol/liter"), False],
         DIC: [Q_("2.1 mmol/liter"), False],
        }</p>

<p>This function returns a new dict in the following format</p>

<h1 id="box_names-concentrations-isotopes">box_names: [concentrations, isotopes]</h1>

<p>d= {"bn": [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</p>
</div>


                </section>
                <section id="calc_volumes">
                            <div class="attr function"><a class="headerlink" href="#calc_volumes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">calc_volumes</span><span class="signature">(
    bg: dict,
    M: &lt;built-in function any&gt;,
    h: &lt;built-in function any&gt;
) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">calc_volumes</span><span class="p">(</span><span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume contained in a given depth interval</span>
<span class="sd">    bg is an ordered dictionary in the following format</span>

<span class="sd">    bg=  {</span>
<span class="sd">          &quot;hb&quot;: (0.1, 0, 200),</span>
<span class="sd">          &quot;sb&quot;: (0.9, 0, 200),</span>
<span class="sd">         }</span>

<span class="sd">    where the key must be a valid box name, the first entry of the list denoted</span>
<span class="sd">    the areal extent in percent, the second number is upper depth limit, and last</span>
<span class="sd">    number is the lower depth limit.</span>

<span class="sd">    M must be a model handle</span>
<span class="sd">    h is the hypsometry handle</span>

<span class="sd">    The function returns a list with the corresponding volumes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from esbmtk import hypsometry</span>

    <span class="n">v</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of volumes</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate volume contained in a given depth interval
bg is an ordered dictionary in the following format</p>

<p>bg=  {
      "hb": (0.1, 0, 200),
      "sb": (0.9, 0, 200),
     }</p>

<p>where the key must be a valid box name, the first entry of the list denoted
the areal extent in percent, the second number is upper depth limit, and last
number is the lower depth limit.</p>

<p>M must be a model handle
h is the hypsometry handle</p>

<p>The function returns a list with the corresponding volumes</p>
</div>


                </section>
                <section id="get_longest_dict_entry">
                            <div class="attr function"><a class="headerlink" href="#get_longest_dict_entry">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_longest_dict_entry</span><span class="signature">(d: dict) -&gt; int</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_longest_dict_entry</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get length of each item in the connection dict&quot;&quot;&quot;</span>
    <span class="n">l_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of  longest list</span>
    <span class="n">p_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of single parameter</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of lists</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># we need to cover the case where we have two lists of different length</span>
    <span class="c1"># this happens if we have a long list of tuples with matched references,</span>
    <span class="c1"># as well as a list of species</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l_length</span><span class="p">:</span>
                <span class="n">l_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_length</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_length</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ll</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">l_length</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mapping for multiple lists is not supported&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only lists present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Only parameters present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Lists and parameters present</span>

    <span class="k">return</span> <span class="n">case</span><span class="p">,</span> <span class="n">l_length</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get length of each item in the connection dict</p>
</div>


                </section>
                <section id="convert_to_lists">
                            <div class="attr function"><a class="headerlink" href="#convert_to_lists">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">convert_to_lists</span><span class="signature">(d: dict, l: int) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_to_lists</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;expand mixed dict entries (i.e. list and single value) such</span>
<span class="sd">    that they are all lists of equal length</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>expand mixed dict entries (i.e. list and single value) such
that they are all lists of equal length</p>
</div>


                </section>
                <section id="get_sub_key">
                            <div class="attr function"><a class="headerlink" href="#get_sub_key">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_sub_key</span><span class="signature">(d: dict, i: int) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_sub_key</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;take a dict which has where the value is a list, and return the</span>
<span class="sd">    key with the n-th value of that list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

        </details>

            <div class="docstring"><p>take a dict which has where the value is a list, and return the
key with the n-th value of that list</p>
</div>


                </section>
                <section id="expand_dict">
                            <div class="attr function"><a class="headerlink" href="#expand_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">expand_dict</span><span class="signature">(d: dict, mt: str = &#39;1:1&#39;) -&gt; int</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Determine dict structure</span>

<span class="sd">    in case we have mutiple connections with mutiple species, the</span>
<span class="sd">    default action is to map connections to species (t = &#39;1:1&#39;). If</span>
<span class="sd">    you rather want to create mutiple connections (one for each</span>
<span class="sd">    species) in each connection set t = &#39;1:N&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loop over dict entries</span>
    <span class="c1"># ck = connection key</span>
    <span class="c1"># cd = connection dict</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># the dict we will return</span>

    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># loop over connections</span>

        <span class="c1"># print(f&quot;ck = {ck}&quot;)</span>
        <span class="c1"># print(f&quot;cd = {cd}&quot;)</span>

        <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">nd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">case</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">get_longest_dict_entry</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

        <span class="c1"># print(f&quot;length = {length}&quot;)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># assume 1:1 mapping between tuple and connection parameters</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:1&quot;</span><span class="p">:</span>

                <span class="c1"># prep dictionaries</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                    <span class="c1"># print(&quot;case 0&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(&quot;case 1&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="c1"># print(f&quot;case 2, length = {length}&quot;)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(nd)</span>

                <span class="c1"># for each connection group in the tuple</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The number of connection properties (</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;does not match the number of connection groups (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;did you intend to do a 1:N mapping?&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># map property dicts to connection group names</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_sub_key</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:N&quot;</span><span class="p">:</span>  <span class="c1"># apply each species to each connection</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>  <span class="c1"># apply the entire nd dict to all connections</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s2"> is not defined. must be &#39;1:1&#39; or &#39;1:N&#39;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>  <span class="c1"># only lists present, case 3</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># list and parameters present case 4</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">rd</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>

        <span class="c1"># update the overall dict and move to the next entry</span>
        <span class="n">r</span> <span class="o">|=</span> <span class="n">rd</span>

    <span class="k">return</span> <span class="n">r</span>
</pre></div>

        </details>

            <div class="docstring"><p>Determine dict structure</p>

<p>in case we have mutiple connections with mutiple species, the
default action is to map connections to species (t = '1:1'). If
you rather want to create mutiple connections (one for each
species) in each connection set t = '1:N'</p>
</div>


                </section>
                <section id="create_bulk_connections">
                            <div class="attr function"><a class="headerlink" href="#create_bulk_connections">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_bulk_connections</span><span class="signature">(ct: dict, M: &lt;built-in function any&gt;, mt: int = &#39;1:1&#39;) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_bulk_connections</span><span class="p">(</span><span class="n">ct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create connections from a dictionary. The dict can have the following keys</span>
<span class="sd">    following format:</span>

<span class="sd">    mt = mapping type. See below for explanation</span>

<span class="sd">    # na: names, tuple or str. If lists, all list elements share the same properties</span>
<span class="sd">    # sp: species list or species</span>
<span class="sd">    # ty: type, str</span>
<span class="sd">    # ra: rate, Quantity</span>
<span class="sd">    # sc: scale, Number</span>
<span class="sd">    # re: reference, optional</span>
<span class="sd">    # al: alpha, optional</span>
<span class="sd">    # de: delta, optional</span>
<span class="sd">    # bp: bypass, see scale_with_flux</span>
<span class="sd">    # si: signal</span>
<span class="sd">    # mx: True, optional defaults to False. If set, it will create forward</span>
<span class="sd">          and backward fluxes (i.e. mixing)</span>

<span class="sd">    There are 6 different cases how to specify connections</span>

<span class="sd">    Case 1 One connection, one set of parameters</span>
<span class="sd">           ct1 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;....}}</span>

<span class="sd">    Case 2 One connection, one set of instructions, one subset with multiple parameters</span>
<span class="sd">           This will be expanded to create connections for each species</span>
<span class="sd">           ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 3 One connection complete set of multiple characters. Similar to case 2, but now</span>
<span class="sd">           all parameters are given explicitly</span>
<span class="sd">           ct3 = {&quot;sb2hb&quot;: {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 4 Multiple connections, one set of parameters. This will create</span>
<span class="sd">           identical connection for &quot;sb2hb&quot; and  &quot;ib2db&quot;</span>
<span class="sd">           ct4 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;: ...}}</span>

<span class="sd">    Case 5 Multiple connections, one subset of multiple set of parameters. This wil</span>
<span class="sd">          create a connection for species &#39;a&#39; in sb2hb and with species &#39;b&#39; in ib2db</span>
<span class="sd">           ct5 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 6 Multiple connections, complete set of parameters of multiple parameters</span>
<span class="sd">           Same as case 5, but now all parameters are specified explicitly</span>
<span class="sd">           ct6 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>


<span class="sd">    The default interpretation for cases 5 and 6 is that each list</span>
<span class="sd">    entry corresponds to connection. However, sometimes we want to</span>
<span class="sd">    create multiple connections for multiple entries. In this case</span>
<span class="sd">    provide the mt=&#39;1:N&#39; parameter which will create a connection for</span>
<span class="sd">    each species in each connection group. See the below example.</span>

<span class="sd">    It is easy to shoot yourself in the foot. It is best to try the above first with</span>
<span class="sd">    some simple examples, e.g.,</span>

<span class="sd">    from esbmtk import expand_dict</span>
<span class="sd">    ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    It is best to use the show_dict function to verify that your input</span>
<span class="sd">    dictionary produces the correct results!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">expand_dict</span>

    <span class="c1"># expand dictionary into a well formed dict where each connection</span>
    <span class="c1"># has a fully formed entry</span>
    <span class="n">c_ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">)</span>

    <span class="c1"># loop over dict entries and create the respective connections</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># loop over names in tuple</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">create_connection</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">create_connection</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> must be string or tuple&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ct</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create connections from a dictionary. The dict can have the following keys
following format:</p>

<p>mt = mapping type. See below for explanation</p>

<h1 id="na-names-tuple-or-str-if-lists-all-list-elements-share-the-same-properties">na: names, tuple or str. If lists, all list elements share the same properties</h1>

<h1 id="sp-species-list-or-species">sp: species list or species</h1>

<h1 id="ty-type-str">ty: type, str</h1>

<h1 id="ra-rate-quantity">ra: rate, Quantity</h1>

<h1 id="sc-scale-number">sc: scale, Number</h1>

<h1 id="re-reference-optional">re: reference, optional</h1>

<h1 id="al-alpha-optional">al: alpha, optional</h1>

<h1 id="de-delta-optional">de: delta, optional</h1>

<h1 id="bp-bypass-see-scale_with_flux">bp: bypass, see scale_with_flux</h1>

<h1 id="si-signal">si: signal</h1>

<h1 id="mx-true-optional-defaults-to-false-if-set-it-will-create-forward">mx: True, optional defaults to False. If set, it will create forward</h1>

<pre><code>  and backward fluxes (i.e. mixing)
</code></pre>

<p>There are 6 different cases how to specify connections</p>

<p>Case 1 One connection, one set of parameters
       ct1 = {"sb2hb": {"ty": "scale", 'ra'....}}</p>

<p>Case 2 One connection, one set of instructions, one subset with multiple parameters
       This will be expanded to create connections for each species
       ct2 = {"sb2hb": {"ty": "scale", "sp": ["a", "b"]}}</p>

<p>Case 3 One connection complete set of multiple characters. Similar to case 2, but now
       all parameters are given explicitly
       ct3 = {"sb2hb": {"ty": ["scale", "scale"], "sp": ["a", "b"]}}</p>

<p>Case 4 Multiple connections, one set of parameters. This will create
       identical connection for "sb2hb" and  "ib2db"
       ct4 = {("sb2hb", "ib2db"): {"ty": "scale", 'ra': ...}}</p>

<p>Case 5 Multiple connections, one subset of multiple set of parameters. This wil
      create a connection for species 'a' in sb2hb and with species 'b' in ib2db
       ct5 = {("sb2hb", "ib2db"): {"ty": "scale", "sp": ["a", "b"]}}</p>

<p>Case 6 Multiple connections, complete set of parameters of multiple parameters
       Same as case 5, but now all parameters are specified explicitly
       ct6 = {("sb2hb", "ib2db"): {"ty": ["scale", "scale"], "sp": ["a", "b"]}}</p>

<p>The default interpretation for cases 5 and 6 is that each list
entry corresponds to connection. However, sometimes we want to
create multiple connections for multiple entries. In this case
provide the mt='1:N' parameter which will create a connection for
each species in each connection group. See the below example.</p>

<p>It is easy to shoot yourself in the foot. It is best to try the above first with
some simple examples, e.g.,</p>

<p>from esbmtk import expand_dict
ct2 = {"sb2hb": {"ty": "scale", "sp": ["a", "b"]}}</p>

<p>It is best to use the show_dict function to verify that your input
dictionary produces the correct results!</p>
</div>


                </section>
                <section id="create_connection">
                            <div class="attr function"><a class="headerlink" href="#create_connection">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_connection</span><span class="signature">(n: str, p: dict, M: &lt;built-in function any&gt;) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;called by create_bulk_connections in order to create a connection</span>
<span class="sd">    group It is assumed that all rates are in liter/year or mol per</span>
<span class="sd">    year. This may not be what you want or need.</span>

<span class="sd">    n: a connection key e.g., sb2db@mix which will be</span>
<span class="sd">    interpreted as mixing a connection between sb and db and thus</span>
<span class="sd">    create connections in both directions</span>

<span class="sd">    p: a dictionary holding  the connection properties</span>

<span class="sd">    M: the model handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># get the reservoir handles by splitting the key</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">split_key</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
    <span class="c1"># create default connections parameters and replace with values in</span>
    <span class="c1"># the parameter dict if present.</span>
    <span class="n">los</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]]</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="s2">&quot;sc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sc&quot;</span><span class="p">]</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;0 mol/a&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;re&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;re&quot;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;al&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;al&quot;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;de&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">]</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;bp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;bp&quot;</span><span class="p">]</span>
    <span class="n">species</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;sp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="s2">&quot;si&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;si&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;l/a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># expand arguments</span>
    <span class="n">ctype</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ctype</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># get rate from dictionary</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="n">ref_flux</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref_flux</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
    <span class="n">bypass</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">bypass</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>

    <span class="c1"># name of connectiongroup</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.CG_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>  <span class="c1"># Test if CG exists</span>
        <span class="c1"># retriece CG object</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">add_connections</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
            <span class="n">ref_flux</span><span class="o">=</span><span class="n">ref_flux</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="n">bypass</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Create New ConnectionGroup</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">ConnectionGroup</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span>
            <span class="n">ref_flux</span><span class="o">=</span><span class="n">ref_flux</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="n">bypass</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>called by create_bulk_connections in order to create a connection
group It is assumed that all rates are in liter/year or mol per
year. This may not be what you want or need.</p>

<p>n: a connection key e.g., sb2db@mix which will be
interpreted as mixing a connection between sb and db and thus
create connections in both directions</p>

<p>p: a dictionary holding  the connection properties</p>

<p>M: the model handle</p>
</div>


                </section>
                <section id="get_name_only">
                            <div class="attr function"><a class="headerlink" href="#get_name_only">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_name_only</span><span class="signature">(o: &lt;built-in function any&gt;) -&gt; &lt;built-in function any&gt;</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_name_only</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if item is an esbmtk type. If yes, extract the name&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">Species</span>

    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">Species</span><span class="p">))</span> <span class="k">else</span> <span class="n">o</span>
</pre></div>

        </details>

            <div class="docstring"><p>Test if item is an esbmtk type. If yes, extract the name</p>
</div>


                </section>
                <section id="get_simple_list">
                            <div class="attr function"><a class="headerlink" href="#get_simple_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_simple_list</span><span class="signature">(l: list) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_simple_list</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;return a list which only has the full name</span>
<span class="sd">    rather than all the object properties</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">get_name_only</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>return a list which only has the full name
rather than all the object properties</p>
</div>


                </section>
                <section id="show_dict">
                            <div class="attr function"><a class="headerlink" href="#show_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">show_dict</span><span class="signature">(d: dict, mt: str = &#39;1:1&#39;) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">show_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;show dict entries in an organized manner&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">expand_dict</span><span class="p">,</span> <span class="n">get_simple_list</span><span class="p">,</span> <span class="n">get_name_only</span>

    <span class="n">ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">get_simple_list</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">get_name_only</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">pk</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>show dict entries in an organized manner</p>
</div>


                </section>
                <section id="find_matching_fluxes">
                            <div class="attr function"><a class="headerlink" href="#find_matching_fluxes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">find_matching_fluxes</span><span class="signature">(l: list, filter_by: str, exclude: str) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">find_matching_fluxes</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">filter_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Loop over all reservoir in l, and extract the names of all fluxes</span>
<span class="sd">    which match the filter string. Return the list of names (not objects!)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lof</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_by</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">and</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">lof</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">lof</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Loop over all reservoir in l, and extract the names of all fluxes
which match the filter string. Return the list of names (not objects!)</p>
</div>


                </section>
                <section id="reverse_key">
                            <div class="attr function"><a class="headerlink" href="#reverse_key">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">reverse_key</span><span class="signature">(key: str) -&gt; str</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reverse_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;reverse a connection key e.g., sb2db@POM becomes db2sb@POM&quot;&quot;&quot;</span>

    <span class="c1"># print(f&quot;key = {key}&quot;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># right = l[1]</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>reverse a connection key e.g., sb2db@POM becomes db2sb@POM</p>
</div>


                </section>
                <section id="get_connection_keys">
                            <div class="attr function"><a class="headerlink" href="#get_connection_keys">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_connection_keys</span><span class="signature">(s: set, fstr: str, nstr: str, inverse: bool, exclude: str) -&gt; list</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_connection_keys</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span> <span class="n">fstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;extract connection keys from set of flux names, replace fstr with</span>
<span class="sd">    nstr so that the key can be used in create_bulk_connnections()</span>

<span class="sd">    The optional inverse parameter, can be used where in cases where the</span>
<span class="sd">    flux direction needs to be reversed, i.e., the returned key will not read</span>
<span class="sd">    sb2db@POM, but db2s@POM</span>

<span class="sd">    E.g., if</span>

<span class="sd">    s = ( M4.CG_P_sb2P_ib.PO4.POP_F)</span>
<span class="sd">    fstr = &quot;POP&quot;</span>
<span class="sd">    nstr = &quot;POM_DIC&quot;</span>

<span class="sd">    M4.CG_P_sb2P_ib.PO4.POP_F will become</span>

<span class="sd">    P_sb_to_P_ib@POM_DIC</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="c1"># get connection and flux name</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># get key without leadinf C_</span>
        <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">reverse_key</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
        <span class="n">cn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fstr</span><span class="p">,</span> <span class="n">nstr</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">nstr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cl</span>
</pre></div>

        </details>

            <div class="docstring"><p>extract connection keys from set of flux names, replace fstr with
nstr so that the key can be used in create_bulk_connnections()</p>

<p>The optional inverse parameter, can be used where in cases where the
flux direction needs to be reversed, i.e., the returned key will not read
sb2db@POM, but db2s@POM</p>

<p>E.g., if</p>

<p>s = ( M4.CG_P_sb2P_ib.PO4.POP_F)
fstr = "POP"
nstr = "POM_DIC"</p>

<p>M4.CG_P_sb2P_ib.PO4.POP_F will become</p>

<p>P_sb_to_P_ib@POM_DIC</p>
</div>


                </section>
                <section id="gen_dict_entries">
                            <div class="attr function"><a class="headerlink" href="#gen_dict_entries">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">gen_dict_entries</span><span class="signature">(M: &lt;built-in function any&gt;, **kwargs) -&gt; tuple</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">gen_dict_entries</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;find all fluxes which contain the reference string, and create</span>
<span class="sd">    matching keys which contain the target string. The function will</span>
<span class="sd">    return two lists, which can be used to create a dict for the</span>
<span class="sd">    create_bulk_connnection function.</span>

<span class="sd">    E.g., to create a dict which will create new fluxes based on</span>
<span class="sd">    existing fluxes</span>

<span class="sd">    dk:list, fl:list = gen_dict_entries(ref_id = &#39;POP&#39;, target_id = &#39;POM&#39;)</span>

<span class="sd">    this will find all fluxes with the POP-id and put these into</span>
<span class="sd">    fl. It will also generate a list with suitable connections keys</span>
<span class="sd">    (dk) which contain the &#39;POM&#39; id.</span>

<span class="sd">    The optional inverse parameter, can be used where in cases where the</span>
<span class="sd">    flux direction needs to be reversed, i.e., the returned key will not read</span>
<span class="sd">    sb_to_dbPOM, but db_to_sb@POM</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span>

    <span class="n">reference</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_id&quot;</span><span class="p">]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">]</span>
    <span class="n">inverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inverse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">exclude_str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">flist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">find_matching_fluxes</span><span class="p">(</span>
            <span class="n">M</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="n">filter_by</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_str</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">flist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">find_matching_fluxes</span><span class="p">(</span>
            <span class="n">M</span><span class="p">,</span>
            <span class="n">filter_by</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_str</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gen_dict_entries: M must be list or Model, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">klist</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">get_connection_keys</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">inverse</span><span class="p">,</span> <span class="n">exclude_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">klist</span><span class="p">),</span> <span class="n">flist</span>
</pre></div>

        </details>

            <div class="docstring"><p>find all fluxes which contain the reference string, and create
matching keys which contain the target string. The function will
return two lists, which can be used to create a dict for the
create_bulk_connnection function.</p>

<p>E.g., to create a dict which will create new fluxes based on
existing fluxes</p>

<p>dk:list, fl:list = gen_dict_entries(ref_id = 'POP', target_id = 'POM')</p>

<p>this will find all fluxes with the POP-id and put these into
fl. It will also generate a list with suitable connections keys
(dk) which contain the 'POM' id.</p>

<p>The optional inverse parameter, can be used where in cases where the
flux direction needs to be reversed, i.e., the returned key will not read
sb_to_dbPOM, but db_to_sb@POM</p>
</div>


                </section>
                <section id="build_ct_dict">
                            <div class="attr function"><a class="headerlink" href="#build_ct_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_ct_dict</span><span class="signature">(d: dict, p: dict) -&gt; dict</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_ct_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;build a connection dictionary from a dict containing connection</span>
<span class="sd">    keys, and a dict containing connection properties. This is most</span>
<span class="sd">    useful for connections which a characterized by a fixed rate but</span>
<span class="sd">    apply to many species. E.g., mixing fluxes in a complex model etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sc&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="o">|</span> <span class="n">p</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>

        </details>

            <div class="docstring"><p>build a connection dictionary from a dict containing connection
keys, and a dict containing connection properties. This is most
useful for connections which a characterized by a fixed rate but
apply to many species. E.g., mixing fluxes in a complex model etc.</p>
</div>


                </section>
                <section id="get_string_between_brackets">
                            <div class="attr function"><a class="headerlink" href="#get_string_between_brackets">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_string_between_brackets</span><span class="signature">(s: str) -&gt; str</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_string_between_brackets</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse string and extract substring between square brackets&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse string and extract substring between square brackets</p>
</div>


                </section>
                <section id="check_for_quantity">
                            <div class="attr function"><a class="headerlink" href="#check_for_quantity">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">check_for_quantity</span><span class="signature">(kw) -&gt; pint.util.Quantity</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">check_for_quantity</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Q_</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;check if keyword is quantity or string an convert as necessary</span>

<span class="sd">    kw = str or Q_</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kw must be string or Quantity&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kw</span>
</pre></div>

        </details>

            <div class="docstring"><p>check if keyword is quantity or string an convert as necessary</p>

<p>kw = str or Q_</p>
</div>


                </section>
                <section id="map_units">
                            <div class="attr function"><a class="headerlink" href="#map_units">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">map_units</span><span class="signature">(v: &lt;built-in function any&gt;, *args) -&gt; float</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_units</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;parse v to see if it is a string. if yes, map to quantity.</span>
<span class="sd">    parse v to see if it is a quantity, if yes, map to model units</span>
<span class="sd">    and extract magnitude, assign mangitude to return value</span>
<span class="sd">    if not, assign value to return value</span>

<span class="sd">    v : a keyword value number/string/quantity</span>
<span class="sd">    args: one or more quantities (units) see the Model class (e.g., f_unit)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># test if string, map to quantity if yes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># test if we find a matching dimension, map if true</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is none of </span><span class="si">{</span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no quantity, so it should be a number</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">, must be float, v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">. Something is fishy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>

        </details>

            <div class="docstring"><p>parse v to see if it is a string. if yes, map to quantity.
parse v to see if it is a quantity, if yes, map to model units
and extract magnitude, assign mangitude to return value
if not, assign value to return value</p>

<p>v : a keyword value number/string/quantity
args: one or more quantities (units) see the Model class (e.g., f_unit)</p>
</div>


                </section>
                <section id="add_carbonate_system_1">
                            <div class="attr function"><a class="headerlink" href="#add_carbonate_system_1">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_carbonate_system_1</span><span class="signature">(rgs: list)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_carbonate_system_1</span><span class="p">(</span><span class="n">rgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new carbonate system virtual reservoir for each</span>
<span class="sd">    reservoir in rgs. Note that rgs must be a list of reservoir groups.</span>

<span class="sd">    Required keywords:</span>
<span class="sd">        rgs: list = []  of Reservoir Group objects</span>

<span class="sd">    These new virtual reservoirs are registered to their respective Reservoir</span>
<span class="sd">    as &#39;cs&#39;.</span>

<span class="sd">    The respective data fields are available as rgs.r.cs.xxx where xxx stands</span>
<span class="sd">    for a given key key in the  vr_datafields dictionary (i.e., H, CA, etc.)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ExternalCode</span><span class="p">,</span>
        <span class="n">calc_carbonates_1</span><span class="p">,</span>
        <span class="n">carbonate_system_1_ode</span><span class="p">,</span>
        <span class="n">Reservoir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># get object handle even if it defined in model namespace</span>
    <span class="c1"># rgs = get_object_handle(rgs)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">rgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Carbon</span><span class="o">.</span><span class="n">CO2</span>

    <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">rgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">use_ode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">carbonate_system_1_ode</span><span class="p">,</span>
                    <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs1&quot;</span><span class="p">,</span>
                    <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4</span>
                    <span class="p">},</span>
                    <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                    <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                    <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                    <span class="n">return_values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Hplus&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ec</span><span class="o">.</span><span class="n">return_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rt</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">species</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                        <span class="n">concentration</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> mol/kg&quot;</span><span class="p">,</span>
                        <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                        <span class="n">volume</span><span class="o">=</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                        <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;computed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_1</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs1&quot;</span><span class="p">,</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4</span>
                <span class="p">},</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">([</span><span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1">#</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="c1"># return_values=&quot;H CA HCO3 CO3 CO2aq&quot;.split(&quot; &quot;),</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rg</span><span class="o">.</span><span class="n">has_cs1</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rg</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> must have a TA and DIC reservoir&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Creates a new carbonate system virtual reservoir for each
reservoir in rgs. Note that rgs must be a list of reservoir groups.</p>

<p>Required keywords:
    rgs: list = []  of Reservoir Group objects</p>

<p>These new virtual reservoirs are registered to their respective Reservoir
as 'cs'.</p>

<p>The respective data fields are available as rgs.r.cs.xxx where xxx stands
for a given key key in the  vr_datafields dictionary (i.e., H, CA, etc.)</p>
</div>


                </section>
                <section id="add_carbonate_system_2">
                            <div class="attr function"><a class="headerlink" href="#add_carbonate_system_2">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_carbonate_system_2</span><span class="signature">(**kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_carbonate_system_2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates a new carbonate system virtual reservoir</span>
<span class="sd">        which will compute carbon species, saturation, compensation,</span>
<span class="sd">        and snowline depth, and compute the associated carbonate burial fluxes</span>

<span class="sd">        Required keywords:</span>
<span class="sd">            r_sb: list of ReservoirGroup objects in the surface layer</span>
<span class="sd">            r_db: list of ReservoirGroup objects in the deep layer</span>
<span class="sd">            carbonate_export_fluxes: list of flux objects which must match the</span>
<span class="sd">                                     list of ReservoirGroup objects.</span>
<span class="sd">            zsat_min = depth of the upper boundary of the deep box</span>
<span class="sd">            z0 = upper depth limit for carbonate burial calculations</span>
<span class="sd">                 typically zsat_min</span>

<span class="sd">        Optional Parameters:</span>

<span class="sd">            zsat = initial saturation depth (m)</span>
<span class="sd">            zcc = initial carbon compensation depth (m)</span>
<span class="sd">            zsnow = initial snowline depth (m)</span>
<span class="sd">            zsat0 = characteristic depth (m)</span>
<span class="sd">            Ksp0 = solubility product of calcite at air-water interface (mol^2/kg^2)</span>
<span class="sd">            kc = heterogeneous rate constant/mass transfer coefficient for calcite dissolution (kg m^-2 yr^-1)</span>
<span class="sd">            Ca2 = calcium ion concentration (mol/kg)</span>
<span class="sd">            pc = characteristic pressure (atm)</span>
<span class="sd">            pg = seawater density multiplied by gravity due to acceleration (atm/m)</span>
<span class="sd">            I = dissolvable CaCO3 inventory</span>
<span class="sd">            co3 = CO3 concentration (mol/kg)</span>
<span class="sd">            Ksp = solubility product of calcite at in situ sea water conditions (mol^2/kg^2)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ExternalCode</span><span class="p">,</span>
        <span class="n">calc_carbonates_2</span><span class="p">,</span>
        <span class="n">carbonate_system_2_ode</span><span class="p">,</span>
        <span class="n">Reservoir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># list of known keywords</span>
    <span class="n">lkk</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;r_db&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># list of deep reservoirs</span>
        <span class="s2">&quot;r_sb&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>  <span class="c1"># list of corresponding surface reservoirs</span>
        <span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="s2">&quot;AD&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsat_min&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;zsat0&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="s2">&quot;Ksp0&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;kc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;Ca2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;I_caco3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="s2">&quot;zmax&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;z0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;Ksp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c1"># provide a list of absolutely required keywords</span>
    <span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">,</span> <span class="s2">&quot;r_sb&quot;</span><span class="p">,</span> <span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">,</span> <span class="s2">&quot;zsat_min&quot;</span><span class="p">,</span> <span class="s2">&quot;z0&quot;</span><span class="p">]</span>

    <span class="c1"># we need the reference to the Model in order to set some</span>
    <span class="c1"># default values.</span>

    <span class="n">reservoir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>
    <span class="c1"># list of default values if none provided</span>
    <span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;r_sb&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># empty list</span>
        <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3715</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4750</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5000</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;zsat0&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5078</span><span class="p">,</span>  <span class="c1"># m</span>
        <span class="s2">&quot;Ksp0&quot;</span><span class="p">:</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># mol^2/kg^2</span>
        <span class="s2">&quot;kc&quot;</span><span class="p">:</span> <span class="mf">8.84</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># m/yr converted to kg/(m^2 yr)</span>
        <span class="s2">&quot;AD&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">area_dz</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mi">6000</span><span class="p">),</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># 0.928771302395292, #0.75,</span>
        <span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="mf">0.103</span><span class="p">,</span>  <span class="c1"># pressure in atm/m</span>
        <span class="s2">&quot;pc&quot;</span><span class="p">:</span> <span class="mi">511</span><span class="p">,</span>  <span class="c1"># characteristic pressure after Boudreau 2010</span>
        <span class="s2">&quot;I_caco3&quot;</span><span class="p">:</span> <span class="mi">529</span><span class="p">,</span>  <span class="c1"># dissolveable CaCO3 in mol/m^2</span>
        <span class="s2">&quot;zmax&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">6000</span><span class="p">,</span>  <span class="c1"># max model depth</span>
        <span class="s2">&quot;Ksp&quot;</span><span class="p">:</span> <span class="n">reservoir</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># mol^2/kg^2</span>
    <span class="p">}</span>

    <span class="c1"># make sure all mandatory keywords are present</span>
    <span class="n">__checkkeys__</span><span class="p">(</span><span class="n">lrk</span><span class="p">,</span> <span class="n">lkk</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># add default values for keys which were not specified</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">__addmissingdefaults__</span><span class="p">(</span><span class="n">lod</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># test that all keyword values are of the correct type</span>
    <span class="n">__checktypes__</span><span class="p">(</span><span class="n">lkk</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># establish some shared parameters</span>
    <span class="c1"># depths_table = np.arange(0, 6001, 1)</span>
    <span class="n">depths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6002</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">r_db</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_db&quot;</span><span class="p">]</span>
    <span class="n">r_sb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;r_sb&quot;</span><span class="p">]</span>
    <span class="n">Ksp0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Ksp0&quot;</span><span class="p">]</span>
    <span class="n">ca2</span> <span class="o">=</span> <span class="n">r_db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pc&quot;</span><span class="p">]</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span>
    <span class="n">Ksp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Ksp&quot;</span><span class="p">]</span>

    <span class="c1"># test if corresponding surface reservoirs have been defined</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please update your call to add_carbonate_system_2and add the list of of corresponding surface reservoirs&#39;</span><span class="p">)</span>


    <span class="c1"># C saturation(z) after Boudreau 2010</span>
    <span class="n">Csat_table</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ksp0</span> <span class="o">/</span> <span class="n">ca2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">depths</span> <span class="o">*</span> <span class="n">pg</span><span class="p">)</span> <span class="o">/</span> <span class="n">pc</span><span class="p">)</span>
    <span class="n">area_table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">get_lookup_table</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6002</span><span class="p">)</span>  <span class="c1"># area in m^2(z)</span>
    <span class="n">area_dz_table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">get_lookup_table_area_dz</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6002</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># area&#39;</span>
    <span class="n">AD</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyp</span><span class="o">.</span><span class="n">area_dz</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6000</span><span class="p">)</span>  <span class="c1"># Total Ocean Area</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r_db</span><span class="p">):</span>  <span class="c1"># Setup the virtual reservoirs</span>
        <span class="k">if</span> <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">Carbon</span><span class="o">.</span><span class="n">CO2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">__builtins__</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">r_db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">use_ode</span><span class="p">:</span>
            <span class="n">ec</span> <span class="o">=</span> <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs2&quot;</span><span class="p">,</span>
                <span class="n">r_s</span><span class="o">=</span><span class="n">r_sb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># source (RG) of CaCO3 flux,</span>
                <span class="n">r_d</span><span class="o">=</span><span class="n">r_db</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># sink (RG) of CaCO3 flux,</span>
                <span class="c1"># datafield hold the results of the VR_no_set function</span>
                <span class="c1"># provide a default values which will be use to initialize</span>
                <span class="c1"># the respective datafield/</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0 H+</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1 carbonate alkalinity</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2 HCO3</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3 CO3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4 CO2aq</span>
                    <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat&quot;</span><span class="p">]),</span>  <span class="c1"># 5 zsat</span>
                    <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zcc&quot;</span><span class="p">]),</span>  <span class="c1"># 6 zcc</span>
                    <span class="c1"># &quot;zsnow&quot;: abs(kwargs[&quot;zsnow&quot;]),  # 7 zsnow</span>
                    <span class="s2">&quot;depth_area_table&quot;</span><span class="p">:</span> <span class="n">area_table</span><span class="p">,</span>
                    <span class="s2">&quot;area_dz_table&quot;</span><span class="p">:</span> <span class="n">area_dz_table</span><span class="p">,</span>
                    <span class="s2">&quot;Csat_table&quot;</span><span class="p">:</span> <span class="n">Csat_table</span><span class="p">,</span>
                    <span class="s2">&quot;Fburial&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;Fburial_l&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">ref_flux</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">],</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kc&quot;</span><span class="p">]),</span>  <span class="c1"># 6</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;liter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">),</span>  <span class="c1"># 7</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">AD</span><span class="p">),</span>  <span class="c1"># 8</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat0&quot;</span><span class="p">])),</span>  <span class="c1"># 9</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">),</span>  <span class="c1"># 10</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>  <span class="c1"># 11</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;I_caco3&quot;</span><span class="p">]),</span>  <span class="c1"># 12</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>  <span class="c1"># 13</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat_min&quot;</span><span class="p">])),</span>  <span class="c1"># 14</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">])),</span>  <span class="c1"># 15</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])),</span>  <span class="c1"># 16</span>
                        <span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 17</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 18</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>  <span class="c1"># 19</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">return_values</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Hplus&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                    <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>
                <span class="p">},</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ec</span><span class="o">.</span><span class="n">return_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                    <span class="n">concentration</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> mol/kg&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
                    <span class="n">volume</span><span class="o">=</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                    <span class="n">rtype</span><span class="o">=</span><span class="s2">&quot;computed&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_2</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;cs2&quot;</span><span class="p">,</span>
                <span class="c1"># datafield hold the results of the VR_no_set function</span>
                <span class="c1"># provide a default values which will be use to initialize</span>
                <span class="c1"># the respective datafield/</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 0 H+</span>
                    <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>  <span class="c1"># 1 carbonate alkalinity</span>
                    <span class="s2">&quot;HCO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>  <span class="c1"># 2 HCO3</span>
                    <span class="s2">&quot;CO3&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>  <span class="c1"># 3 CO3</span>
                    <span class="s2">&quot;CO2aq&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>  <span class="c1"># 4 CO2aq</span>
                    <span class="s2">&quot;zsat&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat&quot;</span><span class="p">],</span>  <span class="c1"># 5 zsat</span>
                    <span class="s2">&quot;zcc&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zcc&quot;</span><span class="p">],</span>  <span class="c1"># 6 zcc</span>
                    <span class="s2">&quot;zsnow&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">],</span>  <span class="c1"># 7 zsnow</span>
                    <span class="s2">&quot;Fburial&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 8 carbonate burial</span>
                    <span class="s2">&quot;Fburial_l&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 9 carbonate burial 12C</span>
                    <span class="s2">&quot;diss&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># dissolution flux</span>
                    <span class="s2">&quot;Bm&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0 DIC mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1 DIC light isotope mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 2 DIC concentration db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 3 TA mass db</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 4 TA concentration db</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;carbonate_export_fluxes&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="n">area_table</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="n">area_dz_table</span><span class="p">,</span>  <span class="c1"># 7</span>
                        <span class="n">Csat_table</span><span class="p">,</span>  <span class="c1"># 8</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 9 reservoir volume</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;kc&quot;</span><span class="p">]),</span>  <span class="c1"># 6</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;liter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">),</span>  <span class="c1"># 7</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">AD</span><span class="p">),</span>  <span class="c1"># 8</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat0&quot;</span><span class="p">])),</span>  <span class="c1"># 9</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">),</span>  <span class="c1"># 10</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>  <span class="c1"># 11</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;I_caco3&quot;</span><span class="p">]),</span>  <span class="c1"># 12</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span>  <span class="c1"># 13</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsat_min&quot;</span><span class="p">])),</span>  <span class="c1"># 14</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">])),</span>  <span class="c1"># 15</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])),</span>  <span class="c1"># 16</span>
                        <span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 17</span>
                        <span class="n">rg</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zsnow&quot;</span><span class="p">])),</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">register</span><span class="o">=</span><span class="n">rg</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">rg</span><span class="o">.</span><span class="n">has_cs2</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

        </details>

            <div class="docstring"><p>Creates a new carbonate system virtual reservoir
which will compute carbon species, saturation, compensation,
and snowline depth, and compute the associated carbonate burial fluxes</p>

<p>Required keywords:
    r_sb: list of ReservoirGroup objects in the surface layer
    r_db: list of ReservoirGroup objects in the deep layer
    carbonate_export_fluxes: list of flux objects which must match the
                             list of ReservoirGroup objects.
    zsat_min = depth of the upper boundary of the deep box
    z0 = upper depth limit for carbonate burial calculations
         typically zsat_min</p>

<p>Optional Parameters:</p>

<pre><code>zsat = initial saturation depth (m)
zcc = initial carbon compensation depth (m)
zsnow = initial snowline depth (m)
zsat0 = characteristic depth (m)
Ksp0 = solubility product of calcite at air-water interface (mol^2/kg^2)
kc = heterogeneous rate constant/mass transfer coefficient for calcite dissolution (kg m^-2 yr^-1)
Ca2 = calcium ion concentration (mol/kg)
pc = characteristic pressure (atm)
pg = seawater density multiplied by gravity due to acceleration (atm/m)
I = dissolvable CaCO3 inventory
co3 = CO3 concentration (mol/kg)
Ksp = solubility product of calcite at in situ sea water conditions (mol^2/kg^2)
</code></pre>
</div>


                </section>
                <section id="weathering_processes">
                            <div class="attr function"><a class="headerlink" href="#weathering_processes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">weathering_processes</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">weathering_processes</span><span class="p">():</span>

    <span class="k">pass</span>
</pre></div>

        </details>

    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>